<!DOCTYPE html>
<html lang="en">
    <head>

        <script>
            if(!/blog\.csmac\.nz/.test(window.location.host)) {
                window.location = "https:\/\/blog.csmac.nz\/post\/the-service-locator-base-class-antipattern\/";
            }
        </script>

        <meta charset="utf-8" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta name='author' content='Mark Clearwater, csmacnz@csmac.co.nz'>
        <meta name='language' content='EN'>
        <meta name='medium' content='blog'>
        <meta name="google-adsense-account" content="ca-pub-4517187877737982">

    
        <title>The Service Locator base class anti-pattern - csMACnz&#39;s Blog</title>
        <meta name="description" content="Something I have seen a lot of over the last few years is a lot of service location, particularly in base classes, particularly in Controllers. But not limited to there, it can happen anywhere we see base classes. Short …">
        <meta name='keywords' content='csMACnz, Tips and Tricks, Patterns'>

        
        <meta property="og:type" content="article"/>
        <meta property="og:title" content="The Service Locator base class anti-pattern"/>
        <meta property="og:description" content="Something I have seen a lot of over the last few years is a lot of service location, particularly in base classes, particularly in Controllers. But not limited to there, it can happen anywhere we see base classes. Short …"/>
        <meta property="og:site_name" content="csMACnz&#39;s Blog"/>
        <meta property="og:url" content="https://blog.csmac.nz/post/the-service-locator-base-class-antipattern/"/>
        <meta property="og:image" content="https://csmac.nz/Content/icon/icon.png"/>

        
        <meta name="twitter:card" content="summary"/>
        <meta name="twitter:title" content="The Service Locator base class anti-pattern"/>
        <meta name="twitter:description" content="Something I have seen a lot of over the last few years is a lot of service location, particularly in base classes, particularly in Controllers. But not limited to there, it can happen anywhere we see base classes. Short …"/>
        <meta name="twitter:image" content="https://csmac.nz/Content/icon/icon.png"/>
        <meta name="twitter:site" content="@csMACnz"/>
        <meta name="twitter:creator" content="@csMACnz"/>
    

        <link rel="apple-touch-icon-precomposed" href="/images/icon/apple-touch-icon-precomposed.png">
        <link rel="apple-touch-icon-precomposed" sizes="72x72" href="/images/icon/apple-touch-icon-72x72-precomposed.png">
        <link rel="apple-touch-icon-precomposed" sizes="114x114" href="/images/icon/apple-touch-icon-114x114-precomposed.png">
        <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/images/icon/apple-touch-icon-144x144-precomposed.png">
        <link rel="icon" type="image/png" href="/images/icon/icon.png" />
        <link rel='me' type='text/html' href='https://github.com/csMACnz'>

        <script>
            var d_id  = 'csmacnz';
        </script>

        <link rel="stylesheet" type="text/css" href="/css/style.css" />
        <link rel="stylesheet" type="text/css" href="/css/blogstyle.css" />

        <link rel="alternate stylesheet" title="dark-code" type="text/css" href="/css/solarized_dark.css" disabled>
        <link rel="stylesheet" title="light-code" type="text/css" href="/css/github-gist.css" disabled>

        <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4517187877737982"
        crossorigin="anonymous"></script>

        
        
        <script type="application/ld+json">
        {
            "@context" : "https://schema.org",
            "@type" : "Article",
            "publisher": {
                "@type": "Organization",
                "name": "csMACnz&#x27;s Blog",
                "logo": "https:\/\/blog.csmac.nz\/images\/icon\/apple-touch-icon-144x144-precomposed.png"
            },
            "author": {
                "@type": "Person",
                "name": "Mark Clearwater",
                "image": {
                    "@type": "ImageObject",
                    "url": "//www.gravatar.com/avatar/c97410951ec3738a3fd4a2dfb17a5d9c?d=404&s=250",
                    "width": 440,
                    "height": 295
                },
                "url": "https:\/\/blog.csmac.nz",
                "sameAs": [
                    "https://csmac.nz"
                ]
            },
            "articleSection" : "post",
            "name" : "The Service Locator base class anti-pattern",
            "headline" : "The Service Locator base class anti-pattern",
            "url" : "https:\/\/blog.csmac.nz\/post\/the-service-locator-base-class-antipattern\/",
            "datePublished": "2015-07-05T18:04:40.000Z",
            "dateModified" : "2015-07-05T18:04:40.000Z",
            "keywords" : [ "Tips and Tricks", "Patterns" ]
            "description" : "Something I have seen a lot of over the last few years is a lot of service location, particularly in base classes, particularly in Controllers. But not limited to there, it can happen anywhere we see base classes.\nShort rant about inheritance The longer I do this, the more I find that base classes are not meant to be overused. I find that if we are pumping base classes full of code, we should probably be breaking them out into smaller classes, and including them in the derived versions that actually use that functionality.",
            "mainEntityOfPage": {
                "@type": "WebPage",
                "@id": "https:\/\/blog.csmac.nz"
            }
            "inLanguage" : "en-US",
            "author" : "Mark Clearwater",
            "creator" : "Mark Clearwater",
            "accountablePerson" : "Mark Clearwater",
            "copyrightHolder" : "Mark Clearwater",
            "copyrightYear" : "2015",
            "wordCount" : "2192",
        }
        </script>
        
        
        
    </head>
    <body class="blog">
        <div class="page-area">

            <header class="header-area">
                <h1 class="header-area-title">csMACnz</h1>
            </header>
            <nav class="navigation-area header-bar-parent">
                <div class="header-bar header-bar-blog">
                    <ul class="menu">
                        <li class="menu-item"><a class="menu-item-content" href="https://csmac.nz">Home</a></li>
                        <li class="menu-item"><a class="menu-item-content" href="https://csmac.nz/baconvaders">Bacon Vaders</a></li>
                        <li class="menu-item"><a class="menu-item-content CurrentButton" href="https://blog.csmac.nz">Blog</a></li>
                        <li class="menu-item"><a class="menu-item-content" href="https://csmac.nz/metablog">Meta</a></li>
                    </ul>
                </div>
            </nav>

            <div id="content" class="content-area">

<!--Page Content Begins-->

<article>
    <div class="content-box" itemscope itemtype=" https://schema.org/Article"><span class="post-meta"><time datetime="2015-07-05"  itemprop="datePublished">05 Jul 15</time> in <a href="/categories/software-engineering">Software Engineering</a> on <a href="/tags/tips-and-tricks">Tips and Tricks</a>,  <a href="/tags/patterns">Patterns</a></span>
<h1 class="post-title" itemprop="headline">The Service Locator base class anti-pattern</h1>
    
        <section class="post-content"  itemprop="articleBody">
            <p>Something I have seen a lot of over the last few years is a lot of service location, particularly in base classes, particularly in Controllers. But not limited to there, it can happen anywhere we see base classes.</p>
<h2 id="short-rant-about-inheritance">Short rant about inheritance</h2>
<p>The longer I do this, the more I find that base classes are not meant to be overused. I find that if we are pumping base classes full of code, we should probably be breaking them out into smaller classes, and including them in the derived versions that actually use that functionality. If it is a cross-cutting concern, probably using attributes would be a cleaner solution.  Composition over Inheritance makes testing much simpler IMHO.</p>
<h2 id="short-rant-about-service-location">Short rant about service location</h2>
<p>Containers have no place in Unit Tests. Let me clarify. The application&rsquo;s IOC container has no place in the unit tests. (AutoFixture can be a helpful tool, but is also a smell). The fact that you use a service locator couples your code to <em>that</em> service locator, and now it is required in your tests to get things to run. Using a service locator hides from you, the consumer of that object, the dependencies that your object requires. If these are hidden in a base class or extension method, you have no way to discover that the dependency is there until your tests (or worst case, your application) comes crashing down around you.</p>
<p><strong>&lt;<em>/Rant</em>&gt;</strong></p>
<h2 id="the-antipattern">The antipattern</h2>
<p>So the antipattern goes like this: We have N classes, with N types of functionality. They derive from a base class, which contains many services that are used across all N derived classes. These services are <strong>Service Located</strong>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cs" data-lang="cs"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">BaseController</span> : Controller
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> ICustomerService CustomerService
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">get</span>
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> Service.Locate&lt;ICustomerService&gt;();
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> IOrderService OrderService
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">get</span>
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> Service.Locate&lt;IOrderService&gt;();
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">OrderController</span> : BaseController 
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> Order Get(<span style="color:#66d9ef">int</span> orderId)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> OrderService.GetOrderById(orderId);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">CustomerController</span> : BaseController 
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> Customer Get(<span style="color:#66d9ef">int</span> customerId)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> CustomerService.GetOrderById(orderId);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>This is a representative sample of services and controllers. You can imagine that the real number of services in the base class could be anywhere between 5 and 20 services, or more, and that there could be 5 to 20, or more, controllers as well.</p>
<p>Also, I have intentionally used Service.Locate because there are many ways to do this approach. You could use some generic <em>Global Static Method</em> or some container specific <em>Global Static variable</em>. It doesn&rsquo;t matter which, both are just as bad as each other.</p>
<p>So Why is this so bad? Well, when It comes to testing, your Controller now has hidden dependencies. We can no longer tell from the constructor what it requires to be provided to get work done.  But they aren&rsquo;t required right, it is able to resolve them itself?  No, not really.</p>
<p>There is a dependency on the Service Locator class <code>Service</code> that has to be configured just right for the actual dependencies to show up. And what&rsquo;s worse than hidden dependencies? Singleton dependencies that break your ability to run your tests in parallel.  If you try and run two tests against two controller instances (or any other type that shares the singleton dependency) then your test may periodically fail, from a race condition with the other test. It is never fun to have false negatives in your test suite, you lose all trust and won&rsquo;t see a true negative as a real problem.</p>
<h3 id="incorrect-solution-1">(Incorrect) Solution 1</h3>
<p>Ok, so we see the problems, how should we solve them? Let&rsquo;s try fixing the singleton problem with dependency injection through the constructor:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cs" data-lang="cs"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">BaseController</span> : Controller
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> ICustomerService _customerService;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> ICustomerService CustomerService
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">get</span>
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> _customerService;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> IOrderService _orderService;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> IOrderService OrderService
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">get</span>
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> _orderService;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">protected</span> BaseController(
</span></span><span style="display:flex;"><span>        ICustomerService customerService,
</span></span><span style="display:flex;"><span>        IOrderService orderService)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        _customerService = customerService;
</span></span><span style="display:flex;"><span>        _orderService = orderService;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">OrderController</span> : BaseController 
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> OrderController(
</span></span><span style="display:flex;"><span>        ICustomerService customerService,
</span></span><span style="display:flex;"><span>        IOrderService orderService)
</span></span><span style="display:flex;"><span>        : <span style="color:#66d9ef">base</span>(customerService, orderService)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> Order Get(<span style="color:#66d9ef">int</span> orderId)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> OrderService.GetOrderById(orderId);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">CustomerController</span> : BaseController 
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> CustomerController(
</span></span><span style="display:flex;"><span>        ICustomerService customerService,
</span></span><span style="display:flex;"><span>        IOrderService orderService)
</span></span><span style="display:flex;"><span>        : <span style="color:#66d9ef">base</span>(customerService, orderService)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> Customer Get(<span style="color:#66d9ef">int</span> customerId)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> CustomerService.GetOrderById(orderId);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>By my rough estimate, we doubled the code, but we did expose our dependencies through the constructor right? Again, not really.</p>
<p>If we take a closer look, we have a dependency on the BaseController for the <code>IOrderService</code>, but we never actually use it on the derived CustomerController. With more and more services loaded up on the base class, the worse this gets. The more likely we are that more of the dependencies the base class requires are not used by any particular controller.</p>
<p>If you are using a DI Container, you won&rsquo;t feel the pain of creating one of these either, but the pain is still there. This is one of my Pet Peeves with Containers, they hide a lot of the pain from bad usages that only get worse over time, instead of annoying you enough to fix the problem fast.</p>
<p>And what if we need to add a new dependency?  Well, if we add it to the base class, we have to add it to all (5, or maybe 20) Controllers&rsquo; constructors so that it will compile.  You might not see this as an issue, you just add it to the one that uses the dependency right? Not so. The base class has become a gravity well, all services go there, whether needed by all, or not. It&rsquo;s only logical that the next person along will put their new service there as well.  If there is code in the base class, it may be the only place to add it to surface the functionality to that code.</p>
<p>This brings me to the next reason base class dependencies are bad.  Not every derived class will use it. So why do they all have it available at all, in the first instance, and have a dependency in their constructor for it in the second instance, if it is not actually a dependency?</p>
<p>This leads into a huge con for this approach over the previous one: <a href="http://stackoverflow.com/questions/1299374/what-is-eager-loading">Over-eager loading</a>.  At least with the service locator, the instance and all of its dependencies are only loaded when you ask for the service.  With this approach, all dependencies are loaded before they are injected in, which could add a large amount of overhead to creating your controller. And like we said, not every instance is actually even used in this controller at all!  No, don&rsquo;t do this approach if you can help it. (by that I usually mean as a stop-gap solution to a larger refactoring effort. See <a href="#reality">Reality</a>.)</p>
<h3 id="the-way-things-should-have-been">The way things should have been</h3>
<p>Let&rsquo;s try to implement this solution again, with all of this in mind.  We want our classes to only take dependencies on what they actually use:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cs" data-lang="cs"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">OrderController</span> : Controller 
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> IOrderService _orderService;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> OrderController(IOrderService orderService)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        _orderService = orderService;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> Order Get(<span style="color:#66d9ef">int</span> orderId)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> _orderService.GetOrderById(orderId);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">CustomerController</span> : Controller 
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> ICustomerService _customerService;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> CustomerController(ICustomerService customerService)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>         _customerService = customerService;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> Customer Get(<span style="color:#66d9ef">int</span> customerId)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> _customerService.GetOrderById(orderId);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>We can&rsquo;t get away from inheritance completely because of MVC, but we now have one less class to worry about. And in this trivial example, we have the same amount of code. Of course, that bit doesn&rsquo;t necessarily scale, but that&rsquo;s not a problem, really. Have we fixed all our problems? I think so.</p>
<p>Our controller now takes only the dependencies it needs. We don&rsquo;t need to pass so many things to any particular controller, and It is clear what it actually depends on.  In reality, we might have had to pass the same services to multiple controllers, but that&rsquo;s what composition is all about.</p>
<p>We no longer have hidden dependencies. Everything a controller needs is passed in. Much easier for testing. You can even run your tests concurrently without the shared static singleton service locator.</p>
<p>Now since we got rid of the base class, what about any cross-cutting concerns or common code?  Well, it should now become clear that some of that code might need to be a dependency passed into the subset of all controllers that actually use it.  And it that code still needs context-specific knowledge that you can&rsquo;t or don&rsquo;t want to pass in? I suggest looking into Aspect Oriented approaches such as the <a href="https://msdn.microsoft.com/en-us/library/system.web.mvc.filterattribute(v=vs.118).aspx">MVC FilterAttribute</a>.</p>
<p>But we still have far too many dependencies per controller with this approach right? Well, that depends. I&rsquo;ll hopefully cover this off from the next two sections, but at a high level, you may have mixed concerns in your controller if it still requires many different services. Or perhaps you need to encapsulate some of your business logic out into a new service instead of having it in amongst your MVC logic.  The other option, which is hard to achieve in the existing MVC framework but worth mentioning, is the idea of service injection into methods, as discussed under <a href="#advancedtopics">advanced topics</a>.</p>
<h2 id="reality">Reality</h2>
<p>In reality, this type of code is probably already in your legacy applications, and It isn&rsquo;t simple to unravel them. It could take several attempts to transform your code to resemble this type of approach.</p>
<p>If you do want to tackle this type of refactoring, you would first want to pick one controller, and transform that one first.  This will require code duplication to move your dependencies in, but you should find that not all of them need to be copied over.</p>
<p>As you refactor out code into attributes and new service classes, think about adding usages from your base class and other controllers at the same time, if the change is small enough to do so.</p>
<p>Another real-world solution to the Service Location problem, especially for testing is to pass these dependencies in a second constructor and use <em>service location</em> from the default constructor instead.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cs" data-lang="cs"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">BaseController</span> : Controller
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">protected</span> BaseController()
</span></span><span style="display:flex;"><span>    : <span style="color:#66d9ef">this</span>(Service.Locate&lt;ICustomerService&gt;(),Service.Locate&lt;IOrderService&gt;())
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">protected</span> BaseController(
</span></span><span style="display:flex;"><span>        ICustomerService customerService,
</span></span><span style="display:flex;"><span>        IOrderService orderService)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        _customerService = customerService;
</span></span><span style="display:flex;"><span>        _orderService = orderService;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">OrderController</span> : BaseController 
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> OrderController(
</span></span><span style="display:flex;"><span>        ICustomerService customerService,
</span></span><span style="display:flex;"><span>        IOrderService orderService)
</span></span><span style="display:flex;"><span>        : <span style="color:#66d9ef">base</span>(customerService, orderService)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> OrderController() : <span style="color:#66d9ef">base</span>()
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>This approach allows you to fix your concurrent testing issues, even if you can&rsquo;t fix all of your problems straight away.</p>
<p>If you can&rsquo;t get rid of the base class at all, look for candidates that are only used in some places, and pull these down, so at least new dependencies added will see this approach, and you have a new gravity well approach for others to follow.</p>
<h2 id="advanced-topics">Advanced Topics</h2>
<p>I said I would mention is service injection into methods.  This is something that containers won&rsquo;t do for you, but there are approaches available in other frameworks and libraries that could allow you to follow a similar pattern. Worst-case an <a href="https://en.wikipedia.org/wiki/Adapter_pattern">Adapter</a> could be used to achieve this as another layer in your MVC, or use Lazy objects to at least simulate the run-time benefits this creates.</p>
<p>The implementation of the method looks as follows:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cs" data-lang="cs"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">CustomerController</span> : Controller 
</span></span><span style="display:flex;"><span>{   
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> Customer Get(<span style="color:#66d9ef">int</span> customerId, ICustomerService customerService)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> CustomerService.GetOrderById(orderId);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>As well as our parameters, we pass the services along here as well. This way, our controller method only requires the services it really uses, not all the services for all methods in this controller. As I said, you <em>should</em> only have services that most of your actions need anyway, of you have a solid single responsibility in this controller.</p>
<p>The way to simulate some of these benefits, as mentioned before, would look something like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cs" data-lang="cs"><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">CustomerController</span> : Controller 
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> Lazy&lt;ICustomerService&gt; _customerService;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> CustomerController(Lazy&lt;ICustomerService&gt; customerService)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>         _customerService = customerService;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> Customer Get(<span style="color:#66d9ef">int</span> customerId)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> _customerService.Value.GetOrderById(orderId);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Given we have a container, we now we only actually create a service and all of its dependencies in the method where we actually use it, and not anywhere else.  Slight gain, but if you are trying to tidy up your controllers, this little trick could come in useful.</p>
<h3 id="parting-words">Parting words</h3>
<p>If you&rsquo;ve made it this far, thanks for sticking with me, I know it has been a long one.  What might render this discussion moot, or highly important is this small piece of advice:</p>
<blockquote>
<p>Separate your rendering/routing/MVC style concerns from your implementation details.</p>
</blockquote>
<p>Try to keep your controllers void of logic and stick with transforming user data to a payload, passing the payload to a service, and rendering the results from the service. Authorisation and validation might fit better here as well, but not your actual business logic.  This will serve you well for simplifying testing, and less fighting with the framework to make it handle injection, dependencies, inheritance and HTTP concerns within your business rules.</p>
<p>There are no silver bullets, but if your system is complex, this approach does make testing easier, overall.</p>
<p>I would like to code up a bigger solution showing all three approaches to stick up on GitHub. We will see if time permits later in the month.</p>
<h2 id="update">Update</h2>
<p>The mentioned GitHub solution is now available: <a href="https://github.com/csMacnzBlog/BaseClassAntiPattern">https://github.com/csMacnzBlog/BaseClassAntiPattern</a></p>
</section>
        
        <section class="share">
            Share: 
            <a class="icon-twitter" href="https://twitter.com/share?text=The%20Service%20Locator%20base%20class%20anti-pattern&url=https%3a%2f%2fblog.csmac.nz%2fpost%2fthe-service-locator-base-class-antipattern%2f"
                onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
                <span>Twitter</span>
            </a>
            |
            <a class="icon-facebook" href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fblog.csmac.nz%2fpost%2fthe-service-locator-base-class-antipattern%2f"
                onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
                <span>Facebook</span>
            </a>
        </section>
    </div>
    <div class="content-box">
        
        <div id="disqus_thread"></div>
        <script type="text/javascript">
            var disqus_shortname = d_id; 
            var disqus_title = 'The Service Locator base class anti-pattern';
            
             
            (function() {
                var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
        <a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    
    </div>
</article>

<!--Page Content Ends-->

            </div><aside class="sidebar-area">

<!--Sidebar Content Begins-->

                <div class="header-bar-parent sidebar-item">
                    <div class="header-bar header-bar-mastodon">Mastodon</div>
                    
                    
                    <iframe allowfullscreen sandbox="allow-top-navigation allow-scripts" width="280" height="400" src="https://maplefeed.bihlink.com/apiv2/feed?userurl=https%3A%2F%2Fmastodon.nz%2F%2Fusers%2Fcsmacnz&theme=modern-light&size=80&header=true&replies=false&boosts=false"></iframe>
                    
                </div>


                <div class="header-bar-parent sidebar-item">
                    <div class="header-bar header-bar-rss">Subscribe</div>
                    
                    <a href="/rssfeeds/" title="csMACnz's Blog">RSS Feeds</a>
                    <a href="https://feedly.com/i/subscription/feed%2Fhttps%3A%2F%2Ffeeds.feedburner.com%2FcsmacnzBlog" target="_blank" title="csMACnz&amp;#039;s Blog"><img src="https://s3.feedly.com/feedburner/feedly.png" alt="" style="border:0"/></a>
                    <br />
                    <a href="https://www.patreon.com/csMACnz" target="_blank"><img src="/images/patreon.png" /></a>
                    
                    
                </div>


                <div class="header-bar-parent sidebar-item">
                    <div class="header-bar header-bar-xbox">Gamercard</div>
                    

                    <div>
                        <a href="https://www.exophase.com/xbox/user/csMACnz/"><img width="288px" src="https://card.exophase.com/1/1476805.png"></a>
                        <a href="http://steamcommunity.com/id/csMACnz/" target="_blank"><img src="https://www.steamsignature.com/status/english/76561197994712512.png" alt="" title="csMACnz's Steam Profile" /></a>
                    </div>
                    
                </div>


                <div class="header-bar-parent sidebar-item">
                    <div class="header-bar header-bar-ads">Advertisement</div>
                    
                    <div>
                        
                        <ins class="adsbygoogle"
                            style="display:block"
                            data-ad-client="ca-pub-4517187877737982"
                            data-ad-slot="3618449993"
                            data-ad-format="auto"
                            data-full-width-responsive="true"></ins>
                        <script>
                            (adsbygoogle = window.adsbygoogle || []).push({});
                        </script>
                    </div>
                    
                </div>

<!--Sidebar Content Ends-->

            </aside>

            <footer class="footer-area">

            <p>
                Designed and Maintained by Mark Clearwater; Last updated November 2023.
                <!-- This used to be something useful, now it is just a hack I left it to make layout easier but also as a fun reminder for me of what it used to be -->
                <br /><a class="footer-link" >¯\_(ツ)_/¯</a>
            </p>

            </footer>
        </div>

<!--body scripts Begins-->

        
        <script src="/js/highlight.pack.js"></script>
        <script>hljs.initHighlightingOnLoad();</script>

        <script src="/js/codetoggle.js"></script> 

        
        <script src="/js/htmx.min.js"></script>

        
        <script async src="https://www.googletagmanager.com/gtag/js?id=G-08VK9VD3ET"></script>
        <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-08VK9VD3ET');
        </script>

        <script type="text/javascript" src="https://code.jquery.com/jquery-1.11.3.min.js"></script>

<!--body scripts Ends-->


<!-------------------------------->
<!--                            -->
<!--  _(\    |@@|               -->
<!-- (__/\__ \--/ __            -->
<!--    \___|----|  |   __      -->
<!--        \ }{ /\ )_ / _\     -->
<!--        /\__/\ \__O (__     -->
<!--       (--/\--)    \__/     -->
<!--       _)(  )(_             -->
<!--      `---''---`            -->
<!--                            -->
<!-- https://github.com/csMACnz -->
<!-------------------------------->

    </body>
</html>
