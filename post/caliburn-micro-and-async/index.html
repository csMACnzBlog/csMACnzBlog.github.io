<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Caliburn.Micro and Async - csMacnz&#39;s Blog</title><link rel="apple-touch-icon" href="https://csmacnzblog.github.io/images/favicons/apple-touch-icon.png" sizes="180x180">
<link rel="icon" href="https://csmacnzblog.github.io/images/favicons/favicon-32x32.png" sizes="32x32" type="image/png">
<link rel="icon" href="https://csmacnzblog.github.io/images/favicons/favicon-16x16.png" sizes="16x16" type="image/png">
<link rel="manifest" href="https://csmacnzblog.github.io/images/favicons/manifest.json">
<link rel="icon" href="https://csmacnzblog.github.io/images/favicons/favicon.ico">
<meta name="keywords" content="" />
<meta name="description" content="" /><meta itemprop="name" content="Caliburn.Micro and Async">
<meta itemprop="description" content="When it comes to asynchronous processing for client side applications, async and await are an amazing way to code. You no longer have to worry about thread affinity and UIThread delegation. It just works. But it is also real easy to get it wrong when an exception is thrown, as I found out the hard way.
The symptom is simple. A button click does nothing. Or worse, a button triggers a busy waiting, that waits forever."><meta itemprop="datePublished" content="2015-05-21T15:58:53+00:00" />
<meta itemprop="dateModified" content="2015-05-21T15:58:53+00:00" />
<meta itemprop="wordCount" content="1086">
<meta itemprop="keywords" content="" /><meta property="og:title" content="Caliburn.Micro and Async" />
<meta property="og:description" content="When it comes to asynchronous processing for client side applications, async and await are an amazing way to code. You no longer have to worry about thread affinity and UIThread delegation. It just works. But it is also real easy to get it wrong when an exception is thrown, as I found out the hard way.
The symptom is simple. A button click does nothing. Or worse, a button triggers a busy waiting, that waits forever." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://csmacnzblog.github.io/post/caliburn-micro-and-async/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2015-05-21T15:58:53+00:00" />
<meta property="article:modified_time" content="2015-05-21T15:58:53+00:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Caliburn.Micro and Async"/>
<meta name="twitter:description" content="When it comes to asynchronous processing for client side applications, async and await are an amazing way to code. You no longer have to worry about thread affinity and UIThread delegation. It just works. But it is also real easy to get it wrong when an exception is thrown, as I found out the hard way.
The symptom is simple. A button click does nothing. Or worse, a button triggers a busy waiting, that waits forever."/>
<link rel=stylesheet href="https://csmacnzblog.github.io/css/bundle.min.ce383e7297312216c2d2ced30574d5a9ae83c451db9f064a454509955ae2462d.css" integrity="sha256-zjg&#43;cpcxIhbC0s7TBXTVqa6DxFHbnwZKRUUJlVriRi0=" crossorigin="anonymous"><script src="https://csmacnzblog.github.io/js/bundle.min.ad6d83537f5b4374c837a12a76422496582e04d1dde91bbb443641ec12c506c6.js" integrity="sha256-rW2DU39bQ3TIN6EqdkIkllguBNHd6Ru7RDZB7BLFBsY=" crossorigin="anonymous"></script>
</head><body><header><nav class="navbar navbar-expand-xl fixed-top">
  <div class="container">
    <a class="navbar-brand" href="https://csmacnzblog.github.io">
      <img class="logo" alt="Logo" src="https://csmacnzblog.github.io/images/logo.webp" loading="lazy"></a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav me-1 mb-2 mb-lg-0"><form class="search-bar d-flex ms-1" action="https://csmacnzblog.github.io/search">
  <div class="input-group input-group-sm">
    <button class="btn btn-search disabled position-absolute left-0" type="submit"><i class="fas fa-fw fa-search"></i></button>
    <input class="form-control rounded-pill" id="searchQuery" name="q" type="search" aria-label="Search">
  </div>
</form></ul><ul class="navbar-nav me-1 mb-2 mb-lg-0 me-1 ms-auto"><li class="nav-item">
  <a class="nav-link" data-bs-toggle="offcanvas" href="#offcanvasSettings" role="button"
    aria-controls="offcanvasSettings">
    <i class="fas fa-fw fa-sliders-h"></i> Settings
  </a>
</li>

<div class="offcanvas offcanvas-end surface h-100" tabindex="-1" id="offcanvasSettings"
  aria-labelledby="offcanvasSettingsLabel">
  <div class="offcanvas-header">
    <h5 class="offcanvas-title" w id="offcanvasSettingsLabel"><i class="fas fa-fw fa-sliders-h"></i> Settings</h5>
    <a role="button" data-bs-dismiss="offcanvas" aria-label="Close">
      <span class="fas fa-2x fa-fw fa-times"></span>
    </a>
  </div>
  <div class="offcanvas-body"><section class="setting">
  <form class="row">
    <div class="col-auto">
      <label><i class="fas fa-fw fa-adjust"></i> Mode</label>
    </div>
    <div class="col-auto ms-auto">
      <div class="form-check form-switch">
        <input class="form-check-input" type="checkbox" id="modeSwitcher">
      </div>
    </div>
  </form>
</section>
<section class="setting palettes">
  <form class="row">
    <div class="col-auto">
      <label><i class="fas fa-fw fa-palette"></i> Palette</label>
    </div>
    <div class="col-auto ms-auto">
      <span id="btnPalette" class="btn btn-sm"><i class="fas fa-eye-dropper"></i></span>
    </div>
  </form>
  <div class="container mt-2 visually-hidden" id="palettePicker">
    <div class="btn-group"><button type="button" id="palette-blue" title="Blue" 
          class="btn btn-sm palette bg-blue d-flex align-items-center justify-content-center">
        </button><button type="button" id="palette-blue-gray" title="Blue Gray" 
          class="btn btn-sm palette bg-blue-gray d-flex align-items-center justify-content-center">
        </button><button type="button" id="palette-brown" title="Brown" 
          class="btn btn-sm palette bg-brown d-flex align-items-center justify-content-center">
        </button><button type="button" id="palette-cyan" title="Cyan" 
          class="btn btn-sm palette bg-cyan d-flex align-items-center justify-content-center">
        </button><button type="button" id="palette-green" title="Green" 
          class="btn btn-sm palette bg-green d-flex align-items-center justify-content-center">
        </button><button type="button" id="palette-indigo" title="Indigo" 
          class="btn btn-sm palette bg-indigo d-flex align-items-center justify-content-center">
        </button><button type="button" id="palette-orange" title="Orange" 
          class="btn btn-sm palette bg-orange d-flex align-items-center justify-content-center">
        </button><button type="button" id="palette-pink" title="Pink" 
          class="btn btn-sm palette bg-pink d-flex align-items-center justify-content-center">
        </button><button type="button" id="palette-purple" title="Purple" 
          class="btn btn-sm palette bg-purple d-flex align-items-center justify-content-center">
        </button><button type="button" id="palette-red" title="Red" 
          class="btn btn-sm palette bg-red d-flex align-items-center justify-content-center">
        </button><button type="button" id="palette-teal" title="Teal" 
          class="btn btn-sm palette bg-teal d-flex align-items-center justify-content-center">
        </button><button type="button" id="palette-yellow" title="Yellow" 
          class="btn btn-sm palette bg-yellow d-flex align-items-center justify-content-center">
        </button></button>
    </div>
  </div>
</section></div>
</div></ul>
    </div>
  </div>
</nav>
</header>
<main role="main" class="container">
      <div class="row content">
<div class="col-lg-8">
  <div class="container"><nav class="row" aria-label="breadcrumb">
  <ol class="breadcrumb surface"><li class="breadcrumb-item"><a href="https://csmacnzblog.github.io/">Home</a></li><li class="breadcrumb-item"><a href="https://csmacnzblog.github.io/post/">Posts</a></li><li class="breadcrumb-item active">Caliburn.Micro and Async</li></ol>
</nav><article class="post row surface"><div class="post-toolbox">
  <div class="col-12 d-none d-lg-block">
    <a id="sidebarToggler" class="fas fa-fw fa-2x fa-expand-alt" role="button"></a>
  </div>
</div>
<h1 class="post-title my-3">Caliburn.Micro and Async</h1><div class="post-meta mb-3">
  <span class="post-date me-2">
    <i class="fas fa-fw fa-calendar-alt"></i>May 21, 2015
  </span>
  <span class="post-reading-time me-2">
    <i class="fas fa-fw fa-coffee"></i>6 min read
  </span>
</div>
<div class="post-content mb-3"><p>When it comes to asynchronous processing for client side applications, async and await are an amazing way to code. You no longer have to worry about thread affinity and UIThread delegation. It just works. But it is also real easy to get it wrong when an exception is thrown, as I found out the hard way.</p>
<p>The symptom is simple.  A button click does nothing. Or worse, a button triggers a busy waiting, that waits forever. It may be more complex, a rich user experience gets stuck in an incomplete state, after a user action.  Your system has thrown an exception, an no one stopped to listen.</p>
<p>What do we expect to happen here? Well if something goes wrong in my application, I would want it to take out the app, not silently continue. Better, I would have a global handler using <code>TaskScheduler.UnobservedTaskException</code> and/or <code>Application.DispatcherUnhandledException</code> where i could log the failure, and give the user a crash message before failing.  One step further, if we have isolated modular screens, would be to fail the screen and reset it on a failure, without taking out the whole application. (This last one requires more intervention then I will show here but has worked successfully for me in the past.)</p>
<p>Why does this happen? Well lets look at reproducing the issue before we talk through the situation why.</p>
<p>(I&rsquo;ve uploaded the sample for this blog to GitHub, which can be found <a href="https://github.com/csMacnzBlog/AsyncButtonDemo" target="_blank">here</a>
.)</p>
<p>Lets create a basic WPF app, with two buttons. We will create our buggy method that will throw an exception that looks like this:</p>
<pre><code>private async Task&lt;bool&gt; BuggyCode()
{
    await Task.Factory.StartNew(() =&gt;
    {
        Thread.Sleep(2000);
        throw new TimeoutException(&quot;Something bad happened.&quot;);
    });
    return false;
}
</code></pre>
<p>This method is asynchronous, and uses the new async/await keywords. It also returns a task so we can add continuations and anything else we need.  What we expect to happen, when this exception is thrown, is for our application to crash, since we will not handle this failure. (As apposed to handling the exception as described above)</p>
<p>The view xaml looks something like this:</p>
<pre><code>&lt;StackPanel&gt;
    &lt;Button Content=&quot;Bad Button&quot; Click=&quot;BadButtonOnClick&quot;/&gt;
    &lt;Button Content=&quot;Correct Button&quot; Click=&quot;CorrectButtonOnClick&quot;/&gt;
&lt;/StackPanel&gt;
</code></pre>
<p>We have one button where we will cause the problem from, and a seconds that works correctly.  The code behind is as follows:</p>
<pre><code>private void BadButtonOnClick(object sender, RoutedEventArgs e)
{
    BuggyCode();
}

private async void CorrectButtonOnClick(object sender, RoutedEventArgs e)
{
    await BuggyCode();
}
</code></pre>
<p>When we click the first button, <code>Bad Button</code>, we get no sign that anything has gone wrong. If you have a debugger attached with the right settings, it might stop on the <code>throw new TimeoutException</code> from the <code>BuggyCode</code> method, but continues on with no effect to the application.  Clicking the second button, <code>Correct Button</code>, we immediately see our application crash.</p>
<p>What is the difference here? the first method calls a method that returns a <code>Task</code>, and ignores the result. The second is async, and awaits the <code>Task</code>&rsquo;s completion. Clearly await is going something special with Exceptions for us?</p>
<p>Exactly that. the compiler takes the await as a sign it should handle the task as a result. Part of handling the Task is to unwrap the result, or re throw the exception from the failure. This propagates out, and eventually crashes the process as unhandled.  But when we ignore the Task completely, the object is thrown away, and the error is never seen.</p>
<p>Tasks never used to work this way. This was a <a href="https://msdn.microsoft.com/en-us/library/system.threading.tasks.taskscheduler.unobservedtaskexception%28v=vs.110%29.aspx" target="_blank">change in .Net 4.5 onwards</a>
 that stopped this from crashing the application by default. This can be turned back on using:</p>
<pre><code>&lt;runtime&gt;
    &lt;ThrowUnobservedTaskExceptions enabled=&quot;true&quot;/&gt;
&lt;/runtime&gt;
</code></pre>
<p>This is a reasonably trivial example. Especially since the compile and Resharper tells you quite quickly that you have not handles the result from an asynchronous call. But thats where Caliburn.Micro comes in.</p>
<p>Suppose we create a similar scenario in a Caliburn.Micro WPF application. This time as well as the original two examples, we add a third. Our view code looks very similar, just with an extra button, and names instead of bindings.</p>
<pre><code>&lt;StackPanel&gt;
    &lt;Button Content=&quot;Bad Button&quot; x:Name=&quot;BadButtonOnClick&quot;/&gt;
    &lt;Button Content=&quot;Another Bad Button&quot; x:Name=&quot;AnotherBadButtonOnClick&quot;/&gt;
    &lt;Button Content=&quot;Correct Button&quot; x:Name=&quot;CorrectButtonOnClick&quot;/&gt;
&lt;/StackPanel&gt;
</code></pre>
<p>And our code is in a view model, but the methods still look the same:</p>
<pre><code>public void BadButtonOnClick(object sender, RoutedEventArgs e)
{
    BuggyCode();
}

public async Task AnotherBadButtonOnClick(object sender, RoutedEventArgs e)
{
    await BuggyCode();
}

public async void CorrectButtonOnClick(object sender, RoutedEventArgs e)
{
    await BuggyCode();
}
</code></pre>
<p>Caliburn.Micro, Button click, async method on VM returns Task, exceptions not caught. Return void and they will become unhandled exceptions. otherwise they get lost and unnoticed.
taskscheduler.unobservedtaskexception
AppBootstrapper.OnUnhandledException</p>
<h1 id="notes"><strong>Notes:</strong></h1>
<p>Got a moment for a Caliburn.Micro question?</p>
<p>me
sure</p>
<p>Benjamin
(WPF)
I&rsquo;ve got an exception escaping an implicitly bound click handler
so x:Name=&ldquo;Run&rdquo; in the XAML
public async Task Run() in my View Model
The AppBootstrapper.OnUnhandledException is not firing, though
Ohh
I might have just thought of the problem - does Caliburn,Micro understand Task ?</p>
<p>me
I think it does, but if not, there is another unhandled thing for tasks you can attach to
<a href="https://msdn.microsoft.com/en-us/library/system.threading.tasks.taskscheduler.unobservedtaskexception.aspx">https://msdn.microsoft.com/en-us/library/system.threading.tasks.taskscheduler.unobservedtaskexception.aspx</a></p>
<p>Benjamin
Oh I didn&rsquo;t know about that one
Hmm - doesn&rsquo;t seem to fire either
3:39 PM</p>
<p>me
are you actually throwing an exception?</p>
<p>Benjamin</p>
<pre><code>           throw new InvalidOperationException(&quot;Hello, world&quot;);
</code></pre>
<p>It&rsquo;s in a try { } finally { }</p>
<p>me
that wont matter.
I remember from tasks they don&rsquo;t actually throw if no one checks them
if you get back a task and don&rsquo;t await or call .Result, it never throws.</p>
<p>Benjamin
Wrapping the Task in a Caliburn Coroutine doesn&rsquo;t seem to have helped</p>
<p>me
but when it gets GC&rsquo;d it triggers that handler</p>
<p>Benjamin
Hmmm
3:44 PM</p>
<p>me
<a href="https://caliburnmicro.codeplex.com/discussions/474905">https://caliburnmicro.codeplex.com/discussions/474905</a>
try void async await instead, see what happens?
based on this i found: <a href="http://w3facility.org/question/why-is-application_unhandledexception-not-triggered-for-an-exception-within-an-async-function/">http://w3facility.org/question/why-is-application_unhandledexception-not-triggered-for-an-exception-within-an-async-function/</a>
3:47 PM</p>
<p>Benjamin
Bingo</p>
<p>me
huh, they must be treating Task as a syncronous result you can use from the caller</p>
<p>Benjamin
I tried wrapping Task in an IResult, which is Caliburn&rsquo;s async result type?
Didn&rsquo;t help</p>
<p>me
looks like that is more for the EventAggregator message passing stuff</p>
<p>Benjamin
Looks like this exeception is now being caught by the Dispatcher and then AppBoostrapper
3:51 PM</p>
<p>Benjamin
That&rsquo;ll do for now though
Rubber ducky, dismissed</p>
<p>me
B-)
3:53 PM</p>
<p>me
you don&rsquo;t mind if i blog that do ya?</p>
<p>Benjamin
No?
Well, that depends
On how many times you plan on calling me a Blockhead</p>
<p>me
Ill claim I was the one writing Xaml, take the credit for figuring out the solution, and for writting caliburn micro apps.
win win for me</p>
<p>Benjamin
Ha ha go for it</p>
</div><hr /><div class="post-navs d-flex mb-3 justify-content-between">
  <div class="post-nav w-50"><div class="prev-post btn btn-sm">
      <a href="https://csmacnzblog.github.io/post/ports-and-adapters-what-goes-in-the-engine/">Ports and Adapters - what goes in the engine?</a>
    </div></div>
  <div class="post-nav flex-row-reverse"><div class="next-post btn btn-sm">
      <a href="https://csmacnzblog.github.io/post/code-demoing-with-visual-studio/">Code Demoing with Visual Studio</a>
    </div></div>
</div></article><div class="post-comments surface row"></div></div>
</div><aside class="col-lg-4 sidebar d-flex">
  <div class="container"><section class="recent-posts row surface">
  <h4>Recent Posts</h4>
  <ul><li><a href="https://csmacnzblog.github.io/post/terraform-newrelic-provider-facepalm/">Failed to query available provider packages - Terraform NewRelic Provider :facepalm:</a></li><li><a href="https://csmacnzblog.github.io/post/kotlin-teamcity-and-reflection/">Kotlin, TeamCity and reflection</a></li><li><a href="https://csmacnzblog.github.io/post/bluetooth-devices-keep-disconnecting/">Bluetooth Devices keep disconnecting</a></li><li><a href="https://csmacnzblog.github.io/post/nullable-and-notnull-serialisation-properties/">Nullable and notnull Serialisation Properties</a></li><li><a href="https://csmacnzblog.github.io/post/we-are-all-10x/">We are all 10x engineers, but I don&#39;t think it means what you think it means</a></li></ul>
</section><section class="taxonomy-categories row surface">
      <h4>
        <a href="https://csmacnzblog.github.io/categories">Categories</a>
      </h4>
      <div><a href="https://csmacnzblog.github.io/categories/c#/" class="post-taxonomy rounded btn btn-sm me-2 mb-2" title="c#">
          c# <span class="badge rounded-pill">37</span>
        </a><a href="https://csmacnzblog.github.io/categories/dotnetcore/" class="post-taxonomy rounded btn btn-sm me-2 mb-2" title="dotnetcore">
          dotnetcore <span class="badge rounded-pill">35</span>
        </a><a href="https://csmacnzblog.github.io/categories/tips-and-tricks/" class="post-taxonomy rounded btn btn-sm me-2 mb-2" title="Tips and Tricks">
          Tips and Tricks <span class="badge rounded-pill">30</span>
        </a><a href="https://csmacnzblog.github.io/categories/editorial/" class="post-taxonomy rounded btn btn-sm me-2 mb-2" title="Editorial">
          Editorial <span class="badge rounded-pill">26</span>
        </a><a href="https://csmacnzblog.github.io/categories/continuous-delivery/" class="post-taxonomy rounded btn btn-sm me-2 mb-2" title="Continuous Delivery">
          Continuous Delivery <span class="badge rounded-pill">13</span>
        </a><a href="https://csmacnzblog.github.io/categories/software-development/" class="post-taxonomy rounded btn btn-sm me-2 mb-2" title="software development">
          software development <span class="badge rounded-pill">13</span>
        </a><a href="https://csmacnzblog.github.io/categories/projects/" class="post-taxonomy rounded btn btn-sm me-2 mb-2" title="Projects">
          Projects <span class="badge rounded-pill">12</span>
        </a><a href="https://csmacnzblog.github.io/categories/conference/" class="post-taxonomy rounded btn btn-sm me-2 mb-2" title="Conference">
          Conference <span class="badge rounded-pill">9</span>
        </a><a href="https://csmacnzblog.github.io/categories/git/" class="post-taxonomy rounded btn btn-sm me-2 mb-2" title="git">
          git <span class="badge rounded-pill">8</span>
        </a><a href="https://csmacnzblog.github.io/categories/visual-studio/" class="post-taxonomy rounded btn btn-sm me-2 mb-2" title="Visual Studio">
          Visual Studio <span class="badge rounded-pill">8</span>
        </a></div>
    </section><section class="taxonomy-tags row surface">
      <h4>
        <a href="https://csmacnzblog.github.io/tags">Tags</a>
      </h4>
      <div><a href="https://csmacnzblog.github.io/tags/c#/" class="post-taxonomy rounded btn btn-sm me-2 mb-2" title="c#">
          c# <span class="badge rounded-pill">37</span>
        </a><a href="https://csmacnzblog.github.io/tags/dotnetcore/" class="post-taxonomy rounded btn btn-sm me-2 mb-2" title="dotnetcore">
          dotnetcore <span class="badge rounded-pill">35</span>
        </a><a href="https://csmacnzblog.github.io/tags/tips-and-tricks/" class="post-taxonomy rounded btn btn-sm me-2 mb-2" title="Tips and Tricks">
          Tips and Tricks <span class="badge rounded-pill">30</span>
        </a><a href="https://csmacnzblog.github.io/tags/editorial/" class="post-taxonomy rounded btn btn-sm me-2 mb-2" title="Editorial">
          Editorial <span class="badge rounded-pill">26</span>
        </a><a href="https://csmacnzblog.github.io/tags/continuous-delivery/" class="post-taxonomy rounded btn btn-sm me-2 mb-2" title="Continuous Delivery">
          Continuous Delivery <span class="badge rounded-pill">13</span>
        </a><a href="https://csmacnzblog.github.io/tags/software-development/" class="post-taxonomy rounded btn btn-sm me-2 mb-2" title="software development">
          software development <span class="badge rounded-pill">13</span>
        </a><a href="https://csmacnzblog.github.io/tags/projects/" class="post-taxonomy rounded btn btn-sm me-2 mb-2" title="Projects">
          Projects <span class="badge rounded-pill">12</span>
        </a><a href="https://csmacnzblog.github.io/tags/conference/" class="post-taxonomy rounded btn btn-sm me-2 mb-2" title="Conference">
          Conference <span class="badge rounded-pill">9</span>
        </a><a href="https://csmacnzblog.github.io/tags/git/" class="post-taxonomy rounded btn btn-sm me-2 mb-2" title="git">
          git <span class="badge rounded-pill">8</span>
        </a><a href="https://csmacnzblog.github.io/tags/visual-studio/" class="post-taxonomy rounded btn btn-sm me-2 mb-2" title="Visual Studio">
          Visual Studio <span class="badge rounded-pill">8</span>
        </a></div>
    </section></div>
</aside>
</div>
    </main><footer class="footer mt-auto py-3 text-center container"><nav class="social-links nav my-2 justify-content-center"></nav>
<div class="copyright mb-2">
  
</div>
<div class="powered-by mb-2">
  Powered by <a href="https://gohugo.io" target="_blank">Hugo</a> and the <a href="https://github.com/razonyang/hugo-theme-bootstrap" target="_blank">Bootstrap</a> theme.
</div></footer>
<a id="btnScrollToTop" class="btn-scroll-to-top">
  <i class="fas fa-fw fa-chevron-circle-up fa-2x"></i>
</a>
</body>
</html>
