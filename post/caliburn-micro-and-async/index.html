<!DOCTYPE html>
<html lang="en">
    <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name='author' content='Mark Clearwater, csmacnz@csmac.co.nz'>
    <meta name='language' content='EN'>
    <meta name='medium' content='blog'>


    <title>Caliburn.Micro and Async - csMACnz&#39;s Blog</title>
    <meta name="description" content="When it comes to asynchronous processing for client side applications, async and await are an amazing way to code. You no longer have to worry about thread affinity and UIThread delegation. It just works. But it is also …">
    <meta name='keywords' content='csMACnz'>

    
    <meta property="og:type" content="article"/>
    <meta property="og:title" content="Caliburn.Micro and Async"/>
    <meta property="og:description" content="When it comes to asynchronous processing for client side applications, async and await are an amazing way to code. You no longer have to worry about thread affinity and UIThread delegation. It just works. But it is also …"/>
    <meta property="og:site_name" content="csMACnz&#39;s Blog"/>
    <meta property="og:url" content="https://csmacnzblog.github.io/post/caliburn-micro-and-async/"/>
    <meta property="og:image" content="http://csmac.nz/Content/icon/icon.png"/>

    
    <meta name="twitter:card" content="summary"/>
    <meta name="twitter:title" content="Caliburn.Micro and Async"/>
    <meta name="twitter:description" content="When it comes to asynchronous processing for client side applications, async and await are an amazing way to code. You no longer have to worry about thread affinity and UIThread delegation. It just works. But it is also …"/>
    <meta name="twitter:image" content="http://csmac.nz/Content/icon/icon.png"/>
    <meta name="twitter:site" content="@csMACnz"/>
    <meta name="twitter:creator" content="@csMACnz"/>


    <link rel="apple-touch-icon-precomposed" href="/images/icon/apple-touch-icon-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="72x72" href="/images/icon/apple-touch-icon-72x72-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="114x114" href="/images/icon/apple-touch-icon-114x114-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/images/icon/apple-touch-icon-144x144-precomposed.png">
    <link rel="icon" type="image/png" href="/images/icon/icon.png" />
    <link rel='me' type='text/html' href='https://github.com/csMACnz'>

    <script>
        var d_id  = 'csmacnz',
            g_id  = 'UA-18464866-2',
            g_url = 'auto';
    </script>

    <link rel="stylesheet" type="text/css" href="/css/style.css" />
    <link rel="stylesheet" type="text/css" href="/css/blogstyle.css" />

    <link rel="alternate stylesheet" title="dark-code" type="text/css" href="/css/solarized_dark.css" disabled>
    <link rel="stylesheet" title="light-code" type="text/css" href="/css/github-gist.css" disabled>

    <!-- ENTERING partial seo-schema.html -->
    
    
    <script type="application/ld+json">
    {
        "@context" : "https://schema.org",
        "@type" : "Article",
        "publisher": {
            "@type": "Organization",
            "name": "csMACnz&#x27;s Blog",
            "logo": "https://blog.csmac.nz/content/images/2014/10/apple-touch-icon-144x144-precomposed.png"
        },
        "author": {
            "@type": "Person",
            "name": "Mark Clearwater",
            "image": {
                "@type": "ImageObject",
                "url": "//www.gravatar.com/avatar/c97410951ec3738a3fd4a2dfb17a5d9c?d=404&s=250",
                "width": 440,
                "height": 295
            },
            "url": "https://blog.csmac.nz/author/csmacnz/",
            "sameAs": [
                "http://csmac.nz"
            ]
        },
        "articleSection" : "post",
        "name" : "Caliburn.Micro and Async",
        "headline" : "Caliburn.Micro and Async",
        "url" : "https:\/\/csmacnzblog.github.io\/post\/caliburn-micro-and-async\/",
        "datePublished": "2015-05-21T15:58:53.000Z",
        "dateModified" : "2015-05-21T15:58:53.000Z",
        "keywords" : [  ]
        "description" : "When it comes to asynchronous processing for client side applications, async and await are an amazing way to code. You no longer have to worry about thread affinity and UIThread delegation. It just works. But it is also real easy to get it wrong when an exception is thrown, as I found out the hard way.\nThe symptom is simple. A button click does nothing. Or worse, a button triggers a busy waiting, that waits forever.",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https://blog.csmac.nz/"
        }
        "inLanguage" : "en-US",
        "author" : "Mark Clearwater",
        "creator" : "Mark Clearwater",
        "accountablePerson" : "Mark Clearwater",
        "copyrightHolder" : "Mark Clearwater",
        "copyrightYear" : "2015",
        "wordCount" : "1085",
    }
    </script>
    
    
    <!-- LEAVING partial seo-schema.html -->

    <link rel="alternate" type="application/rss+xml" title="csMACnz&#x27;s Blog" href="https://blog.csmac.nz/rss/" />
    <style>
        .post-content img {
            max-width: 500px;
        }
    </style>
    </head>
    <body class="blog">
        <div class="page-area"><header class="header-area">
    <h1 class="header-area-title">csMACnz</h1>
</header>
<nav class="navigation-area header-bar-parent">
    <div class="header-bar header-bar-blog">
        <ul class="menu">
            <li class="menu-item"><a class="menu-item-content" href="http://csmac.nz">Home</a></li>
            <li class="menu-item"><a class="menu-item-content" href="http://csmac.nz/BaconVaders">Bacon Vaders</a></li>
            <li class="menu-item"><a class="menu-item-content CurrentButton" href="/">Blog</a></li>
        </ul>
    </div>
</nav><div id="content" class="content-area">
            
<article>
    <div class="content-box" itemscope itemtype="http://schema.org/Article">
    
        <span class="post-meta"><time datetime="2015-05-21"  itemprop="datePublished">21 May 15</time> on
            
        </span>
    
        <h1 class="post-title" itemprop="headline">Caliburn.Micro and Async</h1>
    
        <section class="post-content"  itemprop="articleBody">
            <p>When it comes to asynchronous processing for client side applications, async and await are an amazing way to code. You no longer have to worry about thread affinity and UIThread delegation. It just works. But it is also real easy to get it wrong when an exception is thrown, as I found out the hard way.</p>
<p>The symptom is simple.  A button click does nothing. Or worse, a button triggers a busy waiting, that waits forever. It may be more complex, a rich user experience gets stuck in an incomplete state, after a user action.  Your system has thrown an exception, an no one stopped to listen.</p>
<p>What do we expect to happen here? Well if something goes wrong in my application, I would want it to take out the app, not silently continue. Better, I would have a global handler using <code>TaskScheduler.UnobservedTaskException</code> and/or <code>Application.DispatcherUnhandledException</code> where i could log the failure, and give the user a crash message before failing.  One step further, if we have isolated modular screens, would be to fail the screen and reset it on a failure, without taking out the whole application. (This last one requires more intervention then I will show here but has worked successfully for me in the past.)</p>
<p>Why does this happen? Well lets look at reproducing the issue before we talk through the situation why.</p>
<p>(I&rsquo;ve uploaded the sample for this blog to GitHub, which can be found <a href="https://github.com/csMacnzBlog/AsyncButtonDemo">here</a>.)</p>
<p>Lets create a basic WPF app, with two buttons. We will create our buggy method that will throw an exception that looks like this:</p>
<pre><code>private async Task&lt;bool&gt; BuggyCode()
{
    await Task.Factory.StartNew(() =&gt;
    {
        Thread.Sleep(2000);
        throw new TimeoutException(&quot;Something bad happened.&quot;);
    });
    return false;
}
</code></pre>
<p>This method is asynchronous, and uses the new async/await keywords. It also returns a task so we can add continuations and anything else we need.  What we expect to happen, when this exception is thrown, is for our application to crash, since we will not handle this failure. (As apposed to handling the exception as described above)</p>
<p>The view xaml looks something like this:</p>
<pre><code>&lt;StackPanel&gt;
    &lt;Button Content=&quot;Bad Button&quot; Click=&quot;BadButtonOnClick&quot;/&gt;
    &lt;Button Content=&quot;Correct Button&quot; Click=&quot;CorrectButtonOnClick&quot;/&gt;
&lt;/StackPanel&gt;
</code></pre>
<p>We have one button where we will cause the problem from, and a seconds that works correctly.  The code behind is as follows:</p>
<pre><code>private void BadButtonOnClick(object sender, RoutedEventArgs e)
{
    BuggyCode();
}

private async void CorrectButtonOnClick(object sender, RoutedEventArgs e)
{
    await BuggyCode();
}
</code></pre>
<p>When we click the first button, <code>Bad Button</code>, we get no sign that anything has gone wrong. If you have a debugger attached with the right settings, it might stop on the <code>throw new TimeoutException</code> from the <code>BuggyCode</code> method, but continues on with no effect to the application.  Clicking the second button, <code>Correct Button</code>, we immediately see our application crash.</p>
<p>What is the difference here? the first method calls a method that returns a <code>Task</code>, and ignores the result. The second is async, and awaits the <code>Task</code>&rsquo;s completion. Clearly await is going something special with Exceptions for us?</p>
<p>Exactly that. the compiler takes the await as a sign it should handle the task as a result. Part of handling the Task is to unwrap the result, or re throw the exception from the failure. This propagates out, and eventually crashes the process as unhandled.  But when we ignore the Task completely, the object is thrown away, and the error is never seen.</p>
<p>Tasks never used to work this way. This was a <a href="https://msdn.microsoft.com/en-us/library/system.threading.tasks.taskscheduler.unobservedtaskexception%28v=vs.110%29.aspx">change in .Net 4.5 onwards</a> that stopped this from crashing the application by default. This can be turned back on using:</p>
<pre><code>&lt;runtime&gt;
    &lt;ThrowUnobservedTaskExceptions enabled=&quot;true&quot;/&gt;
&lt;/runtime&gt;
</code></pre>
<p>This is a reasonably trivial example. Especially since the compile and Resharper tells you quite quickly that you have not handles the result from an asynchronous call. But thats where Caliburn.Micro comes in.</p>
<p>Suppose we create a similar scenario in a Caliburn.Micro WPF application. This time as well as the original two examples, we add a third. Our view code looks very similar, just with an extra button, and names instead of bindings.</p>
<pre><code>&lt;StackPanel&gt;
    &lt;Button Content=&quot;Bad Button&quot; x:Name=&quot;BadButtonOnClick&quot;/&gt;
    &lt;Button Content=&quot;Another Bad Button&quot; x:Name=&quot;AnotherBadButtonOnClick&quot;/&gt;
    &lt;Button Content=&quot;Correct Button&quot; x:Name=&quot;CorrectButtonOnClick&quot;/&gt;
&lt;/StackPanel&gt;
</code></pre>
<p>And our code is in a view model, but the methods still look the same:</p>
<pre><code>public void BadButtonOnClick(object sender, RoutedEventArgs e)
{
    BuggyCode();
}

public async Task AnotherBadButtonOnClick(object sender, RoutedEventArgs e)
{
    await BuggyCode();
}

public async void CorrectButtonOnClick(object sender, RoutedEventArgs e)
{
    await BuggyCode();
}
</code></pre>
<p>Caliburn.Micro, Button click, async method on VM returns Task, exceptions not caught. Return void and they will become unhandled exceptions. otherwise they get lost and unnoticed.
taskscheduler.unobservedtaskexception
AppBootstrapper.OnUnhandledException</p>
<h1 id="notes"><strong>Notes:</strong></h1>
<p>Got a moment for a Caliburn.Micro question?</p>
<p>me
sure</p>
<p>Benjamin
(WPF)
I&rsquo;ve got an exception escaping an implicitly bound click handler
so x:Name=&ldquo;Run&rdquo; in the XAML
public async Task Run() in my View Model
The AppBootstrapper.OnUnhandledException is not firing, though
Ohh
I might have just thought of the problem - does Caliburn,Micro understand Task ?</p>
<p>me
I think it does, but if not, there is another unhandled thing for tasks you can attach to
<a href="https://msdn.microsoft.com/en-us/library/system.threading.tasks.taskscheduler.unobservedtaskexception.aspx">https://msdn.microsoft.com/en-us/library/system.threading.tasks.taskscheduler.unobservedtaskexception.aspx</a></p>
<p>Benjamin
Oh I didn&rsquo;t know about that one
Hmm - doesn&rsquo;t seem to fire either
3:39 PM</p>
<p>me
are you actually throwing an exception?</p>
<p>Benjamin</p>
<pre><code>           throw new InvalidOperationException(&quot;Hello, world&quot;);
</code></pre>
<p>It&rsquo;s in a try { } finally { }</p>
<p>me
that wont matter.
I remember from tasks they don&rsquo;t actually throw if no one checks them
if you get back a task and don&rsquo;t await or call .Result, it never throws.</p>
<p>Benjamin
Wrapping the Task in a Caliburn Coroutine doesn&rsquo;t seem to have helped</p>
<p>me
but when it gets GC&rsquo;d it triggers that handler</p>
<p>Benjamin
Hmmm
3:44 PM</p>
<p>me
<a href="https://caliburnmicro.codeplex.com/discussions/474905">https://caliburnmicro.codeplex.com/discussions/474905</a>
try void async await instead, see what happens?
based on this i found: <a href="http://w3facility.org/question/why-is-application_unhandledexception-not-triggered-for-an-exception-within-an-async-function/">http://w3facility.org/question/why-is-application_unhandledexception-not-triggered-for-an-exception-within-an-async-function/</a>
3:47 PM</p>
<p>Benjamin
Bingo</p>
<p>me
huh, they must be treating Task as a syncronous result you can use from the caller</p>
<p>Benjamin
I tried wrapping Task in an IResult, which is Caliburn&rsquo;s async result type?
Didn&rsquo;t help</p>
<p>me
looks like that is more for the EventAggregator message passing stuff</p>
<p>Benjamin
Looks like this exeception is now being caught by the Dispatcher and then AppBoostrapper
3:51 PM</p>
<p>Benjamin
That&rsquo;ll do for now though
Rubber ducky, dismissed</p>
<p>me
B-)
3:53 PM</p>
<p>me
you don&rsquo;t mind if i blog that do ya?</p>
<p>Benjamin
No?
Well, that depends
On how many times you plan on calling me a Blockhead</p>
<p>me
Ill claim I was the one writing Xaml, take the credit for figuring out the solution, and for writting caliburn micro apps.
win win for me</p>
<p>Benjamin
Ha ha go for it</p>
</section>
        
        <section class="share">
            Share: 
            <a class="icon-twitter" href="http://twitter.com/share?text=Caliburn.Micro%20and%20Async&url=https%3a%2f%2fcsmacnzblog.github.io%2fpost%2fcaliburn-micro-and-async%2f"
                onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
                <span>Twitter</span>
            </a>
            |
            <a class="icon-facebook" href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fcsmacnzblog.github.io%2fpost%2fcaliburn-micro-and-async%2f"
                onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
                <span>Facebook</span>
            </a>
        </section>
    </div>
    <div class="content-box">
        
        <div id="disqus_thread"></div>
        <script type="text/javascript">
            var disqus_shortname = d_id; 
            var disqus_title = 'Caliburn.Micro and Async';
            
             
            (function() {
                var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
        <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    
    </div>
</article>

        </div><aside class="sidebar-area">
            <div class="header-bar-parent sidebar-item">
                <div class="header-bar header-bar-twitter">Twitter</div>
                
                <a class="twitter-timeline" style="display: block; text-align: center;" href="https://twitter.com/csmacnz" data-widget-id="523634688984772608">Tweets by @@csmacnz</a>
                <script>!function (d, s, id) { var js, fjs = d.getElementsByTagName(s)[0], p = /^http:/.test(d.location) ? 'http' : 'https'; if (!d.getElementById(id)) { js = d.createElement(s); js.id = id; js.src = p + "://platform.twitter.com/widgets.js"; fjs.parentNode.insertBefore(js, fjs); } }(document, "script", "twitter-wjs");</script>
                
            </div>
            <div class="header-bar-parent sidebar-item">
                <div class="header-bar header-bar-rss">Subscribe</div>
                
                <a class="email-subscribe-link" href="https://feedburner.google.com/fb/a/mailverify?uri=csmacnzBlog&amp;loc=en_US">Subscribe to csMACnz's Blog by Email</a>
                <a href="http://add.my.yahoo.com/rss?url=http://feeds.feedburner.com/csmacnzBlog" title="csMACnz&amp;#039;s Blog"><img src="http://us.i1.yimg.com/us.yimg.com/i/us/my/addtomyyahoo4.gif" alt="" style="border:0"/></a>
                <a href="http://feedly.com/#subscription/feed/http://feeds.feedburner.com/csmacnzBlog" title="csMACnz&amp;#039;s Blog"><img src="http://s3.feedly.com/feedburner/feedly.png" alt="" style="border:0"/></a>
                <a href="http://www.netvibes.com/subscribe.php?url=http://feeds.feedburner.com/csmacnzBlog"><img src="http://www.netvibes.com/img/add2netvibes.gif" width="91" height="17" alt="Add to netvibes" style="border:0" /></a>
                <a href="http://feeds.feedburner.com/csmacnzBlog"><img src="http://feeds.feedburner.com/~fc/csmacnzBlog?bg=fabb45&amp;fg=4B4B4B&amp;anim=1" height="26" width="88" style="border:0" alt="" /></a>
                <br />
                <a href="https://www.patreon.com/csMACnz" target="_blank"><img src="/images/patreon.png" /></a>
                
                
            </div>
            <div class="header-bar-parent sidebar-item">
                <div class="header-bar header-bar-xbox">Gamercard</div>
                

                <div style="margin: 0 auto; width:201px;">
                    <iframe src="//gamercard.xbox.com/csMACnz.card" scrolling="no" frameborder="0" height="136px" width="201px">AutomatonMan</iframe>
                </div>
                <a href="http://steamcommunity.com/id/csMACnz/" target="_blank"><img src="http://steamsignature.com/status/english/76561197994712512.png" alt="" title="csMACnz's Steam Profile" /></a>
                
            </div>
            <div class="header-bar-parent sidebar-item">
                <div class="header-bar header-bar-ads">Advertisement</div>
                
                <div>
                    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
                    
                    <ins class="adsbygoogle"
                         style="display:block"
                         data-ad-client="ca-pub-4517187877737982"
                         data-ad-slot="7632444699"
                         data-ad-format="auto"></ins>
                    <script>
                    (adsbygoogle = window.adsbygoogle || []).push({});
                    </script>
                </div>
                
            </div>
        </aside>
        
        <footer class="footer-area"><p>
    Designed and Maintained by Mark Clearwater; Last updated June 2015.
    <br /><a class="footer-link" >Hi</a>
</p></footer>
    </div>
    
    
    <script src="/js/highlight.pack.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    
    <script src="/js/codetoggle.js"></script> 

    
    <script>
        var _gaq = [['_setAccount', g_id], ['_trackPageview']];
        (function (d, t) {
            var g = d.createElement(t), s = d.getElementsByTagName(t)[0];
            g.src = ('https:' == location.protocol ? '//ssl' : '//www') + '.google-analytics.com/ga.js';
            s.parentNode.insertBefore(g, s);
        }(document, 'script'));
    </script>

    <script type="text/javascript" src="https://code.jquery.com/jquery-1.11.3.min.js"></script>
    </body>
</html>
