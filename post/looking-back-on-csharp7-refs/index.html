<!DOCTYPE html>
<html lang="en">
    <head>

        <script>
            if(!/blog\.csmac\.nz/.test(window.location.host)) {
                window.location = "https:\/\/blog.csmac.nz\/post\/looking-back-on-csharp7-refs\/";
            }
        </script>

        <meta charset="utf-8" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta name='author' content='Mark Clearwater, csmacnz@csmac.co.nz'>
        <meta name='language' content='EN'>
        <meta name='medium' content='blog'>

    
        <title>Looking Back on C# 7: refs enhancements - csMACnz&#39;s Blog</title>
        <meta name="description" content="With C# 8 on our doorstep, I figure it is a good time to reflect on recent additions to the language that have come before. There are some great improvements you may have missed, some that I really enjoy using, and some …">
        <meta name='keywords' content='csMACnz, C Sharp'>

        
        <meta property="og:type" content="article"/>
        <meta property="og:title" content="Looking Back on C# 7: refs enhancements"/>
        <meta property="og:description" content="With C# 8 on our doorstep, I figure it is a good time to reflect on recent additions to the language that have come before. There are some great improvements you may have missed, some that I really enjoy using, and some …"/>
        <meta property="og:site_name" content="csMACnz&#39;s Blog"/>
        <meta property="og:url" content="https://blog.csmac.nz/post/looking-back-on-csharp7-refs/"/>
        <meta property="og:image" content="https://csmac.nz/Content/icon/icon.png"/>

        
        <meta name="twitter:card" content="summary"/>
        <meta name="twitter:title" content="Looking Back on C# 7: refs enhancements"/>
        <meta name="twitter:description" content="With C# 8 on our doorstep, I figure it is a good time to reflect on recent additions to the language that have come before. There are some great improvements you may have missed, some that I really enjoy using, and some …"/>
        <meta name="twitter:image" content="https://csmac.nz/Content/icon/icon.png"/>
        <meta name="twitter:site" content="@csMACnz"/>
        <meta name="twitter:creator" content="@csMACnz"/>
    

        <link rel="apple-touch-icon-precomposed" href="/images/icon/apple-touch-icon-precomposed.png">
        <link rel="apple-touch-icon-precomposed" sizes="72x72" href="/images/icon/apple-touch-icon-72x72-precomposed.png">
        <link rel="apple-touch-icon-precomposed" sizes="114x114" href="/images/icon/apple-touch-icon-114x114-precomposed.png">
        <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/images/icon/apple-touch-icon-144x144-precomposed.png">
        <link rel="icon" type="image/png" href="/images/icon/icon.png" />
        <link rel='me' type='text/html' href='https://github.com/csMACnz'>

        <script>
            var d_id  = 'csmacnz',
                g_id  = 'UA-18464866-2',
                g_url = 'auto';
        </script>

        <link rel="stylesheet" type="text/css" href="/css/style.css" />
        <link rel="stylesheet" type="text/css" href="/css/blogstyle.css" />

        <link rel="alternate stylesheet" title="dark-code" type="text/css" href="/css/solarized_dark.css" disabled>
        <link rel="stylesheet" title="light-code" type="text/css" href="/css/github-gist.css" disabled>

        <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4517187877737982"
        crossorigin="anonymous"></script>

        
        
        <script type="application/ld+json">
        {
            "@context" : "https://schema.org",
            "@type" : "Article",
            "publisher": {
                "@type": "Organization",
                "name": "csMACnz&#x27;s Blog",
                "logo": "https:\/\/blog.csmac.nz\/images\/icon\/apple-touch-icon-144x144-precomposed.png"
            },
            "author": {
                "@type": "Person",
                "name": "Mark Clearwater",
                "image": {
                    "@type": "ImageObject",
                    "url": "//www.gravatar.com/avatar/c97410951ec3738a3fd4a2dfb17a5d9c?d=404&s=250",
                    "width": 440,
                    "height": 295
                },
                "url": "https:\/\/blog.csmac.nz",
                "sameAs": [
                    "https://csmac.nz"
                ]
            },
            "articleSection" : "post",
            "name" : "Looking Back on C# 7: refs enhancements",
            "headline" : "Looking Back on C# 7: refs enhancements",
            "url" : "https:\/\/blog.csmac.nz\/post\/looking-back-on-csharp7-refs\/",
            "datePublished": "2019-06-17T06:00:00.000Z",
            "dateModified" : "2019-06-17T06:00:00.000Z",
            "image" : {
                "@type": "ImageObject",
                "url": "https:\/\/images.unsplash.com\/photo-1530226406379-f84b9edd291b?ixlib=rb-1.2.1\u0026q=80\u0026fm=jpg\u0026crop=entropy\u0026cs=tinysrgb\u0026w=1080\u0026fit=max\u0026ixid=eyJhcHBfaWQiOjE2ODI3fQ",
                "width": 440,
                "height": 295
            },
            "keywords" : [ "C Sharp" ]
            "description" : "With C# 8 on our doorstep, I figure it is a good time to reflect on recent additions to the language that have come before. There are some great improvements you may have missed, some that I really enjoy using, and some I consider have reached canonical usage status that I think are all worth some reflection.\nWe talked about the out variables in the previous post in the series, but there are a few other enhancements related to ref as well.",
            "mainEntityOfPage": {
                "@type": "WebPage",
                "@id": "https:\/\/blog.csmac.nz"
            }
            "inLanguage" : "en-US",
            "author" : "Mark Clearwater",
            "creator" : "Mark Clearwater",
            "accountablePerson" : "Mark Clearwater",
            "copyrightHolder" : "Mark Clearwater",
            "copyrightYear" : "2019",
            "wordCount" : "1284",
        }
        </script>
        
        
        
    </head>
    <body class="blog">
        <div class="page-area">

            <header class="header-area">
                <h1 class="header-area-title">csMACnz</h1>
            </header>
            <nav class="navigation-area header-bar-parent">
                <div class="header-bar header-bar-blog">
                    <ul class="menu">
                        <li class="menu-item"><a class="menu-item-content" href="https://csmac.nz">Home</a></li>
                        <li class="menu-item"><a class="menu-item-content" href="https://csmac.nz/baconvaders">Bacon Vaders</a></li>
                        <li class="menu-item"><a class="menu-item-content CurrentButton" href="/">Blog</a></li>
                    </ul>
                </div>
            </nav>

            <div id="content" class="content-area">

<!--Page Content Begins-->

<article>
    <div class="content-box" itemscope itemtype=" https://schema.org/Article"><span class="post-meta"><time datetime="2019-06-17"  itemprop="datePublished">17 Jun 19</time> in <a href="/categories/software-engineering">Software Engineering</a> on <a href="/tags/c-sharp">C Sharp</a></span>
<h1 class="post-title" itemprop="headline">Looking Back on C# 7: refs enhancements</h1>
    
        <section class="post-content"  itemprop="articleBody">
            <img class="post-image" src="https://images.unsplash.com/photo-1530226406379-f84b9edd291b?ixlib=rb-1.2.1&amp;q=80&amp;fm=jpg&amp;crop=entropy&amp;cs=tinysrgb&amp;w=1080&amp;fit=max&amp;ixid=eyJhcHBfaWQiOjE2ODI3fQ"><p>With C# 8 on our doorstep, I figure it is a good time to reflect on recent additions to the language that have come before. There are some great improvements you may have missed, some that I really enjoy using, and some I consider have reached canonical usage status that I think are all worth some reflection.</p>
<p>We talked about the out variables <a href="/looking-back-on-csharp7-out-variables">in the previous post in the series</a>, but there are a few other enhancements related to <code>ref</code> as well.</p>
<p>Hopefully, the concepts of values, pointers, stacks and heaps make sense to you at a conceptual level. These are crucial concepts to using and understanding <code>ref</code> and <code>out</code>.</p>
<p>As a quick recap, stack memory is local to a function and the function call stack. This memory is semantically &ldquo;pushed&rdquo; to for each method call, and &ldquo;popped&rdquo; from on each return (the call stack, stack overflow etc). The heap is a shared memory space where objects are allocated and stored, which is acted on by the Garbage Collector.</p>
<p>Values are mostly stack-allocated. They are copied around so that setting a value variable does not affect any other variable. Primitive types and structs are Value types. Reference types are the classes in C#. Classes are always stored on the heap, and all variables of class types are pointers or references. Assigning a reference to a new variable will point to the same value on the heap. Changing a field value on a reference type will be reflected in both variables. (Boxing values onto the heap is another thing, too.)</p>
<p>We already have <code>out</code> that allows the caller to declare a variable on the current stack that it passes by address (pointer, reference, or ref) that the method is contracted to set for you. This essentially gives us some of the power of reference types from a stack-allocated value. When we use <code>ref</code>, we gain all of the power of passing by reference that we have from heap allocated class types. We are essentially saying that the caller can use the existing value of the reference, and also set a new value to the stack variable if it wants to as well. Basically, all the restrictions that <code>out</code> imposes are taken off. A ref may not just be a stack variable, but could also be a field on a class that you want to access directly by reference, instead of having to constantly dereference it.</p>
<p>Pass by <code>ref</code> has been in C# since the beginning, but like the <code>out</code> parameters, only works in method signatures. However, from the beginning, you could never declare a <code>ref</code> variable.</p>
<p>In C# 7, <code>ref</code> has been extended to work with return types, and with variables. You can return a value by reference. And so that it the returned result can be assigned to something in a useful way, we also now have <code>ref</code> variable typing.  Like most C# language features, there is safety built in.</p>
<ul>
<li>You must add the <code>ref</code> keyword to the method signature and to all return statements in a method.</li>
<li>A <code>ref</code> return may be assigned to a value variable (by copy) or a <code>ref</code> variable.</li>
<li>You can&rsquo;t assign a standard method return value to a <code>ref</code> local variable.</li>
<li>You can&rsquo;t return a <code>ref</code> to a variable whose lifetime doesn&rsquo;t extend beyond the execution of the method.</li>
</ul>
<p>These rules ensure the safety of your code and ensure readability, that it is clear about what is happening.</p>
<p>I&rsquo;m going to blatantly steal <a href="https://docs.microsoft.com/en-us/dotnet/csharp/whats-new/csharp-7#ref-locals-and-returns">the Microsoft examples</a> for this because I don&rsquo;t want to invent an example and get it wrong.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cs" data-lang="cs"><span style="display:flex;"><span><span style="color:#75715e">// We declare the method as returning by reference (rather than copy)</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">ref</span> <span style="color:#66d9ef">int</span> Find(<span style="color:#66d9ef">int</span> number, <span style="color:#66d9ef">int</span>[] numbers)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> i = <span style="color:#ae81ff">0</span>; i &lt; numbers.Length; i++)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (numbers[i] == number)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// All returns must use the `ref` keyword</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">ref</span> numbers[i]; <span style="color:#75715e">// return the storage location, not the value</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// We can still throw an exception if necessary</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> IndexOutOfRangeException(<span style="color:#e6db74">$&#34;{nameof(number)} not found&#34;</span>);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// arrays are already allocated to the heap and passed by reference rather than by value</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// (see the `stackalloc` keyword for stack allocating arrays, though)</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span>[] array = { <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">15</span>, -<span style="color:#ae81ff">39</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">7</span>, <span style="color:#ae81ff">14</span>, -<span style="color:#ae81ff">12</span> };
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// We have to use `ref` to call the method</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// We choose to declare `place` as a reference</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">ref</span> <span style="color:#66d9ef">int</span> place = <span style="color:#66d9ef">ref</span> Find(<span style="color:#ae81ff">7</span>, array); <span style="color:#75715e">// aliases 7&#39;s place in the array</span>
</span></span><span style="display:flex;"><span>place = <span style="color:#ae81ff">9</span>; <span style="color:#75715e">// replaces 7 with 9 in the array</span>
</span></span><span style="display:flex;"><span>WriteLine(array[<span style="color:#ae81ff">4</span>]); <span style="color:#75715e">// prints 9</span>
</span></span></code></pre></div><p>In the above example, we could have chosen to declare <code>place</code> without the <code>ref</code> keyword and the value returned would be copied instead. However, in this case, the assignment of <code>place = 9;</code> would be overriding the local copy, and not modifying the original array.</p>
<p>Why would you use these pass by reference additions? Huge performance enhancements can be achieved by avoiding stack and heap copying or dereferencing of values in certain algorithms. Performance is the name of the game here.</p>
<p>In C# 7.2, the conditional operator (<code>isTrue ? x : y</code> syntax) can now evaluate to a reference result when both operands (<code>x</code> and <code>y</code> above) are also references.</p>
<p><code>ref var r = ref (arr != null ? ref arr[0] : ref otherArr[0]);</code></p>
<p>In 7.2 we also got <code>ref readonly</code>, which allows returned references to disallow modification enforced by the compiler. This may save time constantly dereferencing a child field in a scenario that you need to get the latest value, for instance in a loop. Again, performance is the target use-case.</p>
<p>The first version of <code>ref</code> variables was immutable only. Whatever you declared them to point to was what they always referred to for their lifetime. In C# 7.3, they were updated so you can reuse a variable to point to a different reference instead.</p>
<p>To complement the safety of the <code>out</code> restrictions compared to <code>ref</code> we also get the <code>in</code> keyword.</p>
<p>Declaring a method parameter with <code>in</code> essentially makes it a read-only reference. the method is not allowed to modify the value passed in but gets all the benefits of being passed by reference rather than by value (copied). The <code>in</code> keyword will make the compiler ensure that the method is not allowed to modify the original passed in value. If necessary it will create a defensive shadow-copy to ensure that is true.</p>
<p>This is well paired with another new feature, <code>readonly struct</code>.  Declaring a struct as read-only means the compiler will ensure you are indeed read-only. (It will disallow <code>public int Foo { get; private set; }</code> for example.) You can use the <code>in</code> keyword for any methods that you want to take a ref to one of these structs again to ensure clarity when reading the code, but also enforced by the compiler.</p>
<p>I mentioned the defensive shadow copy above. The language and runtime do not guarantee that the internal implementation detail of a Property or Method is non-mutable from the contracts, so the compiler will get defensive, and make copies before calling anything that might cause a mutation. This way, the language guarantees the expectations of passing a read-only reference, but maybe doesn&rsquo;t match performance expectations in the process. As a developer, by making the type a <code>readonly struct</code> instead, the compiler can rely on the guarantees and won&rsquo;t make any copies. The struct won&rsquo;t compile if it mutates any of its internal state, so we have stronger guarantees at compile-time and run-time.</p>
<p>These features are certainly power features, and when you need them they will be useful. But like most advanced features, you may be sacrificing readability for performance and optimisation. Use sparingly, but maybe measure first and then sprinkle in and measure again.</p>
</section>
        
        <section class="share">
            Share: 
            <a class="icon-twitter" href="https://twitter.com/share?text=Looking%20Back%20on%20C%23%207%3a%20refs%20enhancements&url=https%3a%2f%2fblog.csmac.nz%2fpost%2flooking-back-on-csharp7-refs%2f"
                onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
                <span>Twitter</span>
            </a>
            |
            <a class="icon-facebook" href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fblog.csmac.nz%2fpost%2flooking-back-on-csharp7-refs%2f"
                onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
                <span>Facebook</span>
            </a>
        </section>
    </div>
    <div class="content-box">
        
        <div id="disqus_thread"></div>
        <script type="text/javascript">
            var disqus_shortname = d_id; 
            var disqus_title = 'Looking Back on C# 7: refs enhancements';
            
             
            (function() {
                var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
        <a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    
    </div>
</article>

<!--Page Content Ends-->

            </div><aside class="sidebar-area">

<!--Sidebar Content Begins-->

                <div class="header-bar-parent sidebar-item">
                    <div class="header-bar header-bar-mastodon">Mastodon</div>
                    
                    
                    <iframe allowfullscreen sandbox="allow-top-navigation allow-scripts" width="280" height="400" src="https://maplefeed.bihlink.com/apiv2/feed?userurl=https%3A%2F%2Fmastodon.nz%2F%2Fusers%2Fcsmacnz&theme=modern-light&size=80&header=true&replies=false&boosts=false"></iframe>
                    
                </div>


                <div class="header-bar-parent sidebar-item">
                    <div class="header-bar header-bar-rss">Subscribe</div>
                    
                    <a href="/rssfeeds/" title="csMACnz's Blog">RSS Feeds</a>
                    <a href="https://feedly.com/i/subscription/feed%2Fhttps%3A%2F%2Ffeeds.feedburner.com%2FcsmacnzBlog" target="_blank" title="csMACnz&amp;#039;s Blog"><img src="https://s3.feedly.com/feedburner/feedly.png" alt="" style="border:0"/></a>
                    <br />
                    <a href="https://www.patreon.com/csMACnz" target="_blank"><img src="/images/patreon.png" /></a>
                    
                    
                </div>


                <div class="header-bar-parent sidebar-item">
                    <div class="header-bar header-bar-xbox">Gamercard</div>
                    

                    <div>
                        <a href="https://www.exophase.com/xbox/user/csMACnz/"><img width="288px" src="https://card.exophase.com/1/1476805.png"></a>
                        <a href="http://steamcommunity.com/id/csMACnz/" target="_blank"><img src="https://www.steamsignature.com/status/english/76561197994712512.png" alt="" title="csMACnz's Steam Profile" /></a>
                    </div>
                    
                </div>


                <div class="header-bar-parent sidebar-item">
                    <div class="header-bar header-bar-ads">Advertisement</div>
                    
                    <div>
                        
                        <ins class="adsbygoogle"
                            style="display:block"
                            data-ad-client="ca-pub-4517187877737982"
                            data-ad-slot="3618449993"
                            data-ad-format="auto"
                            data-full-width-responsive="true"></ins>
                        <script>
                            (adsbygoogle = window.adsbygoogle || []).push({});
                        </script>
                    </div>
                    
                </div>

<!--Sidebar Content Ends-->

            </aside>

            <footer class="footer-area">

            <p>
                Designed and Maintained by Mark Clearwater; Last updated August 2021.
                <!-- This used to be something useful, now it is just a hack I left it to make layout easier but also as a fun reminder for me of what it used to be -->
                <br /><a class="footer-link" >¯\_(ツ)_/¯</a>
            </p>

            </footer>
        </div>

<!--body scripts Begins-->

        
        <script src="/js/highlight.pack.js"></script>
        <script>hljs.initHighlightingOnLoad();</script>

        <script src="/js/codetoggle.js"></script> 

        
        <script src="/js/htmx.min.js"></script>

        
        <script>
            var _gaq = [['_setAccount', g_id], ['_trackPageview']];
            (function (d, t) {
                var g = d.createElement(t), s = d.getElementsByTagName(t)[0];
                g.src = ('https:' == location.protocol ? '//ssl' : '//www') + '.google-analytics.com/ga.js';
                s.parentNode.insertBefore(g, s);
            }(document, 'script'));
        </script>

        <script type="text/javascript" src="https://code.jquery.com/jquery-1.11.3.min.js"></script>

<!--body scripts Ends-->


<!-------------------------------->
<!--                            -->
<!--  _(\    |@@|               -->
<!-- (__/\__ \--/ __            -->
<!--    \___|----|  |   __      -->
<!--        \ }{ /\ )_ / _\     -->
<!--        /\__/\ \__O (__     -->
<!--       (--/\--)    \__/     -->
<!--       _)(  )(_             -->
<!--      `---''---`            -->
<!--                            -->
<!-- https://github.com/csMACnz -->
<!-------------------------------->

    </body>
</html>
