<!DOCTYPE html>
<html lang="en">
    <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name='author' content='Mark Clearwater, csmacnz@csmac.co.nz'>
    <meta name='language' content='EN'>
    <meta name='medium' content='blog'>


    <title>TeamCity, GitHub and Pull Requests - csMACnz&#39;s Blog</title>
    <meta name="description" content="I&rsquo;ve been having fun setting up TeamCity builds, specifically trying to run a static analysis build that shows it&rsquo;s results on a pull request. This lead me to discover some issues with the built-in TeamCity …">
    <meta name='keywords' content='csMACnz, Continuous Delivery, git, TeamCity, GitHub'>

    
    <meta property="og:type" content="article"/>
    <meta property="og:title" content="TeamCity, GitHub and Pull Requests"/>
    <meta property="og:description" content="I&rsquo;ve been having fun setting up TeamCity builds, specifically trying to run a static analysis build that shows it&rsquo;s results on a pull request. This lead me to discover some issues with the built-in TeamCity …"/>
    <meta property="og:site_name" content="csMACnz&#39;s Blog"/>
    <meta property="og:url" content="https://csmacnzblog.github.io/post/teamcity-github-and-pull-requests/"/>
    <meta property="og:image" content="http://csmac.nz/Content/icon/icon.png"/>

    
    <meta name="twitter:card" content="summary"/>
    <meta name="twitter:title" content="TeamCity, GitHub and Pull Requests"/>
    <meta name="twitter:description" content="I&rsquo;ve been having fun setting up TeamCity builds, specifically trying to run a static analysis build that shows it&rsquo;s results on a pull request. This lead me to discover some issues with the built-in TeamCity …"/>
    <meta name="twitter:image" content="http://csmac.nz/Content/icon/icon.png"/>
    <meta name="twitter:site" content="@csMACnz"/>
    <meta name="twitter:creator" content="@csMACnz"/>


    <link rel="apple-touch-icon-precomposed" href="/images/icon/apple-touch-icon-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="72x72" href="/images/icon/apple-touch-icon-72x72-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="114x114" href="/images/icon/apple-touch-icon-114x114-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/images/icon/apple-touch-icon-144x144-precomposed.png">
    <link rel="icon" type="image/png" href="/images/icon/icon.png" />
    <link rel='me' type='text/html' href='https://github.com/csMACnz'>

    <script>
        var d_id  = 'csmacnz',
            g_id  = 'UA-18464866-2',
            g_url = 'auto';
    </script>

    <link rel="stylesheet" type="text/css" href="/css/style.css" />
    <link rel="stylesheet" type="text/css" href="/css/blogstyle.css" />

    <link rel="alternate stylesheet" title="dark-code" type="text/css" href="/css/solarized_dark.css" disabled>
    <link rel="stylesheet" title="light-code" type="text/css" href="/css/github-gist.css" disabled>

    <!-- ENTERING partial seo-schema.html -->
    
    
    <script type="application/ld+json">
    {
        "@context" : "https://schema.org",
        "@type" : "Article",
        "publisher": {
            "@type": "Organization",
            "name": "csMACnz&#x27;s Blog",
            "logo": "https://blog.csmac.nz/content/images/2014/10/apple-touch-icon-144x144-precomposed.png"
        },
        "author": {
            "@type": "Person",
            "name": "Mark Clearwater",
            "image": {
                "@type": "ImageObject",
                "url": "//www.gravatar.com/avatar/c97410951ec3738a3fd4a2dfb17a5d9c?d=404&s=250",
                "width": 440,
                "height": 295
            },
            "url": "https://blog.csmac.nz/author/csmacnz/",
            "sameAs": [
                "http://csmac.nz"
            ]
        },
        "articleSection" : "post",
        "name" : "TeamCity, GitHub and Pull Requests",
        "headline" : "TeamCity, GitHub and Pull Requests",
        "url" : "https:\/\/csmacnzblog.github.io\/post\/teamcity-github-and-pull-requests\/",
        "datePublished": "2015-04-06T12:29:27.000Z",
        "dateModified" : "2015-04-06T12:29:27.000Z",
        "keywords" : [ "Continuous Delivery", "git", "TeamCity", "GitHub" ]
        "description" : "I\u0026rsquo;ve been having fun setting up TeamCity builds, specifically trying to run a static analysis build that shows it\u0026rsquo;s results on a pull request. This lead me to discover some issues with the built-in TeamCity support.\nIt is really easy to set up a build task that runs PowerShell as its build step. With this I can arbitrarily run code and get static analysis checking. It is even easy to push the results back to GitHub using the api (see the Statuses api on GitHub for just how easy).",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https://blog.csmac.nz/"
        }
        "inLanguage" : "en-US",
        "author" : "Mark Clearwater",
        "creator" : "Mark Clearwater",
        "accountablePerson" : "Mark Clearwater",
        "copyrightHolder" : "Mark Clearwater",
        "copyrightYear" : "2015",
        "wordCount" : "604",
    }
    </script>
    
    
    <!-- LEAVING partial seo-schema.html -->

    <link rel="alternate" type="application/rss+xml" title="csMACnz&#x27;s Blog" href="https://blog.csmac.nz/rss/" />
    <style>
        .post-content img {
            max-width: 500px;
        }
    </style>
    </head>
    <body class="blog">
        <div class="page-area"><header class="header-area">
    <h1 class="header-area-title">csMACnz</h1>
</header>
<nav class="navigation-area header-bar-parent">
    <div class="header-bar header-bar-blog">
        <ul class="menu">
            <li class="menu-item"><a class="menu-item-content" href="http://csmac.nz">Home</a></li>
            <li class="menu-item"><a class="menu-item-content" href="http://csmac.nz/BaconVaders">Bacon Vaders</a></li>
            <li class="menu-item"><a class="menu-item-content CurrentButton" href="/">Blog</a></li>
        </ul>
    </div>
</nav><div id="content" class="content-area">
            
<article>
    <div class="content-box" itemscope itemtype="http://schema.org/Article">
    
        <span class="post-meta"><time datetime="2015-04-06"  itemprop="datePublished">06 Apr 15</time> on
            <a href="https://csmacnzblog.github.iotags/continuous-delivery">Continuous Delivery</a><a href="https://csmacnzblog.github.iotags/git">git</a><a href="https://csmacnzblog.github.iotags/teamcity">TeamCity</a><a href="https://csmacnzblog.github.iotags/github">GitHub</a>
        </span>
    
        <h1 class="post-title" itemprop="headline">TeamCity, GitHub and Pull Requests</h1>
    
        <section class="post-content"  itemprop="articleBody">
            <p>I&rsquo;ve been having fun setting up TeamCity builds, specifically trying to run a static analysis build that shows it&rsquo;s results on a pull request. This lead me to discover some issues with the built-in TeamCity support.</p>
<p>It is really easy to set up a build task that runs PowerShell as its build step. With this I can arbitrarily run code and get static analysis checking. It is even easy to push the results back to GitHub using the api (see the <a href="https://developer.github.com/v3/repos/statuses/">Statuses api on GitHub</a> for just how easy). Again it is easy to trigger a build off of the &lsquo;special&rsquo; pull request branch github uses. A guide to getting all of these links working is <a href="http://blog.jetbrains.com/teamcity/2013/02/automatically-building-pull-requests-from-github-with-teamcity/">available on the teamcity blog</a>. But triggering the git source control checking on TeamCity turned out the be the hard bit.</p>
<p>There are Webhooks in GitHub. There are also Service Hooks. There is a <a href="https://github.com/github/github-services/blob/master/lib/services/teamcity.rb">TeamCity Service Hook</a>. Unfortunately there are issues with both that requires some third set of code to actually make it work. Here is why.</p>
<p>You would think that the existing team city hook would be exactly what you need. In the settings of your repository, you can configure this, with credentials, to either start a build, or just check for changes on the associated VCS Root. This check may actually trigger a build, depending on how your build triggers are set up.  The problem is that only the <strong>&ldquo;push&rdquo;</strong> event will trigger this service hook to fire off.  Why is this an issue for Pull Requests? Because creating a Pull Request creates the <strong>&ldquo;pull request&rdquo;</strong> event. This means that creating a pull request does not trigger a git check for changes, and so doesn&rsquo;t trigger the Pull Request to run the build, which won&rsquo;t publish the results back to the Pull Request.</p>
<p>Ok, lets try the custom Web Hooks. Still a no-go. GitHub Web Hooks are ultra flexible. There is <a href="https://developer.github.com/enterprise/2.1/webhooks/">great documentation</a> on setting up a Webhook. It event supports Secrets for signing, specifying specific events, and which format you want it to give you the information in.  But its a <strong>PUSH</strong>.  This means you need a particular endpoint that receives that push, and processes it&rsquo;s payload. There is nothing on TeamCity that matches that description.  You will have to write something to catch that response and trigger the behaviour you want to see happen.</p>
<p>Now don&rsquo;t get me wrong, this is exactly what you would expect. You need to determine what the business logic to respond to the event should be. But it means to solve my Pull Request problem, I now need to actually build and host this thing to make it all work.</p>
<p>So for anyone else wondering why the existing tutorials don&rsquo;t trigger your PR builds automatically, now you know why.  Enjoy building a middleman to make TeamCity do what you want as a result of what GitHub sends you :)  I suggest you read <a href="https://github.com/github/github-services/blob/master/lib/services/teamcity.rb">the implementation of the existing service</a> for some ideas of what your middleman might look like.  This was highlighted for us even more glaringly, since we only trigger a forced fetch on TeamCity every 24 hours, so it would only run my build on a PR if I manually triggered it (or someone else happened to accept a merge or push something directly to GitHub). I&rsquo;m sure this was also made worse by us always doing our Pull Requests between forks and trunk, so only on merging a PR would it trigger an update on TeamCity. And then there are the multiple VCS Roots, that updating one doesn&rsquo;t actually trigger all the related builds. Meh.</p>
</section>
        
        <section class="share">
            Share: 
            <a class="icon-twitter" href="http://twitter.com/share?text=TeamCity%2c%20GitHub%20and%20Pull%20Requests&url=https%3a%2f%2fcsmacnzblog.github.io%2fpost%2fteamcity-github-and-pull-requests%2f"
                onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
                <span>Twitter</span>
            </a>
            |
            <a class="icon-facebook" href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fcsmacnzblog.github.io%2fpost%2fteamcity-github-and-pull-requests%2f"
                onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
                <span>Facebook</span>
            </a>
        </section>
    </div>
    <div class="content-box">
        
        <div id="disqus_thread"></div>
        <script type="text/javascript">
            var disqus_shortname = d_id; 
            var disqus_title = 'TeamCity, GitHub and Pull Requests';
            
             
            (function() {
                var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
        <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    
    </div>
</article>

        </div><aside class="sidebar-area">
            <div class="header-bar-parent sidebar-item">
                <div class="header-bar header-bar-twitter">Twitter</div>
                
                <a class="twitter-timeline" style="display: block; text-align: center;" href="https://twitter.com/csmacnz" data-widget-id="523634688984772608">Tweets by @@csmacnz</a>
                <script>!function (d, s, id) { var js, fjs = d.getElementsByTagName(s)[0], p = /^http:/.test(d.location) ? 'http' : 'https'; if (!d.getElementById(id)) { js = d.createElement(s); js.id = id; js.src = p + "://platform.twitter.com/widgets.js"; fjs.parentNode.insertBefore(js, fjs); } }(document, "script", "twitter-wjs");</script>
                
            </div>
            <div class="header-bar-parent sidebar-item">
                <div class="header-bar header-bar-rss">Subscribe</div>
                
                <a class="email-subscribe-link" href="https://feedburner.google.com/fb/a/mailverify?uri=csmacnzBlog&amp;loc=en_US">Subscribe to csMACnz's Blog by Email</a>
                <a href="http://add.my.yahoo.com/rss?url=http://feeds.feedburner.com/csmacnzBlog" title="csMACnz&amp;#039;s Blog"><img src="http://us.i1.yimg.com/us.yimg.com/i/us/my/addtomyyahoo4.gif" alt="" style="border:0"/></a>
                <a href="http://feedly.com/#subscription/feed/http://feeds.feedburner.com/csmacnzBlog" title="csMACnz&amp;#039;s Blog"><img src="http://s3.feedly.com/feedburner/feedly.png" alt="" style="border:0"/></a>
                <a href="http://www.netvibes.com/subscribe.php?url=http://feeds.feedburner.com/csmacnzBlog"><img src="http://www.netvibes.com/img/add2netvibes.gif" width="91" height="17" alt="Add to netvibes" style="border:0" /></a>
                <a href="http://feeds.feedburner.com/csmacnzBlog"><img src="http://feeds.feedburner.com/~fc/csmacnzBlog?bg=fabb45&amp;fg=4B4B4B&amp;anim=1" height="26" width="88" style="border:0" alt="" /></a>
                <br />
                <a href="https://www.patreon.com/csMACnz" target="_blank"><img src="/images/patreon.png" /></a>
                
                
            </div>
            <div class="header-bar-parent sidebar-item">
                <div class="header-bar header-bar-xbox">Gamercard</div>
                

                <div style="margin: 0 auto; width:201px;">
                    <iframe src="//gamercard.xbox.com/csMACnz.card" scrolling="no" frameborder="0" height="136px" width="201px">AutomatonMan</iframe>
                </div>
                <a href="http://steamcommunity.com/id/csMACnz/" target="_blank"><img src="http://steamsignature.com/status/english/76561197994712512.png" alt="" title="csMACnz's Steam Profile" /></a>
                
            </div>
            <div class="header-bar-parent sidebar-item">
                <div class="header-bar header-bar-ads">Advertisement</div>
                
                <div>
                    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
                    
                    <ins class="adsbygoogle"
                         style="display:block"
                         data-ad-client="ca-pub-4517187877737982"
                         data-ad-slot="7632444699"
                         data-ad-format="auto"></ins>
                    <script>
                    (adsbygoogle = window.adsbygoogle || []).push({});
                    </script>
                </div>
                
            </div>
        </aside>
        
        <footer class="footer-area"><p>
    Designed and Maintained by Mark Clearwater; Last updated June 2015.
    <br /><a class="footer-link" >Hi</a>
</p></footer>
    </div>
    
    
    <script src="/js/highlight.pack.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    
    <script src="/js/codetoggle.js"></script> 

    
    <script>
        var _gaq = [['_setAccount', g_id], ['_trackPageview']];
        (function (d, t) {
            var g = d.createElement(t), s = d.getElementsByTagName(t)[0];
            g.src = ('https:' == location.protocol ? '//ssl' : '//www') + '.google-analytics.com/ga.js';
            s.parentNode.insertBefore(g, s);
        }(document, 'script'));
    </script>

    <script type="text/javascript" src="https://code.jquery.com/jquery-1.11.3.min.js"></script>
    </body>
</html>
