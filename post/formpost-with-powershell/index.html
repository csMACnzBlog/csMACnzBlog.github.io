<!DOCTYPE html>
<html lang="en">
    <head>

        <script>
            if(!/blog\.csmac\.nz/.test(window.location.host)) {
                window.location = "https:\/\/blog.csmac.nz\/post\/formpost-with-powershell\/";
            }
        </script>

        <meta charset="utf-8" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta name='author' content='Mark Clearwater, csmacnz@csmac.co.nz'>
        <meta name='language' content='EN'>
        <meta name='medium' content='blog'>

    
        <title>Form posts with PowerShell - csMACnz&#39;s Blog</title>
        <meta name="description" content="This article is based on an answer found and updated on StackOverflow. I&rsquo;f you have used PowerShell for much at all, you are probably familiar with Invoke-WebRequest. But did you know you can carry around a session …">
        <meta name='keywords' content='csMACnz, Tips and Tricks, PowerShell'>

        
        <meta property="og:type" content="article"/>
        <meta property="og:title" content="Form posts with PowerShell"/>
        <meta property="og:description" content="This article is based on an answer found and updated on StackOverflow. I&rsquo;f you have used PowerShell for much at all, you are probably familiar with Invoke-WebRequest. But did you know you can carry around a session …"/>
        <meta property="og:site_name" content="csMACnz&#39;s Blog"/>
        <meta property="og:url" content="https://blog.csmac.nz/post/formpost-with-powershell/"/>
        <meta property="og:image" content="https://csmac.nz/Content/icon/icon.png"/>

        
        <meta name="twitter:card" content="summary"/>
        <meta name="twitter:title" content="Form posts with PowerShell"/>
        <meta name="twitter:description" content="This article is based on an answer found and updated on StackOverflow. I&rsquo;f you have used PowerShell for much at all, you are probably familiar with Invoke-WebRequest. But did you know you can carry around a session …"/>
        <meta name="twitter:image" content="https://csmac.nz/Content/icon/icon.png"/>
        <meta name="twitter:site" content="@csMACnz"/>
        <meta name="twitter:creator" content="@csMACnz"/>
    

        <link rel="apple-touch-icon-precomposed" href="/images/icon/apple-touch-icon-precomposed.png">
        <link rel="apple-touch-icon-precomposed" sizes="72x72" href="/images/icon/apple-touch-icon-72x72-precomposed.png">
        <link rel="apple-touch-icon-precomposed" sizes="114x114" href="/images/icon/apple-touch-icon-114x114-precomposed.png">
        <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/images/icon/apple-touch-icon-144x144-precomposed.png">
        <link rel="icon" type="image/png" href="/images/icon/icon.png" />
        <link rel='me' type='text/html' href='https://github.com/csMACnz'>

        <script>
            var d_id  = 'csmacnz',
                g_id  = 'UA-18464866-2',
                g_url = 'auto';
        </script>

        <link rel="stylesheet" type="text/css" href="/css/style.css" />
        <link rel="stylesheet" type="text/css" href="/css/blogstyle.css" />

        <link rel="alternate stylesheet" title="dark-code" type="text/css" href="/css/solarized_dark.css" disabled>
        <link rel="stylesheet" title="light-code" type="text/css" href="/css/github-gist.css" disabled>

        <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4517187877737982"
        crossorigin="anonymous"></script>

        
        
        <script type="application/ld+json">
        {
            "@context" : "https://schema.org",
            "@type" : "Article",
            "publisher": {
                "@type": "Organization",
                "name": "csMACnz&#x27;s Blog",
                "logo": "https:\/\/blog.csmac.nz\/images\/icon\/apple-touch-icon-144x144-precomposed.png"
            },
            "author": {
                "@type": "Person",
                "name": "Mark Clearwater",
                "image": {
                    "@type": "ImageObject",
                    "url": "//www.gravatar.com/avatar/c97410951ec3738a3fd4a2dfb17a5d9c?d=404&s=250",
                    "width": 440,
                    "height": 295
                },
                "url": "https:\/\/blog.csmac.nz",
                "sameAs": [
                    "https://csmac.nz"
                ]
            },
            "articleSection" : "post",
            "name" : "Form posts with PowerShell",
            "headline" : "Form posts with PowerShell",
            "url" : "https:\/\/blog.csmac.nz\/post\/formpost-with-powershell\/",
            "datePublished": "2016-06-27T03:57:16.000Z",
            "dateModified" : "2016-06-27T03:57:16.000Z",
            "keywords" : [ "Tips and Tricks", "PowerShell" ]
            "description" : "This article is based on an answer found and updated on StackOverflow.\nI\u0026rsquo;f you have used PowerShell for much at all, you are probably familiar with Invoke-WebRequest. But did you know you can carry around a session and have it automatically add and update cookies for you?\nThe Scenario I had an API I wanted to consume, but it was a private one. That is, It was designed and used for a SPA app to consume.",
            "mainEntityOfPage": {
                "@type": "WebPage",
                "@id": "https:\/\/blog.csmac.nz"
            }
            "inLanguage" : "en-US",
            "author" : "Mark Clearwater",
            "creator" : "Mark Clearwater",
            "accountablePerson" : "Mark Clearwater",
            "copyrightHolder" : "Mark Clearwater",
            "copyrightYear" : "2016",
            "wordCount" : "510",
        }
        </script>
        
        
        
    </head>
    <body class="blog">
        <div class="page-area">

            <header class="header-area">
                <h1 class="header-area-title">csMACnz</h1>
            </header>
            <nav class="navigation-area header-bar-parent">
                <div class="header-bar header-bar-blog">
                    <ul class="menu">
                        <li class="menu-item"><a class="menu-item-content" href="https://csmac.nz">Home</a></li>
                        <li class="menu-item"><a class="menu-item-content" href="https://csmac.nz/BaconVaders">Bacon Vaders</a></li>
                        <li class="menu-item"><a class="menu-item-content CurrentButton" href="/">Blog</a></li>
                    </ul>
                </div>
            </nav>

            <div id="content" class="content-area">

<!--Page Content Begins-->

<article>
    <div class="content-box" itemscope itemtype=" https://schema.org/Article"><span class="post-meta"><time datetime="2016-06-27"  itemprop="datePublished">27 Jun 16</time> in <a href="/categories/software-engineering">Software Engineering</a> on <a href="/tags/tips-and-tricks">Tips and Tricks</a>,  <a href="/tags/powershell">PowerShell</a></span>
<h1 class="post-title" itemprop="headline">Form posts with PowerShell</h1>
    
        <section class="post-content"  itemprop="articleBody">
            <p>This article is based on an answer found and updated on <a href="http://stackoverflow.com/a/37729623/2118268">StackOverflow</a>.</p>
<p>I&rsquo;f you have used PowerShell for much at all, you are probably familiar with <code>Invoke-WebRequest</code>. But did you know you can carry around a session and have it automatically add and update cookies for you?</p>
<h3 id="the-scenario">The Scenario</h3>
<p>I had an API I wanted to consume, but it was a private one. That is, It was designed and used for a SPA app to consume. The auth for this API (for the write endpoints anyway) had two requirements: It authorised against cookies and required a csrf token in the requests.  Don&rsquo;t get hung up on the why or who wrote it, but my plan was to call it without having to change it.</p>
<h3 id="sessionvariable">SessionVariable</h3>
<p>It turns out that the command <code>Invoke-WebRequest</code> has an argument <code>-SessionVariable</code> where you can provide an object to store session state.  On subsequent requests, you can pass it along again using the argument <code>-WebSession</code>.</p>
<p>So we know how to store the session, how do we post a form? Well, clearly you get the page with the form on it, then post that form back. If you have a proper classic HTML page with a <code>Form</code> on it, you can do a <code>GET</code> to that page and use it by filling it out and executing the provided command.</p>
<pre tabindex="0"><code>$myUrl = &#34;http://mydomain.url&#34;  

$response = Invoke-WebRequest -Uri $myUrl -Method GET -SessionVariable mySession

$form = $response.Forms[0]
$form.Fields[&#34;username&#34;] = &#34;username&#34;
$form.Fields[&#34;password&#34;] = &#34;password&#34;

$response = Invoke-WebRequest -Uri ($myUrl + $form.Action) -WebSession $mySession -Method POST 
$response.StatusDescription #should be OK
</code></pre><p>You may have to check exactly what format <code>$form.Action</code> takes to see if it is absolute or relative URL, or if it includes the domain or not.</p>
<p>Also, check what your form fields are called. I have a mistake in mine where the field was called <code>user</code> rather than <code>username</code> on one page.</p>
<p>Note that in the first request when you use the <code>-SessionVariable</code> argument, you just provide the name of the variable, and not a variable itself. That is, use <code>mySession</code> rather than <code>$mySession</code>.</p>
<p>If you complete this correctly you should have all the correct cookies passed around. This means that both:</p>
<ol>
<li>The post will work if there is any cookie verification across the get and post and</li>
<li>The resulting <code>$mySession</code> will contain an authenticated cookie for further authenticated requests.</li>
</ol>
<h3 id="csrf">CSRF</h3>
<p>Part two is that I had to parse out csrf. I am still not sure why the requests require the csrf token, probably because it&rsquo;s a <a href="samnewman.io/patterns/architectural/bff/">BFF</a> API.</p>
<p>Luckily, the login form had a token in the original form, so I was able to just provide that in subsequent requests.</p>
<pre tabindex="0"><code>$payload = @{_csrf = $form.Fields[&#34;_csrf&#34;]; data = &#34;more data&#34;}
</code></pre><p>and then can just use the payload as normal:</p>
<pre tabindex="0"><code>$response = Invoke-WebRequest -Uri ($myUrl + $form.Action) -WebSession $mySession -Method POST -Body $payload
</code></pre><p>Of course, your mileage may vary. But this worked for me. The other option would have been to parse out the value from the page, from cookies, or actually, just fix the service to not need it I guess?</p>
</section>
        
        <section class="share">
            Share: 
            <a class="icon-twitter" href="https://twitter.com/share?text=Form%20posts%20with%20PowerShell&url=https%3a%2f%2fblog.csmac.nz%2fpost%2fformpost-with-powershell%2f"
                onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
                <span>Twitter</span>
            </a>
            |
            <a class="icon-facebook" href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fblog.csmac.nz%2fpost%2fformpost-with-powershell%2f"
                onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
                <span>Facebook</span>
            </a>
        </section>
    </div>
    <div class="content-box">
        
        <div id="disqus_thread"></div>
        <script type="text/javascript">
            var disqus_shortname = d_id; 
            var disqus_title = 'Form posts with PowerShell';
            
             
            (function() {
                var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
        <a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    
    </div>
</article>

<!--Page Content Ends-->

            </div><aside class="sidebar-area">

<!--Sidebar Content Begins-->

                <div class="header-bar-parent sidebar-item">
                    <div class="header-bar header-bar-twitter">Twitter</div>
                    
                    <a class="twitter-timeline" data-lang="en" data-height="510" data-dnt="true" href="https://twitter.com/csMACnz?ref_src=twsrc%5Etfw">Tweets by csMACnz</a> <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
                    
                </div>


                <div class="header-bar-parent sidebar-item">
                    <div class="header-bar header-bar-rss">Subscribe</div>
                    
                    <a href="/rssfeeds/" title="csMACnz's Blog">RSS Feeds</a>
                    <a href="https://feedly.com/i/subscription/feed%2Fhttps%3A%2F%2Ffeeds.feedburner.com%2FcsmacnzBlog" target="_blank" title="csMACnz&amp;#039;s Blog"><img src="https://s3.feedly.com/feedburner/feedly.png" alt="" style="border:0"/></a>
                    <a href="https://feeds.feedburner.com/csmacnzBlog" target="_blank"><img src="https://feeds.feedburner.com/~fc/csmacnzBlog?bg=fabb45&amp;fg=4B4B4B&amp;anim=1" height="26" width="88" style="border:0" alt="" /></a>
                    <br />
                    <a href="https://www.patreon.com/csMACnz" target="_blank"><img src="/images/patreon.png" /></a>
                    
                    
                </div>


                <div class="header-bar-parent sidebar-item">
                    <div class="header-bar header-bar-xbox">Gamercard</div>
                    

                    <div>
                        <a href="https://www.exophase.com/xbox/user/csMACnz/"><img width="288px" src="https://card.exophase.com/1/1476805.png"></a>
                        <a href="http://steamcommunity.com/id/csMACnz/" target="_blank"><img src="https://www.steamsignature.com/status/english/76561197994712512.png" alt="" title="csMACnz's Steam Profile" /></a>
                    </div>
                    
                </div>


                <div class="header-bar-parent sidebar-item">
                    <div class="header-bar header-bar-ads">Advertisement</div>
                    
                    <div>
                        
                        <ins class="adsbygoogle"
                            style="display:block"
                            data-ad-client="ca-pub-4517187877737982"
                            data-ad-slot="3618449993"
                            data-ad-format="auto"
                            data-full-width-responsive="true"></ins>
                        <script>
                            (adsbygoogle = window.adsbygoogle || []).push({});
                        </script>
                    </div>
                    
                </div>

<!--Sidebar Content Ends-->

            </aside>

            <footer class="footer-area">

            <p>
                Designed and Maintained by Mark Clearwater; Last updated August 2021.
                <!-- This used to be something useful, now it is just a hack I left it to make layout easier but also as a fun reminder for me of what it used to be -->
                <br /><a class="footer-link" >¯\_(ツ)_/¯</a>
            </p>

            </footer>
        </div>

<!--body scripts Begins-->

        
        <script src="/js/highlight.pack.js"></script>
        <script>hljs.initHighlightingOnLoad();</script>

        <script src="/js/codetoggle.js"></script> 

        
        <script>
            var _gaq = [['_setAccount', g_id], ['_trackPageview']];
            (function (d, t) {
                var g = d.createElement(t), s = d.getElementsByTagName(t)[0];
                g.src = ('https:' == location.protocol ? '//ssl' : '//www') + '.google-analytics.com/ga.js';
                s.parentNode.insertBefore(g, s);
            }(document, 'script'));
        </script>

        <script type="text/javascript" src="https://code.jquery.com/jquery-1.11.3.min.js"></script>

<!--body scripts Ends-->


<!-------------------------------->
<!--                            -->
<!--  _(\    |@@|               -->
<!-- (__/\__ \--/ __            -->
<!--    \___|----|  |   __      -->
<!--        \ }{ /\ )_ / _\     -->
<!--        /\__/\ \__O (__     -->
<!--       (--/\--)    \__/     -->
<!--       _)(  )(_             -->
<!--      `---''---`            -->
<!--                            -->
<!-- https://github.com/csMACnz -->
<!-------------------------------->

    </body>
</html>
