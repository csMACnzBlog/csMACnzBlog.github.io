<!DOCTYPE html>
<html lang="en">
    <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name='author' content='Mark Clearwater, csmacnz@csmac.co.nz'>
    <meta name='language' content='EN'>
    <meta name='medium' content='blog'>


    <title>Nullable and notnull Serialisation Properties - csMACnz&#39;s Blog</title>
    <meta name="description" content="The C# 8 feature Nullable has been well received by myself and others into our workflows and has improved code bases immensely.  However, there is one niggly workaround that I&rsquo;m not a fan of, and that is = …">
    <meta name='keywords' content='csMACnz, c#, dotnetcore, software development'>

    
    <meta property="og:type" content="article"/>
    <meta property="og:title" content="Nullable and notnull Serialisation Properties"/>
    <meta property="og:description" content="The C# 8 feature Nullable has been well received by myself and others into our workflows and has improved code bases immensely.  However, there is one niggly workaround that I&rsquo;m not a fan of, and that is = …"/>
    <meta property="og:site_name" content="csMACnz&#39;s Blog"/>
    <meta property="og:url" content="https://csmacnzblog.github.io/post/nullable-and-notnull-serialisation-properties/"/>
    <meta property="og:image" content="http://csmac.nz/Content/icon/icon.png"/>

    
    <meta name="twitter:card" content="summary"/>
    <meta name="twitter:title" content="Nullable and notnull Serialisation Properties"/>
    <meta name="twitter:description" content="The C# 8 feature Nullable has been well received by myself and others into our workflows and has improved code bases immensely.  However, there is one niggly workaround that I&rsquo;m not a fan of, and that is = …"/>
    <meta name="twitter:image" content="http://csmac.nz/Content/icon/icon.png"/>
    <meta name="twitter:site" content="@csMACnz"/>
    <meta name="twitter:creator" content="@csMACnz"/>


    <link rel="apple-touch-icon-precomposed" href="/images/icon/apple-touch-icon-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="72x72" href="/images/icon/apple-touch-icon-72x72-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="114x114" href="/images/icon/apple-touch-icon-114x114-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/images/icon/apple-touch-icon-144x144-precomposed.png">
    <link rel="icon" type="image/png" href="/images/icon/icon.png" />
    <link rel='me' type='text/html' href='https://github.com/csMACnz'>

    <script>
        var d_id  = 'csmacnz',
            g_id  = 'UA-18464866-2',
            g_url = 'auto';
    </script>

    <link rel="stylesheet" type="text/css" href="/css/style.css" />
    <link rel="stylesheet" type="text/css" href="/css/blogstyle.css" />

    <link rel="alternate stylesheet" title="dark-code" type="text/css" href="/css/solarized_dark.css" disabled>
    <link rel="stylesheet" title="light-code" type="text/css" href="/css/github-gist.css" disabled>

    <!-- ENTERING partial seo-schema.html -->
    
    
    <script type="application/ld+json">
    {
        "@context" : "https://schema.org",
        "@type" : "Article",
        "publisher": {
            "@type": "Organization",
            "name": "csMACnz&#x27;s Blog",
            "logo": "https://blog.csmac.nz/content/images/2014/10/apple-touch-icon-144x144-precomposed.png"
        },
        "author": {
            "@type": "Person",
            "name": "Mark Clearwater",
            "image": {
                "@type": "ImageObject",
                "url": "//www.gravatar.com/avatar/c97410951ec3738a3fd4a2dfb17a5d9c?d=404&s=250",
                "width": 440,
                "height": 295
            },
            "url": "https://blog.csmac.nz/author/csmacnz/",
            "sameAs": [
                "http://csmac.nz"
            ]
        },
        "articleSection" : "post",
        "name" : "Nullable and notnull Serialisation Properties",
        "headline" : "Nullable and notnull Serialisation Properties",
        "url" : "https:\/\/csmacnzblog.github.io\/post\/nullable-and-notnull-serialisation-properties\/",
        "datePublished": "2020-07-26T02:00:00.000Z",
        "dateModified" : "2020-07-26T02:00:00.000Z",
        "image" : {
            "@type": "ImageObject",
            "url": "https:\/\/images.unsplash.com\/photo-1523318140688-03662c0cba35?ixlib=rb-1.2.1\u0026q=80\u0026fm=jpg\u0026crop=entropy\u0026cs=tinysrgb\u0026w=1080\u0026fit=max\u0026ixid=eyJhcHBfaWQiOjE2ODI3fQ",
            "width": 440,
            "height": 295
        },
        "keywords" : [ "c#", "dotnetcore", "software development" ]
        "description" : "The C# 8 feature Nullable has been well received by myself and others into our workflows and has improved code bases immensely. However, there is one niggly workaround that I\u0026rsquo;m not a fan of, and that is = default!;\nproblem definition \/\/ This class is used to serialise\/deserialise a payload from a server\rpublic class MyContractDTO\r{\rpublic string Value { get; set; } = default!;\r}\r My codebase is now littered with this code hack to get it to compile because nullable says it can\u0026rsquo;t guarantee that this property is not null.",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https://blog.csmac.nz/"
        }
        "inLanguage" : "en-US",
        "author" : "Mark Clearwater",
        "creator" : "Mark Clearwater",
        "accountablePerson" : "Mark Clearwater",
        "copyrightHolder" : "Mark Clearwater",
        "copyrightYear" : "2020",
        "wordCount" : "1330",
    }
    </script>
    
    
    <!-- LEAVING partial seo-schema.html -->

    <link rel="alternate" type="application/rss+xml" title="csMACnz&#x27;s Blog" href="https://blog.csmac.nz/rss/" />
    <style>
        .post-content img {
            max-width: 500px;
        }
    </style>
    </head>
    <body class="blog">
        <div class="page-area"><header class="header-area">
    <h1 class="header-area-title">csMACnz</h1>
</header>
<nav class="navigation-area header-bar-parent">
    <div class="header-bar header-bar-blog">
        <ul class="menu">
            <li class="menu-item"><a class="menu-item-content" href="http://csmac.nz">Home</a></li>
            <li class="menu-item"><a class="menu-item-content" href="http://csmac.nz/BaconVaders">Bacon Vaders</a></li>
            <li class="menu-item"><a class="menu-item-content CurrentButton" href="/">Blog</a></li>
        </ul>
    </div>
</nav><div id="content" class="content-area">
            
<article>
    <div class="content-box" itemscope itemtype="http://schema.org/Article">
    
        <span class="post-meta"><time datetime="2020-07-26"  itemprop="datePublished">26 Jul 20</time> on
            <a href="https://csmacnzblog.github.iotags/c">c#</a><a href="https://csmacnzblog.github.iotags/dotnetcore">dotnetcore</a><a href="https://csmacnzblog.github.iotags/software-development">software development</a>
        </span>
    
        <h1 class="post-title" itemprop="headline">Nullable and notnull Serialisation Properties</h1>
    
        <section class="post-content"  itemprop="articleBody">
            <img class="post-image" src="https://images.unsplash.com/photo-1523318140688-03662c0cba35?ixlib=rb-1.2.1&amp;q=80&amp;fm=jpg&amp;crop=entropy&amp;cs=tinysrgb&amp;w=1080&amp;fit=max&amp;ixid=eyJhcHBfaWQiOjE2ODI3fQ"><p>The C# 8 feature Nullable has been well received by myself and others into our workflows and has improved code bases immensely.  However, there is one niggly workaround that I&rsquo;m not a fan of, and that is <code>= default!;</code></p>
<h2 id="problem-definition">problem definition</h2>
<pre><code class="language-cs">// This class is used to serialise/deserialise a payload from a server
public class MyContractDTO
{
    public string Value { get; set; } = default!;
}
</code></pre>
<p>My codebase is now littered with this code hack to get it to compile because nullable says it can&rsquo;t guarantee that this property is not null.</p>
<p>Let&rsquo;s take a closer look at what we are saying.</p>
<pre><code class="language-cs">
// With the Nullable feature enabled, I need to ensure Value is not null:
// - either in the constructor from a notnull argument
// - or giving it a default non-null value.
public string Value { get; set; }

// Initialise the property to its default value (which for reference types like string is null)
public string Value { get; set; } = default;

// The '!' says to treat the value as if it is notnull, the developer knows better
public string Value { get; set; } = default!;
</code></pre>
<p>What does this achieve? Well, the compiler ignores the fact that it could be null, and we initialise it to be null. This is a contradiction if ever I saw one, and I don&rsquo;t like it.</p>
<h2 id="normal-solutions">Normal solutions</h2>
<p>There are two solution paths to take here:</p>
<ul>
<li>Acknowledge that it might be null and make it nullable.</li>
<li>Initialise in the constructor.</li>
</ul>
<p>These work great with normal codebases and in some cases, one is better than the other.  If you know it certainly can be null, use the first option. If you know you never expect or want it to be null, use the second.</p>
<p>Bonus points once you have the constructor is to make the type immutable.
For all domain and application logic, This is what I have done successfully so far and will continue doing.</p>
<h2 id="but-serialisation">But serialisation</h2>
<p>Here is the problem. Serialisation.</p>
<p>When we have a type that is going to be used to deserialise transport models we again have the same choices as above, but a few more points to consider.</p>
<ul>
<li>The JSON may or may not include the field</li>
<li>The JSON may have the field set to null</li>
<li>The Deserialiser might not support constructors</li>
<li>The Deserialiser doesn&rsquo;t know about Nullable and can&rsquo;t ensure the safety is upheld.</li>
</ul>
<p>Again we can make the call to acknowledge that it might be null and make it nullable.  But there are drawbacks here. If you do this, you have to add all the error-handling for dealing with nullable checks. And if you control both server and client in this situation, then you might be writing and testing code for something you never plan to, nor may never need to ever support. Being null is an exceptional/fatal situation you don&rsquo;t want to have to constantly guard against.</p>
<p>Which leads us back to the de-facto solution currently being advocated and used:</p>
<pre><code class="language-cs">public string Value { get; set; } = default!;
</code></pre>
<p>I&rsquo;m still not happy. So why don&rsquo;t we work on that?</p>
<h2 id="the-json-may-or-may-not-include-the-field-or-it-might-be-null">The JSON may or may not include the field or it might be null</h2>
<p>Luckily for us, this concern is fairly easy to address. Say we are using Newtonsoft.Json and want this extra piece of reassurance.</p>
<pre><code class="language-cs">[JsonProperty(Required = Required.Always)]
public string Value { get; set; } = default!;
</code></pre>
<p>The <code>Required</code> attribute annotation is designed for exactly this situation. When we use Newtonsoft.Json as our deserialiser, we can get a <code>JsonSerializationException</code> for free.</p>
<p>This ensures we:</p>
<ul>
<li>have minimal code doing the null checking</li>
<li>don&rsquo;t have to guard every access to a nullable property</li>
<li>Treat null or missing as fatal errors as part of an existing serialisation error handling process (which we should always have anyway).</li>
</ul>
<p>This still doesn&rsquo;t stop any other piece of code from creating an invalid object state, though. But this may be the easiest solution to add those missing guarantees alongside using <code>default!</code>.</p>
<h2 id="use-constructors">Use Constructors</h2>
<p>Newtonsoft.Json helps once again by supporting constructors. Make sure all the mandatory non-nullable properties are in the constructor. And as long as there is no default constructor (which when doing nullable right you can&rsquo;t anyway) and the constructor parameters have names matching the properties, this just works as expected.</p>
<pre><code>public class MyContractDTO
{
    public MyContractDTO(string value)
    {
        if(value is null) throw new ArgumentNullException(nameof(value));
        Value = value;
    }
    
    public string Value { get; set; };
}
</code></pre>
<p>You do however have to write your null-guard into the constructor to ensure it fails with an appropriate error message. Without this, null might still sneak through, even if you annotate the property.</p>
<p>Once more, Newtonsoft.Json with constructors also means support for read-only (immutable) objects.</p>
<h2 id="what-about-not-using-newtonsoftjson">What about not using Newtonsoft.Json?</h2>
<p>There is a new kid on the block - <code>System.Text.Json</code>. However, this is one area where it doesn&rsquo;t shine so bright compared to Newtonsoft.Json.</p>
<p>Pretty much none of the above works. Constructors are not supported. Required annotation is not supported. Along with many other things.</p>
<p>More on <a href="https://docs.microsoft.com/en-us/dotnet/standard/serialization/system-text-json-migrate-from-newtonsoft-how-to">what does and does not translate across from Newtonsoft.Json is documented here</a>.</p>
<p>Instead, you will need to write your own converter and manually deserialise your object with your own explicit null checks (which could be done inside the constructor).</p>
<p>For example, given our simple type above, we might do the following:</p>
<pre><code class="language-cs">[System.Text.Json.Serialization.JsonConverter(typeof(MyContractDTOConverter))]
public class MyContractDTO
{
    public MyContractDTO(string value)
    {
        if (value is null) throw new ArgumentNullException(nameof(value));
        Value = value;
    }
    
    public string Value { get; }
}

// Made using the examples given at https://docs.microsoft.com/en-us/dotnet/standard/serialization/system-text-json-migrate-from-newtonsoft-how-to#required-properties
// Your decisions may vary.
// e.g. this only supports {&quot;value&quot;: &quot;...&quot;} format, no extra properties allowed.
// For a more complex object, you would probably be more flexible.
// Better guides here: https://docs.microsoft.com/en-us/dotnet/standard/serialization/system-text-json-converters-how-to
public class MyContractDTOConverter : JsonConverter&lt;MyContractDTO&gt;
{
    private readonly JsonEncodedText ValueName = JsonEncodedText.Encode(&quot;value&quot;);

    public override Implementation Read(
        ref Utf8JsonReader reader,
        Type typeToConvert,
        JsonSerializerOptions options)
    {
        if (reader.TokenType != JsonTokenType.StartObject)
        {
            throw new JsonException();
        };

        string? value = default;

        reader.Read();
        // One property must exist
        if (reader.TokenType != JsonTokenType.PropertyName)
        {
            throw new JsonException();
        }

        // That property must have the right name
        if (reader.ValueTextEquals(ValueName.EncodedUtf8Bytes))
        {
            value = ReadProperty(ref reader, options);
        }
        else
        {
            throw new JsonException();
        }

        reader.Read();
        // There must be no other properties
        if (reader.TokenType != JsonTokenType.EndObject)
        {
            throw new JsonException();
        }

        return new MyContractDTO(value);
    }

    private string ReadProperty(ref Utf8JsonReader reader, JsonSerializerOptions options)
    {
        Debug.Assert(reader.TokenType == JsonTokenType.PropertyName);

        reader.Read();

        return reader.GetString();
    }

    private void WriteProperty(Utf8JsonWriter writer, JsonEncodedText name, string stringValue, JsonSerializerOptions options)
    {
        writer.WritePropertyName(name);
        writer.WriteStringValue(stringValue);
    }

    public override void Write(
        Utf8JsonWriter writer,
        Implementation implementation,
        JsonSerializerOptions options)
    {
        writer.WriteStartObject();
        WriteProperty(writer, ValueName, implementation.Value, options);
        writer.WriteEndObject();
    }
}
</code></pre>
<p>At which point you now have a bunch more code and logic to look after, but can achieve the same/similar results to what Newtonsoft.Json could do. Depending on your situation, maintaining this code may be more effort than declaring it nullable and maintaining checks around that in consuming code. Up to you.</p>
<h2 id="decisions-decisions">Decisions, Decisions</h2>
<p>So what would I recommend?</p>
<p>Firstly, don&rsquo;t just use <code>default!</code> on your serialised types.</p>
<p>For maximum effect, make your classes have constructors for notnull values, and maybe even make your properties Immutable, if that makes sense. Have your constructors guard against nulls so that your compile-time assurances have runtime verifications. Especially is this is a client library you provide to others.</p>
<p>If you are using Newtonsoft.Json you should at least apply the <code>[JsonProperty(Required = Required.Always)]</code> to all your notnull properties. But add the constructors as well because you can. If you can stick with Newtonsoft.Json, your life will be very easy.</p>
<p>If you are using (or have to use) System.Text.Json, write custom converters for your types so that you can have those constructors mentioned above. Make sure you keep them flexible enough to ignore any extra properties you might add in the future to avoid breaking backwards compatibility.</p>
<p>This experiment has a companion GitHub repo of tests (a mixture of proof they work, and proof they fail tests) <a href="https://github.com/csMacnzBlog/NullableSerialisationExperiments">available here</a>.</p>
<p>Happy Null-Hunting.</p>
</section>
        
        <section class="share">
            Share: 
            <a class="icon-twitter" href="http://twitter.com/share?text=Nullable%20and%20notnull%20Serialisation%20Properties&url=https%3a%2f%2fcsmacnzblog.github.io%2fpost%2fnullable-and-notnull-serialisation-properties%2f"
                onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
                <span>Twitter</span>
            </a>
            |
            <a class="icon-facebook" href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fcsmacnzblog.github.io%2fpost%2fnullable-and-notnull-serialisation-properties%2f"
                onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
                <span>Facebook</span>
            </a>
        </section>
    </div>
    <div class="content-box">
        
        <div id="disqus_thread"></div>
        <script type="text/javascript">
            var disqus_shortname = d_id; 
            var disqus_title = 'Nullable and notnull Serialisation Properties';
            
             
            (function() {
                var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
        <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    
    </div>
</article>

        </div><aside class="sidebar-area">
            <div class="header-bar-parent sidebar-item">
                <div class="header-bar header-bar-twitter">Twitter</div>
                
                <a class="twitter-timeline" style="display: block; text-align: center;" href="https://twitter.com/csmacnz" data-widget-id="523634688984772608">Tweets by @@csmacnz</a>
                <script>!function (d, s, id) { var js, fjs = d.getElementsByTagName(s)[0], p = /^http:/.test(d.location) ? 'http' : 'https'; if (!d.getElementById(id)) { js = d.createElement(s); js.id = id; js.src = p + "://platform.twitter.com/widgets.js"; fjs.parentNode.insertBefore(js, fjs); } }(document, "script", "twitter-wjs");</script>
                
            </div>
            <div class="header-bar-parent sidebar-item">
                <div class="header-bar header-bar-rss">Subscribe</div>
                
                <a class="email-subscribe-link" href="https://feedburner.google.com/fb/a/mailverify?uri=csmacnzBlog&amp;loc=en_US">Subscribe to csMACnz's Blog by Email</a>
                <a href="http://add.my.yahoo.com/rss?url=http://feeds.feedburner.com/csmacnzBlog" title="csMACnz&amp;#039;s Blog"><img src="http://us.i1.yimg.com/us.yimg.com/i/us/my/addtomyyahoo4.gif" alt="" style="border:0"/></a>
                <a href="http://feedly.com/#subscription/feed/http://feeds.feedburner.com/csmacnzBlog" title="csMACnz&amp;#039;s Blog"><img src="http://s3.feedly.com/feedburner/feedly.png" alt="" style="border:0"/></a>
                <a href="http://www.netvibes.com/subscribe.php?url=http://feeds.feedburner.com/csmacnzBlog"><img src="http://www.netvibes.com/img/add2netvibes.gif" width="91" height="17" alt="Add to netvibes" style="border:0" /></a>
                <a href="http://feeds.feedburner.com/csmacnzBlog"><img src="http://feeds.feedburner.com/~fc/csmacnzBlog?bg=fabb45&amp;fg=4B4B4B&amp;anim=1" height="26" width="88" style="border:0" alt="" /></a>
                <br />
                <a href="https://www.patreon.com/csMACnz" target="_blank"><img src="/images/patreon.png" /></a>
                
                
            </div>
            <div class="header-bar-parent sidebar-item">
                <div class="header-bar header-bar-xbox">Gamercard</div>
                

                <div style="margin: 0 auto; width:201px;">
                    <iframe src="//gamercard.xbox.com/csMACnz.card" scrolling="no" frameborder="0" height="136px" width="201px">AutomatonMan</iframe>
                </div>
                <a href="http://steamcommunity.com/id/csMACnz/" target="_blank"><img src="http://steamsignature.com/status/english/76561197994712512.png" alt="" title="csMACnz's Steam Profile" /></a>
                
            </div>
            <div class="header-bar-parent sidebar-item">
                <div class="header-bar header-bar-ads">Advertisement</div>
                
                <div>
                    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
                    
                    <ins class="adsbygoogle"
                         style="display:block"
                         data-ad-client="ca-pub-4517187877737982"
                         data-ad-slot="7632444699"
                         data-ad-format="auto"></ins>
                    <script>
                    (adsbygoogle = window.adsbygoogle || []).push({});
                    </script>
                </div>
                
            </div>
        </aside>
        
        <footer class="footer-area"><p>
    Designed and Maintained by Mark Clearwater; Last updated June 2015.
    <br /><a class="footer-link" >Hi</a>
</p></footer>
    </div>
    
    
    <script src="/js/highlight.pack.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    
    <script src="/js/codetoggle.js"></script> 

    
    <script>
        var _gaq = [['_setAccount', g_id], ['_trackPageview']];
        (function (d, t) {
            var g = d.createElement(t), s = d.getElementsByTagName(t)[0];
            g.src = ('https:' == location.protocol ? '//ssl' : '//www') + '.google-analytics.com/ga.js';
            s.parentNode.insertBefore(g, s);
        }(document, 'script'));
    </script>

    <script type="text/javascript" src="https://code.jquery.com/jquery-1.11.3.min.js"></script>
    </body>
</html>
