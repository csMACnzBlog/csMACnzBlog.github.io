<!DOCTYPE html>
<html lang="en">
    <head>

        <meta charset="utf-8" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta name='author' content='Mark Clearwater, csmacnz@csmac.co.nz'>
        <meta name='language' content='EN'>
        <meta name='medium' content='blog'>

    
        <title>HostBuild your dotnet Consoles like you WebHostBuild your web apps. - csMACnz&#39;s Blog</title>
        <meta name="description" content="I wrote a while back on getting your Windows Services building with .Net Core which is a nice way to use the new SDK pipeline but still host on Windows without much fuss. But what If you like the approach but want to run …">
        <meta name='keywords' content='csMACnz, dotnetcore, Tips and Tricks'>

        
        <meta property="og:type" content="article"/>
        <meta property="og:title" content="HostBuild your dotnet Consoles like you WebHostBuild your web apps."/>
        <meta property="og:description" content="I wrote a while back on getting your Windows Services building with .Net Core which is a nice way to use the new SDK pipeline but still host on Windows without much fuss. But what If you like the approach but want to run …"/>
        <meta property="og:site_name" content="csMACnz&#39;s Blog"/>
        <meta property="og:url" content="https://blogmigration.csmac.nz/post/hostbuild-your-dotnet-consoles-like-you-webhostbuild-your-web-apps/"/>
        <meta property="og:image" content="http://csmac.nz/Content/icon/icon.png"/>

        
        <meta name="twitter:card" content="summary"/>
        <meta name="twitter:title" content="HostBuild your dotnet Consoles like you WebHostBuild your web apps."/>
        <meta name="twitter:description" content="I wrote a while back on getting your Windows Services building with .Net Core which is a nice way to use the new SDK pipeline but still host on Windows without much fuss. But what If you like the approach but want to run …"/>
        <meta name="twitter:image" content="http://csmac.nz/Content/icon/icon.png"/>
        <meta name="twitter:site" content="@csMACnz"/>
        <meta name="twitter:creator" content="@csMACnz"/>
    

        <link rel="apple-touch-icon-precomposed" href="/images/icon/apple-touch-icon-precomposed.png">
        <link rel="apple-touch-icon-precomposed" sizes="72x72" href="/images/icon/apple-touch-icon-72x72-precomposed.png">
        <link rel="apple-touch-icon-precomposed" sizes="114x114" href="/images/icon/apple-touch-icon-114x114-precomposed.png">
        <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/images/icon/apple-touch-icon-144x144-precomposed.png">
        <link rel="icon" type="image/png" href="/images/icon/icon.png" />
        <link rel='me' type='text/html' href='https://github.com/csMACnz'>

        <script>
            var d_id  = 'csmacnz',
                g_id  = 'UA-18464866-2',
                g_url = 'auto';
        </script>

        <link rel="stylesheet" type="text/css" href="/css/style.css" />
        <link rel="stylesheet" type="text/css" href="/css/blogstyle.css" />

        <link rel="alternate stylesheet" title="dark-code" type="text/css" href="/css/solarized_dark.css" disabled>
        <link rel="stylesheet" title="light-code" type="text/css" href="/css/github-gist.css" disabled>

        
        
        <script type="application/ld+json">
        {
            "@context" : "https://schema.org",
            "@type" : "Article",
            "publisher": {
                "@type": "Organization",
                "name": "csMACnz&#x27;s Blog",
                "logo": "https:\/\/blogmigration.csmac.nz\/images\/icon\/apple-touch-icon-144x144-precomposed.png"
            },
            "author": {
                "@type": "Person",
                "name": "Mark Clearwater",
                "image": {
                    "@type": "ImageObject",
                    "url": "//www.gravatar.com/avatar/c97410951ec3738a3fd4a2dfb17a5d9c?d=404&s=250",
                    "width": 440,
                    "height": 295
                },
                "url": "https:\/\/blogmigration.csmac.nz",
                "sameAs": [
                    "http://csmac.nz"
                ]
            },
            "articleSection" : "post",
            "name" : "HostBuild your dotnet Consoles like you WebHostBuild your web apps.",
            "headline" : "HostBuild your dotnet Consoles like you WebHostBuild your web apps.",
            "url" : "https:\/\/blogmigration.csmac.nz\/post\/hostbuild-your-dotnet-consoles-like-you-webhostbuild-your-web-apps\/",
            "datePublished": "2018-09-17T06:00:00.000Z",
            "dateModified" : "2018-09-17T06:00:00.000Z",
            "image" : {
                "@type": "ImageObject",
                "url": "https:\/\/images.unsplash.com\/photo-1527199768775-bdabf8b32f61?ixlib=rb-0.3.5\u0026q=80\u0026fm=jpg\u0026crop=entropy\u0026cs=tinysrgb\u0026w=1080\u0026fit=max\u0026ixid=eyJhcHBfaWQiOjE2ODI3fQ\u0026s=b5237392bd0cf0bbef603d083decfa20",
                "width": 440,
                "height": 295
            },
            "keywords" : [ "dotnetcore", "Tips and Tricks" ]
            "description" : "I wrote a while back on getting your Windows Services building with .Net Core which is a nice way to use the new SDK pipeline but still host on Windows without much fuss.\nBut what If you like the approach but want to run on Linux?\nWell after some stumbling around in the dotnet core docs, I found information about HostBuilder, which looks a lot like the WebHostBuilder and WebHost that we use with AspNetCore.",
            "mainEntityOfPage": {
                "@type": "WebPage",
                "@id": "https:\/\/blogmigration.csmac.nz"
            }
            "inLanguage" : "en-US",
            "author" : "Mark Clearwater",
            "creator" : "Mark Clearwater",
            "accountablePerson" : "Mark Clearwater",
            "copyrightHolder" : "Mark Clearwater",
            "copyrightYear" : "2018",
            "wordCount" : "887",
        }
        </script>
        
        
        
    </head>
    <body class="blog">
        <div class="page-area">

            <header class="header-area">
                <h1 class="header-area-title">csMACnz</h1>
            </header>
            <nav class="navigation-area header-bar-parent">
                <div class="header-bar header-bar-blog">
                    <ul class="menu">
                        <li class="menu-item"><a class="menu-item-content" href="http://csmac.nz">Home</a></li>
                        <li class="menu-item"><a class="menu-item-content" href="http://csmac.nz/BaconVaders">Bacon Vaders</a></li>
                        <li class="menu-item"><a class="menu-item-content CurrentButton" href="/">Blog</a></li>
                    </ul>
                </div>
            </nav>

            <div id="content" class="content-area">

<!--Page Content Begins-->

<article>
    <div class="content-box" itemscope itemtype="http://schema.org/Article">
    
        <span class="post-meta"><time datetime="2018-09-17"  itemprop="datePublished">17 Sep 18</time> on <a href="/tags/dotnetcore">dotnetcore</a>,  <a href="/tags/tips-and-tricks">Tips and Tricks</a></span>
    
        <h1 class="post-title" itemprop="headline">HostBuild your dotnet Consoles like you WebHostBuild your web apps.</h1>
    
        <section class="post-content"  itemprop="articleBody">
            <img class="post-image" src="https://images.unsplash.com/photo-1527199768775-bdabf8b32f61?ixlib=rb-0.3.5&amp;q=80&amp;fm=jpg&amp;crop=entropy&amp;cs=tinysrgb&amp;w=1080&amp;fit=max&amp;ixid=eyJhcHBfaWQiOjE2ODI3fQ&amp;s=b5237392bd0cf0bbef603d083decfa20"><p>I wrote a while back on getting your <a href="https://blog.csmac.nz/a-windows-service-on-dotnet/">Windows Services building with .Net Core</a> which is a nice way to use the new SDK pipeline but still host on Windows without much fuss.</p>
<p>But what If you like the approach but want to run on Linux?</p>
<p>Well after some stumbling around in the dotnet core docs, I found information about <code>HostBuilder</code>, which looks a lot like the <code>WebHostBuilder</code> and <code>WebHost</code> that we use with AspNetCore.  And that is no accident.</p>
<p>This new set of classes is a new feature from dotnet core 2.1:</p>
<blockquote>
<p>The Generic Host is new in ASP<!-- raw HTML omitted --><!-- raw HTML omitted -->.NET Core 2.1 and isn&rsquo;t suitable for web hosting scenarios. For web hosting scenarios, use the Web Host. The Generic Host is under development to replace the Web Host in a future release and act as the primary host API in both HTTP and non-HTTP scenarios. - <a href="https://docs.microsoft.com/en-us/aspnet/core/fundamentals/host/generic-host?view=aspnetcore-2.1">microsoft docs</a></p>
</blockquote>
<p>If you are used to the WebHostBuilder (<code>WebHost.CreateWebHostBuilder(args).Build().Run();</code>) then you will find the contracts for this very similar.  Let&rsquo;s look at an example of what a console app using this new library might look like.</p>
<p>Like last time, we will use this simple application that will sleep for 1 second, then try to generate the next number in the Fibonacci Sequence and print it out.</p>
<pre><code class="language-cs">using System;
using System.Threading;
using System.Threading.Tasks;

namespace MyApp
{
    public class MyApp
    {
        private static readonly AutoResetEvent _closeRequested = new AutoResetEvent(false);
        private long _last = 0;
        private long _current = 0;
        private Task _work;

        public MyApp()
        {
        }

        public void Start()
        {
            _work = Task.Run(() =&gt; DoWorkLoop());
        }

        public void Stop()
        {
            _closeRequested.Set();
            if (_work != null)
            {
                _work.Wait();
                _work = null;
            }
        }

        public void DoWorkLoop()
        {
            while (!_closeRequested.WaitOne(1000))
            {
                var last = _current;
                var next = _last + _current;
                if (next == 0)
                {
                    next = 1;
                }
                _last = _current;
                _current = next;
                Console.WriteLine(next);
            }
        }
    }
}
</code></pre>
<p>So how can we use this hosted in the new <code>HostBuilder</code>?</p>
<p>First, we have to use the new <code>IHostedService</code> interface:</p>
<pre><code>public interface IHostedService
{
    // Called when the host is ready to start the service
    Task StartAsync(CancellationToken cancellationToken);

    // Called on graceful shutdown by the host
    Task StopAsync(CancellationToken cancellationToken);
}
</code></pre>
<p>Notice the interface uses <code>CancellationToken</code>. This is called when the host needs to cancel the action (such as termination of the application during startup, or if you take too long during shutdown).</p>
<p>Our app class can be modified to meet these requirements:</p>
<pre><code class="language-cs">public class MyApp : IHostedService
{
    private static readonly AutoResetEvent _closeRequested = new AutoResetEvent(false);
    ...
    private Task _work;

    Task StartAsync(CancellationToken cancellationToken)
    {
        _work = Task.Run(() =&gt; DoWorkLoop());
        return Task.CompletedTask;
    }

    Task StopAsync(CancellationToken cancellationToken)
    {
        _closeRequested.Set();
        if (_work != null)
        {
            _task.Wait(cancellationToken);
            _work.Dispose();
            _work = null;
        }

        return Task.CompletedTask;
    }

    public void DoWorkLoop()
    {
        ...
    }
}
</code></pre>
<p>Now we meet the expected interface, we can build our startup code like so:</p>
<pre><code class="language-cs">public static class Program
{
    public static async Task Main(string[] args)
    {
        await new HostBuilder()
            .UseHostedService&lt;MyApp&gt;()
            .RunConsoleAsync();
    }
}
</code></pre>
<p>This is basically the minimum to get this working. But there is so much more you can do now you have a host builder.</p>
<p>Let&rsquo;s break this down into what those extensions are actually doing for you. The above is essentially equivalent to this:</p>
<pre><code class="language-cs">var host = new HostBuilder()
    .ConfigureServices(services =&gt;
        services.AddHostedService&lt;MyApp&gt;())
    .UseConsoleLifetime()
    .Build();

using (host)
{
    await host.StartAsync();

    await host.WaitForShutdownAsync();
}
</code></pre>
<p><code>UseConsoleLifetime</code>, which is used by <code>RunConsoleAsync()</code> internally, waits for Ctrl+C/SIGINT or SIGTERM commands from the OS (windows mac and Linux where applicable) to make the application compatible with graceful shutdown scenarios.</p>
<p><code>RunConsoleAsync()</code> also bootstraps the <code>Start</code> and <code>WaitForShutdown</code> usage, making it a really handy helper function to know and use.</p>
<p><code>ConfigureServices</code> is identical to that you are familiar with on the WebHostBuilder, and Startup classes.  This is your <code>ServiceCollection</code> where you can register dependencies. That&rsquo;s right, this has AspNetCore&rsquo;s Dependency Resolution structure.  <code>AddHostedService</code> is just a shorthand to register you class as an implementation of <code>IHostedService</code> that the Generic <em>Host</em> can later resolve to start and stop for you.</p>
<p>While talking about <code>AddHostedService</code>, I should mention you can have as many <code>IHostedService</code> instances registered that you want to have running. Multiple worker processes hosted in one app essentially.</p>
<p>Let&rsquo;s talk about configuration.</p>
<p>AspNetCore introduced the <code>IConfiguration</code> and the <code>appsettings.json</code> files.  I&rsquo;ve found that adding the following code gives you a very similar experience:</p>
<pre><code class="language-cs">new HostBuilder()
   .UseEnvironment(Environment.GetEnvironmentVariable(&quot;ASPNETCORE_ENVIRONMENT&quot;))
    .ConfigureAppConfiguration((hostContext, configApp) =&gt;
    {
        // ConfigureAppConfiguration makes sure the config is available
        // as runtime in the IConfiguration.
        // You can use ConfigureHostConfiguration which configures the
        // IHostingEnvironment's Build-type Configuration instead if you
        // care to make the distinction.
        // ConfigureAppConfiguration changes are also still visible on
        // IHostingEnvironment as well ¯\_(ツ)_/¯
        configApp
            .AddJsonFile(&quot;appsettings.json&quot;, optional: false, reloadOnChange: false)
            .AddJsonFile($&quot;appsettings.{hostContext.HostingEnvironment.EnvironmentName}.json&quot;, optional: true)
            .AddEnvironmentVariables()
            .AddCommandLine(args);
    })
    .ConfigureServices(services =&gt;
    {
        ...
        
        services.AddHostedService&lt;MyApp&gt;();
    }
    .Build();
</code></pre>
<p>This configuration should give you the appsettings loading, including the <code>Environment</code>-specific  config files using the same <code>ASPNETCORE_ENVIRONMENT</code> EnvironmentVariable you are used to (though you could call this whatever you want, really). It also loads EnvironmentVariables as config overrides, and enables command line argument overrides as well (as highest priority).</p>
<p>I will leave you with a mention of logging.</p>
<pre><code class="language-cs">.ConfigureLogging((hostcontext, loggingBuilder) =&gt;
{
    // I'm thinking you should go do your own reading on this one, I'm not going to give you ALL the code to copy-paste from!
    // https://docs.microsoft.com/en-us/aspnet/core/fundamentals/host/generic-host?view=aspnetcore-2.1#configurelogging
    ...
})
</code></pre>
<p>Happy Coding!</p>
</section>
        
        <section class="share">
            Share: 
            <a class="icon-twitter" href="http://twitter.com/share?text=HostBuild%20your%20dotnet%20Consoles%20like%20you%20WebHostBuild%20your%20web%20apps.&url=https%3a%2f%2fblogmigration.csmac.nz%2fpost%2fhostbuild-your-dotnet-consoles-like-you-webhostbuild-your-web-apps%2f"
                onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
                <span>Twitter</span>
            </a>
            |
            <a class="icon-facebook" href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fblogmigration.csmac.nz%2fpost%2fhostbuild-your-dotnet-consoles-like-you-webhostbuild-your-web-apps%2f"
                onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
                <span>Facebook</span>
            </a>
        </section>
    </div>
    <div class="content-box">
        
        <div id="disqus_thread"></div>
        <script type="text/javascript">
            var disqus_shortname = d_id; 
            var disqus_title = 'HostBuild your dotnet Consoles like you WebHostBuild your web apps.';
            
             
            (function() {
                var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
        <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    
    </div>
</article>

<!--Page Content Ends-->

            </div><aside class="sidebar-area">

<!--Sidebar Content Begins-->

                <div class="header-bar-parent sidebar-item">
                    <div class="header-bar header-bar-twitter">Twitter</div>
                    
                    <a class="twitter-timeline" style="display: block; text-align: center;" href="https://twitter.com/csmacnz" data-widget-id="523634688984772608">Tweets by @@csmacnz</a>
                    <script>!function (d, s, id) { var js, fjs = d.getElementsByTagName(s)[0], p = /^http:/.test(d.location) ? 'http' : 'https'; if (!d.getElementById(id)) { js = d.createElement(s); js.id = id; js.src = p + "://platform.twitter.com/widgets.js"; fjs.parentNode.insertBefore(js, fjs); } }(document, "script", "twitter-wjs");</script>
                    
                </div>

                
                <div class="header-bar-parent sidebar-item">
                    <div class="header-bar header-bar-rss">Subscribe</div>
                    
                    <a href="/rssfeeds/" title="csMACnz's Blog">RSS Feeds</a>
                    <a href="http://add.my.yahoo.com/rss?url=http://feeds.feedburner.com/csmacnzBlog" title="csMACnz&amp;#039;s Blog"><img src="http://us.i1.yimg.com/us.yimg.com/i/us/my/addtomyyahoo4.gif" alt="" style="border:0"/></a>
                    <a href="http://feedly.com/#subscription/feed/http://feeds.feedburner.com/csmacnzBlog" title="csMACnz&amp;#039;s Blog"><img src="http://s3.feedly.com/feedburner/feedly.png" alt="" style="border:0"/></a>
                    <a href="http://www.netvibes.com/subscribe.php?url=http://feeds.feedburner.com/csmacnzBlog"><img src="http://www.netvibes.com/img/add2netvibes.gif" width="91" height="17" alt="Add to netvibes" style="border:0" /></a>
                    <a href="http://feeds.feedburner.com/csmacnzBlog"><img src="http://feeds.feedburner.com/~fc/csmacnzBlog?bg=fabb45&amp;fg=4B4B4B&amp;anim=1" height="26" width="88" style="border:0" alt="" /></a>
                    <br />
                    <a href="https://www.patreon.com/csMACnz" target="_blank"><img src="/images/patreon.png" /></a>
                    
                    
                </div>


                <div class="header-bar-parent sidebar-item">
                    <div class="header-bar header-bar-xbox">Gamercard</div>
                    

                    <div>
                        <a href="https://www.exophase.com/xbox/user/csMACnz/"><img width="288px" src="https://card.exophase.com/1/1476805.png"></a>
                        <a href="http://steamcommunity.com/id/csMACnz/" target="_blank"><img src="https://www.steamsignature.com/status/english/76561197994712512.png" alt="" title="csMACnz's Steam Profile" /></a>
                    </div>
                    
                </div>


                <div class="header-bar-parent sidebar-item">
                    <div class="header-bar header-bar-ads">Advertisement</div>
                    
                    <div>
                        <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4517187877737982"
                            crossorigin="anonymous"></script>
                        
                        <ins class="adsbygoogle"
                            style="display:block"
                            data-ad-client="ca-pub-4517187877737982"
                            data-ad-slot="3618449993"
                            data-ad-format="auto"
                            data-full-width-responsive="true"></ins>
                        <script>
                            (adsbygoogle = window.adsbygoogle || []).push({});
                        </script>
                    </div>
                    
                </div>

<!--Sidebar Content Ends-->

            </aside>

            <footer class="footer-area">

            <p>
                Designed and Maintained by Mark Clearwater; Last updated August 2021.
                <!-- This used to be something useful, now it is just a hack I left it to make layout easier but also as a fun reminder for me of what it used to be -->
                <br /><a class="footer-link" >¯\_(ツ)_/¯</a>
            </p>

            </footer>
        </div>

<!--body scripts Begins-->

        
        <script src="/js/highlight.pack.js"></script>
        <script>hljs.initHighlightingOnLoad();</script>

        <script src="/js/codetoggle.js"></script> 

        
        <script>
            var _gaq = [['_setAccount', g_id], ['_trackPageview']];
            (function (d, t) {
                var g = d.createElement(t), s = d.getElementsByTagName(t)[0];
                g.src = ('https:' == location.protocol ? '//ssl' : '//www') + '.google-analytics.com/ga.js';
                s.parentNode.insertBefore(g, s);
            }(document, 'script'));
        </script>

        <script type="text/javascript" src="https://code.jquery.com/jquery-1.11.3.min.js"></script>

<!--body scripts Ends-->


<!-------------------------------->
<!--                            -->
<!--  _(\    |@@|               -->
<!-- (__/\__ \--/ __            -->
<!--    \___|----|  |   __      -->
<!--        \ }{ /\ )_ / _\     -->
<!--        /\__/\ \__O (__     -->
<!--       (--/\--)    \__/     -->
<!--       _)(  )(_             -->
<!--      `---''---`            -->
<!--                            -->
<!-- https://github.com/csMACnz -->
<!-------------------------------->

    </body>
</html>
