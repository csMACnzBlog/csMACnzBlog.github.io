<!DOCTYPE html>
<html lang="en">
    <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name='author' content='Mark Clearwater, csmacnz@csmac.co.nz'>
    <meta name='language' content='EN'>
    <meta name='medium' content='blog'>


    <title>Retries with Polly - csMACnz&#39;s Blog</title>
    <meta name="description" content="Just a quick results of an investigation of our PrintService v-next logs that keep happening (can&rsquo;t find queue) Why? - Because I was worried that I was using Polly Retries wrong, to know for next time (SPOILERS - I …">
    <meta name='keywords' content='csMACnz, Tips and Tricks, Polly'>

    
    <meta property="og:type" content="article"/>
    <meta property="og:title" content="Retries with Polly"/>
    <meta property="og:description" content="Just a quick results of an investigation of our PrintService v-next logs that keep happening (can&rsquo;t find queue) Why? - Because I was worried that I was using Polly Retries wrong, to know for next time (SPOILERS - I …"/>
    <meta property="og:site_name" content="csMACnz&#39;s Blog"/>
    <meta property="og:url" content="https://csmacnzblog.github.io/post/retries-with-polly/"/>
    <meta property="og:image" content="http://csmac.nz/Content/icon/icon.png"/>

    
    <meta name="twitter:card" content="summary"/>
    <meta name="twitter:title" content="Retries with Polly"/>
    <meta name="twitter:description" content="Just a quick results of an investigation of our PrintService v-next logs that keep happening (can&rsquo;t find queue) Why? - Because I was worried that I was using Polly Retries wrong, to know for next time (SPOILERS - I …"/>
    <meta name="twitter:image" content="http://csmac.nz/Content/icon/icon.png"/>
    <meta name="twitter:site" content="@csMACnz"/>
    <meta name="twitter:creator" content="@csMACnz"/>


    <link rel="apple-touch-icon-precomposed" href="/images/icon/apple-touch-icon-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="72x72" href="/images/icon/apple-touch-icon-72x72-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="114x114" href="/images/icon/apple-touch-icon-114x114-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/images/icon/apple-touch-icon-144x144-precomposed.png">
    <link rel="icon" type="image/png" href="/images/icon/icon.png" />
    <link rel='me' type='text/html' href='https://github.com/csMACnz'>

    <script>
        var d_id  = 'csmacnz',
            g_id  = 'UA-18464866-2',
            g_url = 'auto';
    </script>

    <link rel="stylesheet" type="text/css" href="/css/style.css" />
    <link rel="stylesheet" type="text/css" href="/css/blogstyle.css" />

    <link rel="alternate stylesheet" title="dark-code" type="text/css" href="/css/solarized_dark.css" disabled>
    <link rel="stylesheet" title="light-code" type="text/css" href="/css/github-gist.css" disabled>

    <!-- ENTERING partial seo-schema.html -->
    
    
    <script type="application/ld+json">
    {
        "@context" : "https://schema.org",
        "@type" : "Article",
        "publisher": {
            "@type": "Organization",
            "name": "csMACnz&#x27;s Blog",
            "logo": "https:\/\/csmacnzblog.github.io\/images\/icon\/apple-touch-icon-144x144-precomposed.png"
        },
        "author": {
            "@type": "Person",
            "name": "Mark Clearwater",
            "image": {
                "@type": "ImageObject",
                "url": "//www.gravatar.com/avatar/c97410951ec3738a3fd4a2dfb17a5d9c?d=404&s=250",
                "width": 440,
                "height": 295
            },
            "url": "https:\/\/csmacnzblog.github.io",
            "sameAs": [
                "http://csmac.nz"
            ]
        },
        "articleSection" : "post",
        "name" : "Retries with Polly",
        "headline" : "Retries with Polly",
        "url" : "https:\/\/csmacnzblog.github.io\/post\/retries-with-polly\/",
        "datePublished": "2016-06-24T02:01:49.000Z",
        "dateModified" : "2016-06-24T02:01:49.000Z",
        "keywords" : [ "Tips and Tricks", "Polly" ]
        "description" : "Just a quick results of an investigation of our PrintService v-next logs that keep happening (can\u0026rsquo;t find queue) Why? - Because I was worried that I was using Polly Retries wrong, to know for next time (SPOILERS - I was)\nWhat: We have retries over checking the queue (and other aws commands. We see many errors of WebException: The remote server returned an error: (504) Gateway Timeout happening quite a lot.",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/csmacnzblog.github.io"
        }
        "inLanguage" : "en-US",
        "author" : "Mark Clearwater",
        "creator" : "Mark Clearwater",
        "accountablePerson" : "Mark Clearwater",
        "copyrightHolder" : "Mark Clearwater",
        "copyrightYear" : "2016",
        "wordCount" : "269",
    }
    </script>
    
    
    <!-- LEAVING partial seo-schema.html -->
    <style>
        .post-content img {
            max-width: 500px;
        }
    </style>
    </head>
    <body class="blog">
        <div class="page-area"><header class="header-area">
    <h1 class="header-area-title">csMACnz</h1>
</header>
<nav class="navigation-area header-bar-parent">
    <div class="header-bar header-bar-blog">
        <ul class="menu">
            <li class="menu-item"><a class="menu-item-content" href="http://csmac.nz">Home</a></li>
            <li class="menu-item"><a class="menu-item-content" href="http://csmac.nz/BaconVaders">Bacon Vaders</a></li>
            <li class="menu-item"><a class="menu-item-content CurrentButton" href="/">Blog</a></li>
        </ul>
    </div>
</nav><div id="content" class="content-area">
            
<article>
    <div class="content-box" itemscope itemtype="http://schema.org/Article">
    
        <span class="post-meta"><time datetime="2016-06-24"  itemprop="datePublished">24 Jun 16</time> on <a href="/tags/tips-and-tricks">Tips and Tricks</a>,  <a href="/tags/polly">Polly</a></span>
    
        <h1 class="post-title" itemprop="headline">Retries with Polly</h1>
    
        <section class="post-content"  itemprop="articleBody">
            <p>Just a quick results of an investigation of our PrintService v-next logs that keep happening (can&rsquo;t find queue)
<strong>Why?</strong> - Because I was worried that I was using Polly Retries wrong, to know for next time (SPOILERS - I was)</p>
<p><strong>What:</strong>
We have retries over checking the queue (and other aws commands.  We see many errors of <code>WebException: The remote server returned an error: (504) Gateway Timeout</code> happening quite a lot. These should be being retried and so should never trigger an error log. We are seeing a lot of logs still.
Investigating further, we don not actually log any messages saying &ldquo;here is the error, going to retry now&rdquo; which should happen because of this line of code: <a href="https://github.dev.xero.com/dev-markc/PrintService/blob/master/project/Xero.PrintService.Platform/Policy/AWSPolicy.cs#L43">https://github.dev.xero.com/dev-markc/PrintService/blob/master/project/Xero.PrintService.Platform/Policy/AWSPolicy.cs#L43</a>
I looked into the filter we were using. It looks sensible, only retry if the error is not the sender&rsquo;s fault.
Then I found out that the AmazonServiceException ErrorType defaults to ErrorType.Sender. Then I found the following line of code that wraps WebExceptions (like above) doesn&rsquo;t even set the ErrorType, and so it will be ErrorType.Sender - <a href="https://github.com/aws/aws-sdk-net/blob/master/sdk/src/Core/Amazon.Runtime/Pipeline/ErrorHandler/WebExceptionHandler.cs#L44">https://github.com/aws/aws-sdk-net/blob/master/sdk/src/Core/Amazon.Runtime/Pipeline/ErrorHandler/WebExceptionHandler.cs#L44</a></p>
<p><strong>Conclusion</strong> - Don&rsquo;t trust the Error type and assume it means what it is supposed to - and we were not actually retrying.
So every error we were emailed is indicative of how often we get network connection timeouts to AWS SQS. So Retries are really important.  But we need to be careful with our retry logic, because with the Polly API you have to check the PolicyResult.ExceptionType - ExceptionType.Unknown means there was an exception unhandled by the policy - passed through, and  ExceptionType.HandledByThisPolicy means it actually retried, and timed out.</p>
</section>
        
        <section class="share">
            Share: 
            <a class="icon-twitter" href="http://twitter.com/share?text=Retries%20with%20Polly&url=https%3a%2f%2fcsmacnzblog.github.io%2fpost%2fretries-with-polly%2f"
                onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
                <span>Twitter</span>
            </a>
            |
            <a class="icon-facebook" href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fcsmacnzblog.github.io%2fpost%2fretries-with-polly%2f"
                onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
                <span>Facebook</span>
            </a>
        </section>
    </div>
    <div class="content-box">
        
        <div id="disqus_thread"></div>
        <script type="text/javascript">
            var disqus_shortname = d_id; 
            var disqus_title = 'Retries with Polly';
            
             
            (function() {
                var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
        <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    
    </div>
</article>

        </div><aside class="sidebar-area">
            <div class="header-bar-parent sidebar-item">
                <div class="header-bar header-bar-twitter">Twitter</div>
                
                <a class="twitter-timeline" style="display: block; text-align: center;" href="https://twitter.com/csmacnz" data-widget-id="523634688984772608">Tweets by @@csmacnz</a>
                <script>!function (d, s, id) { var js, fjs = d.getElementsByTagName(s)[0], p = /^http:/.test(d.location) ? 'http' : 'https'; if (!d.getElementById(id)) { js = d.createElement(s); js.id = id; js.src = p + "://platform.twitter.com/widgets.js"; fjs.parentNode.insertBefore(js, fjs); } }(document, "script", "twitter-wjs");</script>
                
            </div>
            <div class="header-bar-parent sidebar-item">
                <div class="header-bar header-bar-rss">Subscribe</div>
                
                <a href="/rssfeeds/" title="csMACnz's Blog">RSS Feeds</a>
                <a href="http://add.my.yahoo.com/rss?url=http://feeds.feedburner.com/csmacnzBlog" title="csMACnz&amp;#039;s Blog"><img src="http://us.i1.yimg.com/us.yimg.com/i/us/my/addtomyyahoo4.gif" alt="" style="border:0"/></a>
                <a href="http://feedly.com/#subscription/feed/http://feeds.feedburner.com/csmacnzBlog" title="csMACnz&amp;#039;s Blog"><img src="http://s3.feedly.com/feedburner/feedly.png" alt="" style="border:0"/></a>
                <a href="http://www.netvibes.com/subscribe.php?url=http://feeds.feedburner.com/csmacnzBlog"><img src="http://www.netvibes.com/img/add2netvibes.gif" width="91" height="17" alt="Add to netvibes" style="border:0" /></a>
                <a href="http://feeds.feedburner.com/csmacnzBlog"><img src="http://feeds.feedburner.com/~fc/csmacnzBlog?bg=fabb45&amp;fg=4B4B4B&amp;anim=1" height="26" width="88" style="border:0" alt="" /></a>
                <br />
                <a href="https://www.patreon.com/csMACnz" target="_blank"><img src="/images/patreon.png" /></a>
                
                
            </div>
            <div class="header-bar-parent sidebar-item">
                <div class="header-bar header-bar-xbox">Gamercard</div>
                

                <div>
                    <a href="https://www.exophase.com/xbox/user/csMACnz/"><img width="288px" src="https://card.exophase.com/1/1476805.png"></a>
                    <a href="http://steamcommunity.com/id/csMACnz/" target="_blank"><img src="https://www.steamsignature.com/status/english/76561197994712512.png" alt="" title="csMACnz's Steam Profile" /></a>
                </div>
                
            </div>
            <div class="header-bar-parent sidebar-item">
                <div class="header-bar header-bar-ads">Advertisement</div>
                
                <div>
                    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4517187877737982"
                        crossorigin="anonymous"></script>
                    
                    <ins class="adsbygoogle"
                        style="display:block"
                        data-ad-client="ca-pub-4517187877737982"
                        data-ad-slot="3618449993"
                        data-ad-format="auto"
                        data-full-width-responsive="true"></ins>
                    <script>
                        (adsbygoogle = window.adsbygoogle || []).push({});
                    </script>
                </div>
                
            </div>
        </aside>
        
        <footer class="footer-area"><p>
    Designed and Maintained by Mark Clearwater; Last updated August 2021.
    <br /><a class="footer-link" >¯\_(ツ)_/¯</a>
</p></footer>
    </div>
    
    
    <script src="/js/highlight.pack.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    
    <script src="/js/codetoggle.js"></script> 

    
    <script>
        var _gaq = [['_setAccount', g_id], ['_trackPageview']];
        (function (d, t) {
            var g = d.createElement(t), s = d.getElementsByTagName(t)[0];
            g.src = ('https:' == location.protocol ? '//ssl' : '//www') + '.google-analytics.com/ga.js';
            s.parentNode.insertBefore(g, s);
        }(document, 'script'));
    </script>

    <script type="text/javascript" src="https://code.jquery.com/jquery-1.11.3.min.js"></script>
    </body>
</html>
