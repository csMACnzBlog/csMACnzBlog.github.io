<!DOCTYPE html>
<html lang="en">
    <head>

        <script>
            if(!/blog\.csmac\.nz/.test(window.location.host)) {
                window.location = "https:\/\/blog.csmac.nz\/post\/a-windows-service-on-dotnet\/";
            }
        </script>

        <meta charset="utf-8" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta name='author' content='Mark Clearwater, csmacnz@csmac.co.nz'>
        <meta name='language' content='EN'>
        <meta name='medium' content='blog'>
        <meta name="google-adsense-account" content="ca-pub-4517187877737982">

    
        <title>A Windows Service using netcoreapp on dotnet - csMACnz&#39;s Blog</title>
        <meta name="description" content="I wrote Building a Windows Service with .Net Core and had a bit of flack because I was only using .Net core to build a .Net 4.5.2 application.  Technically the title is still valid, it was a windows service, and I built …">
        <meta name='keywords' content='csMACnz, dotnetcore, Tips and Tricks, docker'>

        
        <meta property="og:type" content="article"/>
        <meta property="og:title" content="A Windows Service using netcoreapp on dotnet"/>
        <meta property="og:description" content="I wrote Building a Windows Service with .Net Core and had a bit of flack because I was only using .Net core to build a .Net 4.5.2 application.  Technically the title is still valid, it was a windows service, and I built …"/>
        <meta property="og:site_name" content="csMACnz&#39;s Blog"/>
        <meta property="og:url" content="https://blog.csmac.nz/post/a-windows-service-on-dotnet/"/>
        <meta property="og:image" content="https://csmac.nz/Content/icon/icon.png"/>

        
        <meta name="twitter:card" content="summary"/>
        <meta name="twitter:title" content="A Windows Service using netcoreapp on dotnet"/>
        <meta name="twitter:description" content="I wrote Building a Windows Service with .Net Core and had a bit of flack because I was only using .Net core to build a .Net 4.5.2 application.  Technically the title is still valid, it was a windows service, and I built …"/>
        <meta name="twitter:image" content="https://csmac.nz/Content/icon/icon.png"/>
        <meta name="twitter:site" content="@csMACnz"/>
        <meta name="twitter:creator" content="@csMACnz"/>
    

        <link rel="apple-touch-icon-precomposed" href="/images/icon/apple-touch-icon-precomposed.png">
        <link rel="apple-touch-icon-precomposed" sizes="72x72" href="/images/icon/apple-touch-icon-72x72-precomposed.png">
        <link rel="apple-touch-icon-precomposed" sizes="114x114" href="/images/icon/apple-touch-icon-114x114-precomposed.png">
        <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/images/icon/apple-touch-icon-144x144-precomposed.png">
        <link rel="icon" type="image/png" href="/images/icon/icon.png" />
        <link rel='me' type='text/html' href='https://github.com/csMACnz'>

        <script>
            var d_id  = 'csmacnz';
        </script>

        <link rel="stylesheet" href="/css/mastodon-timeline.min.css" />

        <link rel="stylesheet" type="text/css" href="/css/style.css" />
        <link rel="stylesheet" type="text/css" href="/css/blogstyle.css" />

        <link rel="alternate stylesheet" title="dark-code" type="text/css" href="/css/solarized_dark.css" disabled>
        <link rel="stylesheet" title="light-code" type="text/css" href="/css/github-gist.css" disabled>

        <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4517187877737982"
        crossorigin="anonymous"></script>

        
        
        <script type="application/ld+json">
        {
            "@context" : "https://schema.org",
            "@type" : "Article",
            "publisher": {
                "@type": "Organization",
                "name": "csMACnz&#x27;s Blog",
                "logo": "https:\/\/blog.csmac.nz\/images\/icon\/apple-touch-icon-144x144-precomposed.png"
            },
            "author": {
                "@type": "Person",
                "name": "Mark Clearwater",
                "image": {
                    "@type": "ImageObject",
                    "url": "//www.gravatar.com/avatar/c97410951ec3738a3fd4a2dfb17a5d9c?d=404&s=250",
                    "width": 440,
                    "height": 295
                },
                "url": "https:\/\/blog.csmac.nz",
                "sameAs": [
                    "https://csmac.nz"
                ]
            },
            "articleSection" : "post",
            "name" : "A Windows Service using netcoreapp on dotnet",
            "headline" : "A Windows Service using netcoreapp on dotnet",
            "url" : "https:\/\/blog.csmac.nz\/post\/a-windows-service-on-dotnet\/",
            "datePublished": "2018-04-22T07:00:00.000Z",
            "dateModified" : "2018-04-22T07:00:00.000Z",
            "keywords" : [ "dotnetcore", "Tips and Tricks", "docker" ]
            "description" : "I wrote Building a Windows Service with .Net Core and had a bit of flack because I was only using .Net core to build a .Net 4.5.2 application. Technically the title is still valid, it was a windows service, and I built it using .Net Core tools. But since people came looking for the answer to actually hosting a NetCoreApp application as a Windows Service, I thought it best to follow up with that article as well.",
            "mainEntityOfPage": {
                "@type": "WebPage",
                "@id": "https:\/\/blog.csmac.nz"
            }
            "inLanguage" : "en-US",
            "author" : "Mark Clearwater",
            "creator" : "Mark Clearwater",
            "accountablePerson" : "Mark Clearwater",
            "copyrightHolder" : "Mark Clearwater",
            "copyrightYear" : "2018",
            "wordCount" : "2224",
        }
        </script>
        
        
        
    </head>
    <body class="blog">
        <div class="page-area">

            <header class="header-area">
                <h1 class="header-area-title">csMACnz</h1>
            </header>
            <nav class="navigation-area header-bar-parent">
                <div class="header-bar header-bar-blog">
                    <ul class="menu">
                        <li class="menu-item"><a class="menu-item-content" href="https://csmac.nz">Home</a></li>
                        <li class="menu-item"><a class="menu-item-content" href="https://csmac.nz/baconvaders">Bacon Vaders</a></li>
                        <li class="menu-item"><a class="menu-item-content CurrentButton" href="https://blog.csmac.nz">Blog</a></li>
                        <li class="menu-item"><a class="menu-item-content" href="https://csmac.nz/metablog">Meta</a></li>
                    </ul>
                </div>
            </nav>

            <div id="content" class="content-area">

<!--Page Content Begins-->

<article>
    <div class="content-box" itemscope itemtype=" https://schema.org/Article"><span class="post-meta"><time datetime="2018-04-22"  itemprop="datePublished">22 Apr 18</time> in <a href="/categories/software-engineering">Software Engineering</a> on <a href="/tags/dotnetcore">dotnetcore</a>,  <a href="/tags/tips-and-tricks">Tips and Tricks</a>,  <a href="/tags/docker">docker</a></span>
<h1 class="post-title" itemprop="headline">A Windows Service using netcoreapp on dotnet</h1>
    
        <section class="post-content"  itemprop="articleBody">
            <p>I wrote <a href="/building-a-windows-service-with-net-core/">Building a Windows Service with .Net Core</a> and had a bit of flack because I was only using .Net core to build a .Net 4.5.2 application.  Technically the title is still valid, it was a windows service, and I built it using .Net Core tools.  But since people came looking for the answer to actually hosting a NetCoreApp application as a Windows Service, I thought it best to follow up with that article as well.</p>
<p>Note that since windows Service logic and hooks are Windows-specific, this solution doesn&rsquo;t work for Mac or Linux.  However I will try to maintain a working Console application, that should satisfy the requirements there.</p>
<h2 id="just-target-net-full-framework">Just target .Net Full framework</h2>
<p>Everything you already have working in your services using <code>System.ServiceProcess.ServiceBase</code> and other classes from the <code>System.ServiceProcess</code> full framework assemblies work fine when compiled with .Net Core. Since you can&rsquo;t run a Windows Service on non-windows platforms, there is no reason not to just target the Windows-only full framework 4.6.2 or 4.7.1 or whichever your stable .Net version of choice is. None of the <code>System.ServiceProcess</code> code can run on Linux or Mac anyway, and neither can any Windows Service specific code. This is probably going to be the path of least resistance.</p>
<p>But that was the subject of the <a href="/building-a-windows-service-with-net-core/">other article</a>, I assume you are here for something different.</p>
<h2 id="cross-platform-solution">Cross Platform solution</h2>
<p>We will now take a look at what we can do to make an application that a) can install and run as a windows service, and b) still runs as a console app on Linux, ignoring the unused service code.  This application is going to be a portable <code>netcoreapp2.0</code> application, so we can only reference <code>netstandard</code> or <code>netcoreapp</code> libraries.</p>
<p><a href="https://github.com/dasMulli/dotnet-win32-service">dasMulli/dotnet-win32-service</a> is a project that has created a win32 interop layer over the Windows Service API.  Much like the way the original .Net code probably works, but compiled as a dotnet standard library (<code>netstandard1.3</code> and <code>netstandard2.0</code> compatible versions).  On top of this, there is another library <a href="https://github.com/PeterKottas/DotNetCore.WindowsService">PeterKottas/DotNetCore.WindowsService</a> which also targets <code>netstandard2.0</code> that we will use to give us a nicer install/uninstall interface into our application.</p>
<h3 id="the-application">The &lsquo;Application&rsquo;</h3>
<p>Let&rsquo;s use something pretty dumb. Our app will sleep for 1 second, Then try to generate the next number in the Fibonacci Sequence.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cs" data-lang="cs"><span style="display:flex;"><span><span style="color:#66d9ef">using</span> System;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">using</span> System.Threading;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">using</span> System.Threading.Tasks;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">namespace</span> MyApp
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">MyApp</span>
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">readonly</span> AutoResetEvent _closeRequested = <span style="color:#66d9ef">new</span> AutoResetEvent(<span style="color:#66d9ef">false</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">long</span> _last = <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">long</span> _current = <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">private</span> Task _work;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">public</span> MyApp()
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> Start()
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            _work = Task.Run(() =&gt; DoWorkLoop());
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> Stop()
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            _closeRequested.Set();
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (_work != <span style="color:#66d9ef">null</span>)
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>                _work.Wait();
</span></span><span style="display:flex;"><span>                _work = <span style="color:#66d9ef">null</span>;
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> DoWorkLoop()
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">while</span> (!_closeRequested.WaitOne(<span style="color:#ae81ff">1000</span>))
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">var</span> last = _current;
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">var</span> next = _last + _current;
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> (next == <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>                {
</span></span><span style="display:flex;"><span>                    next = <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>                _last = _current;
</span></span><span style="display:flex;"><span>                _current = next;
</span></span><span style="display:flex;"><span>                Console.WriteLine(next);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>I&rsquo;ve added some boiler-plate start/stop logic including a mutex to release the app and wait for it to finish in the stop command.</p>
<p>To run as a console app, I could simply wait for a keypress:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cs" data-lang="cs"><span style="display:flex;"><span><span style="color:#66d9ef">var</span> app = <span style="color:#66d9ef">new</span> MyApp();
</span></span><span style="display:flex;"><span>app.Start();
</span></span><span style="display:flex;"><span>Console.ReadKey();
</span></span><span style="display:flex;"><span>Console.WriteLine(<span style="color:#e6db74">&#34;Stopping&#34;</span>);
</span></span><span style="display:flex;"><span>app.Stop();
</span></span></code></pre></div><p>or I could make use of requiring ctrl+c to exit instead:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cs" data-lang="cs"><span style="display:flex;"><span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">readonly</span> AutoResetEvent _closing = <span style="color:#66d9ef">new</span> AutoResetEvent(<span style="color:#66d9ef">false</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> Main(<span style="color:#66d9ef">string</span>[] args)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    Console.WriteLine(<span style="color:#e6db74">&#34;Hello World!&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> app = <span style="color:#66d9ef">new</span> MyApp();
</span></span><span style="display:flex;"><span>    app.Start();
</span></span><span style="display:flex;"><span>    Console.CancelKeyPress += <span style="color:#66d9ef">new</span> ConsoleCancelEventHandler(OnExit);
</span></span><span style="display:flex;"><span>    _closing.WaitOne();
</span></span><span style="display:flex;"><span>    Console.WriteLine(<span style="color:#e6db74">&#34;Stopping&#34;</span>);
</span></span><span style="display:flex;"><span>    app.Stop();
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> OnExit(<span style="color:#66d9ef">object</span> sender, ConsoleCancelEventArgs args)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    Console.WriteLine(<span style="color:#e6db74">&#34;Exit Requested&#34;</span>);
</span></span><span style="display:flex;"><span>    _closing.Set();
</span></span><span style="display:flex;"><span>    args.Cancel = <span style="color:#66d9ef">true</span>;
</span></span><span style="display:flex;"><span>    Console.CancelKeyPress -= <span style="color:#66d9ef">new</span> ConsoleCancelEventHandler(OnExit);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Either way, we now have a functioning console app, in a format that is compatible with a Windows Service.</p>
<h3 id="install-the-libraries">Install the libraries</h3>
<p>As mentioned, we will use <a href="https://github.com/PeterKottas/DotNetCore.WindowsService">PeterKottas/DotNetCore.WindowsService</a> nuget package <a href="https://www.nuget.org/packages/PeterKottas.DotNetCore.WindowsService/">PeterKottas.DotNetCore.WindowsService</a> to make our life easier. (<code>dotnet add package PeterKottas.DotNetCore.WindowsService</code>)</p>
<h3 id="the-program">The Program</h3>
<p>Now we can change our program to start using the code from the library, instead of our code:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cs" data-lang="cs"><span style="display:flex;"><span><span style="color:#66d9ef">using</span> System;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">using</span> System.Threading;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">using</span> PeterKottas.DotNetCore.WindowsService;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">namespace</span> MyApp
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Program</span>
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> Main(<span style="color:#66d9ef">string</span>[] args)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            ServiceRunner&lt;MyApp&gt;.Run(config =&gt;
</span></span><span style="display:flex;"><span>            {
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">var</span> name = config.GetDefaultName();
</span></span><span style="display:flex;"><span>                config.SetName(<span style="color:#e6db74">&#34;MyAppService&#34;</span>);
</span></span><span style="display:flex;"><span>                config.SetDescription(<span style="color:#e6db74">&#34;An example application&#34;</span>);
</span></span><span style="display:flex;"><span>                config.SetDisplayName(<span style="color:#e6db74">&#34;MyApp As A Service&#34;</span>);
</span></span><span style="display:flex;"><span>                config.Service(serviceConfig =&gt;
</span></span><span style="display:flex;"><span>                {
</span></span><span style="display:flex;"><span>                    serviceConfig.ServiceFactory((extraArguments, serviceController) =&gt;
</span></span><span style="display:flex;"><span>                    {
</span></span><span style="display:flex;"><span>                        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> MyApp();
</span></span><span style="display:flex;"><span>                    });
</span></span><span style="display:flex;"><span>                    serviceConfig.OnStart((service, extraArguments) =&gt;
</span></span><span style="display:flex;"><span>                    {
</span></span><span style="display:flex;"><span>                        Console.WriteLine(<span style="color:#e6db74">&#34;Service {0} started&#34;</span>, name);
</span></span><span style="display:flex;"><span>                        service.Start();
</span></span><span style="display:flex;"><span>                    });
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                    serviceConfig.OnStop(service =&gt;
</span></span><span style="display:flex;"><span>                    {
</span></span><span style="display:flex;"><span>                        Console.WriteLine(<span style="color:#e6db74">&#34;Service {0} stopped&#34;</span>, name);
</span></span><span style="display:flex;"><span>                        service.Stop();
</span></span><span style="display:flex;"><span>                    });
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                    serviceConfig.OnInstall(service =&gt;
</span></span><span style="display:flex;"><span>                    {
</span></span><span style="display:flex;"><span>                        Console.WriteLine(<span style="color:#e6db74">&#34;Service {0} installed&#34;</span>, name);
</span></span><span style="display:flex;"><span>                    });
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                    serviceConfig.OnUnInstall(service =&gt;
</span></span><span style="display:flex;"><span>                    {
</span></span><span style="display:flex;"><span>                        Console.WriteLine(<span style="color:#e6db74">&#34;Service {0} uninstalled&#34;</span>, name);
</span></span><span style="display:flex;"><span>                    });
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                    serviceConfig.OnPause(service =&gt;
</span></span><span style="display:flex;"><span>                    {
</span></span><span style="display:flex;"><span>                        Console.WriteLine(<span style="color:#e6db74">&#34;Service {0} paused&#34;</span>, name);
</span></span><span style="display:flex;"><span>                    });
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                    serviceConfig.OnContinue(service =&gt;
</span></span><span style="display:flex;"><span>                    {
</span></span><span style="display:flex;"><span>                        Console.WriteLine(<span style="color:#e6db74">&#34;Service {0} continued&#34;</span>, name);
</span></span><span style="display:flex;"><span>                    });
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                    serviceConfig.OnError(e =&gt;
</span></span><span style="display:flex;"><span>                    {
</span></span><span style="display:flex;"><span>                        Console.WriteLine(<span style="color:#e6db74">&#34;Service {0} errored with exception : {1}&#34;</span>, name, e.Message);
</span></span><span style="display:flex;"><span>                    });
</span></span><span style="display:flex;"><span>                });
</span></span><span style="display:flex;"><span>            });
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>I also had to add the <code>IMicroService</code> interface to <code>MyApp</code>, but otherwise it stayed the same since I already implemented the <code>Start</code>/<code>Stop</code> methods. Yes, it is a tonne more code, but thats just me logging state transitions, your app may not want or need to implement every event handler.</p>
<p>Now the app runs two ways:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>dotnet run
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>Starting up as a console service host
</span></span><span style="display:flex;"><span>Service MyApp.MyApp started
</span></span><span style="display:flex;"><span>The MyAppService service is now running, press Control+C to exit.
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">8</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">13</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">21</span>
</span></span><span style="display:flex;"><span>Control+C detected, attempting to stop service.
</span></span><span style="display:flex;"><span>Service MyApp.MyApp stopped
</span></span><span style="display:flex;"><span>The MyAppService service has stopped.
</span></span></code></pre></div><p>And also installed as a service:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>dotnet run action<span style="color:#960050;background-color:#1e0010">:</span>install
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>Successfully registered and started service <span style="color:#e6db74">&#34;MyAppService&#34;</span> <span style="color:#f92672">(</span><span style="color:#e6db74">&#34;An example application&#34;</span><span style="color:#f92672">)</span>
</span></span></code></pre></div><p><img src="http://res.cloudinary.com/csmacnz/image/upload/v1523006256/MyAppService_rtae5s.png" alt="MyApp running as a Service"></p>
<h3 id="on-linux">On Linux</h3>
<p>In theory, we can take this app as written and build and run it as a console app on Linux.  This is because all our code is portable dotnet core <code>netstandard</code> and <code>netcoreapp</code> cross-platform code.  Yes, we have some interop code that expects some windows APIs, but in theory, if we never execute that code, it won&rsquo;t cause any issues.  Let&rsquo;s find out.</p>
<p>The easiest way to run Linux on windows is probably docker, so we can test using that.
(This assumes you have Docker installed and set up, otherwise, just follow along on any Linux environment you have.)</p>
<p>I am going to run the <code>Microsoft/aspnetcore-build</code> image, so that the tools are available, and map the dev folder I was already using. I will just start a <code>bash</code> shell so that I basically simulate working on my folder from a Linux machine. (Your networking may vary.)</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span> docker run --rm -it -v <span style="color:#e6db74">&#34;</span>$(pwd)<span style="color:#e6db74">:/app&#34;</span> -w /app microsoft/aspnetcore-build bash
</span></span></code></pre></div><p>This will likely spend some time pulling down the image if you haven&rsquo;t used it before. Once that is done you will be dropped into a bash shell inside an instance of a <code>Microsoft/aspnetcore-build</code> Linux container with the windows folder directory containing out application mapped to the <code>/app</code> folder.</p>
<p>(As mentioned, if you don&rsquo;t have docker, or would rather use a Linux environment you already have, the rest of the instructions should work much the same.)</p>
<p>All you need to do is build and run, and you should get a working application.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>root@2683f31d537c:/app# ls
</span></span><span style="display:flex;"><span>MyApp.cs  MyApp.csproj  Program.cs  bin  obj
</span></span><span style="display:flex;"><span>root@2683f31d537c:/app# dotnet build
</span></span><span style="display:flex;"><span>Microsoft <span style="color:#f92672">(</span>R<span style="color:#f92672">)</span> Build Engine version 15.6.84.34536 <span style="color:#66d9ef">for</span> .NET Core
</span></span><span style="display:flex;"><span>Copyright <span style="color:#f92672">(</span>C<span style="color:#f92672">)</span> Microsoft Corporation. All rights reserved.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  Restoring packages <span style="color:#66d9ef">for</span> /app/MyApp.csproj...
</span></span><span style="display:flex;"><span>  Installing System.ServiceProcess.ServiceController 4.4.0.
</span></span><span style="display:flex;"><span>  Installing DasMulli.Win32.ServiceUtils 1.0.1.
</span></span><span style="display:flex;"><span>  Installing PeterKottas.DotNetCore.CmdArgParser 1.0.5.
</span></span><span style="display:flex;"><span>  Installing PeterKottas.DotNetCore.WindowsService 2.0.6.
</span></span><span style="display:flex;"><span>  Generating MSBuild file /app/obj/MyApp.csproj.nuget.g.props.
</span></span><span style="display:flex;"><span>  Generating MSBuild file /app/obj/MyApp.csproj.nuget.g.targets.
</span></span><span style="display:flex;"><span>  Restore completed in 3.08 sec <span style="color:#66d9ef">for</span> /app/MyApp.csproj.
</span></span><span style="display:flex;"><span>  MyApp -&gt; /app/bin/Debug/netcoreapp2.0/MyApp.dll
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Build succeeded.
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">0</span> Warning<span style="color:#f92672">(</span>s<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">0</span> Error<span style="color:#f92672">(</span>s<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Time Elapsed 00:00:06.79
</span></span><span style="display:flex;"><span>root@2683f31d537c:/app# dotnet run
</span></span><span style="display:flex;"><span>Starting up as a console service host
</span></span><span style="display:flex;"><span>Service MyApp.MyApp started
</span></span><span style="display:flex;"><span>The MyAppService service is now running, press Control+C to exit.
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span>^CControl+C detected, attempting to stop service.
</span></span><span style="display:flex;"><span>Service MyApp.MyApp stopped
</span></span><span style="display:flex;"><span>The MyAppService service has stopped.
</span></span></code></pre></div><p>And that&rsquo;s it, the same code compiles on Linux as well, and runs successfully.</p>
<p>I&rsquo;m not currently a Linux user and haven&rsquo;t set up services or daemons for a while, so I will defer to others on the topic of <a href="http://pmcgrath.net/running-a-simple-dotnet-core-linux-daemon">Running a dotnet Core app as a Linux daemon</a></p>
<h3 id="on-docker">On Docker</h3>
<p>Let&rsquo;s whip up a Dockerfile to round it off, that will build and pack a new docker image, that we can then start and see it running our task.</p>
<p>First the docker file (Dockerfile). This is a basic minimalist version, you will likely want to do optimisation steps yourself.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-dockerfile" data-lang="dockerfile"><span style="display:flex;"><span><span style="color:#66d9ef">FROM</span><span style="color:#e6db74"> microsoft/dotnet:2.0-runtime AS base</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">WORKDIR</span><span style="color:#e6db74"> /app</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">EXPOSE</span><span style="color:#e6db74"> 80</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">FROM</span><span style="color:#e6db74"> microsoft/aspnetcore-build:2.0 AS build</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">WORKDIR</span><span style="color:#e6db74"> /src</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">COPY</span> . .<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> dotnet build -c Release -o /app<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">FROM</span><span style="color:#e6db74"> build AS publish</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> dotnet publish -c Release -o /app<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">FROM</span><span style="color:#e6db74"> base AS final</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">WORKDIR</span><span style="color:#e6db74"> /app</span><span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">COPY</span> --from<span style="color:#f92672">=</span>publish /app .<span style="color:#960050;background-color:#1e0010">
</span></span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">ENTRYPOINT</span> [<span style="color:#e6db74">&#34;dotnet&#34;</span>, <span style="color:#e6db74">&#34;MyApp.dll&#34;</span>]<span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p>This will use the <code>Microsoft/aspnetcore-build:2.0</code> container image as the build container, publish the results and produce a packed container based on the <code>Microsoft/dotnet:2.0-runtime</code> container image. We are also setting the container with an entry point to start the application process as the main container process. This means that if/when the process stops, the container terminates.</p>
<p>We run the build command, asking it to tag the created image as <code>myapptestcontainer:latest</code> so we can refer to it again in a moment.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>docker build -t myapptestcontainer<span style="color:#960050;background-color:#1e0010">:</span>latest .
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>Sending build context to Docker daemon  136.7kB
</span></span><span style="display:flex;"><span>Step 1/13 : FROM microsoft/dotnet:2.0-runtime AS base
</span></span><span style="display:flex;"><span> ---&gt; 26314e3adaec
</span></span><span style="display:flex;"><span>Step 2/13 : WORKDIR /app
</span></span><span style="display:flex;"><span>Removing intermediate container 9296d10905ce
</span></span><span style="display:flex;"><span> ---&gt; 8794c7aca866
</span></span><span style="display:flex;"><span>Step 3/13 : EXPOSE <span style="color:#ae81ff">80</span>
</span></span><span style="display:flex;"><span> ---&gt; Running in 6554f663146f
</span></span><span style="display:flex;"><span>Removing intermediate container 6554f663146f
</span></span><span style="display:flex;"><span> ---&gt; ad881b2a405e
</span></span><span style="display:flex;"><span>Step 4/13 : FROM microsoft/aspnetcore-build:2.0 AS build
</span></span><span style="display:flex;"><span> ---&gt; 244f6193d21a
</span></span><span style="display:flex;"><span>Step 5/13 : WORKDIR /src
</span></span><span style="display:flex;"><span>Removing intermediate container a38fb58535b6
</span></span><span style="display:flex;"><span> ---&gt; 5ed2a92fda93
</span></span><span style="display:flex;"><span>Step 6/13 : COPY . .
</span></span><span style="display:flex;"><span> ---&gt; 8ffd3faa7bc9
</span></span><span style="display:flex;"><span>Step 7/13 : RUN dotnet build -c Release -o /app
</span></span><span style="display:flex;"><span> ---&gt; Running in 39d44616ea2d
</span></span><span style="display:flex;"><span>Microsoft <span style="color:#f92672">(</span>R<span style="color:#f92672">)</span> Build Engine version 15.6.82.30579 <span style="color:#66d9ef">for</span> .NET Core
</span></span><span style="display:flex;"><span>Copyright <span style="color:#f92672">(</span>C<span style="color:#f92672">)</span> Microsoft Corporation. All rights reserved.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  Restoring packages <span style="color:#66d9ef">for</span> /src/MyApp.csproj...
</span></span><span style="display:flex;"><span>  Installing System.ServiceProcess.ServiceController 4.4.0.
</span></span><span style="display:flex;"><span>  Installing PeterKottas.DotNetCore.CmdArgParser 1.0.5.
</span></span><span style="display:flex;"><span>  Installing DasMulli.Win32.ServiceUtils 1.0.1.
</span></span><span style="display:flex;"><span>  Installing PeterKottas.DotNetCore.WindowsService 2.0.6.
</span></span><span style="display:flex;"><span>  Generating MSBuild file /src/obj/MyApp.csproj.nuget.g.props.
</span></span><span style="display:flex;"><span>  Restore completed in 2.72 sec <span style="color:#66d9ef">for</span> /src/MyApp.csproj.
</span></span><span style="display:flex;"><span>  MyApp -&gt; /app/MyApp.dll
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Build succeeded.
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">0</span> Warning<span style="color:#f92672">(</span>s<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">0</span> Error<span style="color:#f92672">(</span>s<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Time Elapsed 00:00:06.14
</span></span><span style="display:flex;"><span>Removing intermediate container 39d44616ea2d
</span></span><span style="display:flex;"><span> ---&gt; 56b58883d64b
</span></span><span style="display:flex;"><span>Step 8/13 : FROM build AS publish
</span></span><span style="display:flex;"><span> ---&gt; 56b58883d64b
</span></span><span style="display:flex;"><span>Step 9/13 : RUN dotnet publish -c Release -o /app
</span></span><span style="display:flex;"><span> ---&gt; Running in 552eb703a748
</span></span><span style="display:flex;"><span>Microsoft <span style="color:#f92672">(</span>R<span style="color:#f92672">)</span> Build Engine version 15.6.82.30579 <span style="color:#66d9ef">for</span> .NET Core
</span></span><span style="display:flex;"><span>Copyright <span style="color:#f92672">(</span>C<span style="color:#f92672">)</span> Microsoft Corporation. All rights reserved.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  Restore completed in 131.4 ms <span style="color:#66d9ef">for</span> /src/MyApp.csproj.
</span></span><span style="display:flex;"><span>  MyApp -&gt; /src/bin/Release/netcoreapp2.0/MyApp.dll
</span></span><span style="display:flex;"><span>  MyApp -&gt; /app/
</span></span><span style="display:flex;"><span>Removing intermediate container 552eb703a748
</span></span><span style="display:flex;"><span> ---&gt; 474498c42be3
</span></span><span style="display:flex;"><span>Step 10/13 : FROM base AS final
</span></span><span style="display:flex;"><span> ---&gt; ad881b2a405e
</span></span><span style="display:flex;"><span>Step 11/13 : WORKDIR /app
</span></span><span style="display:flex;"><span>Removing intermediate container c3c0dd6ac31c
</span></span><span style="display:flex;"><span> ---&gt; 02c236862201
</span></span><span style="display:flex;"><span>Step 12/13 : COPY --from<span style="color:#f92672">=</span>publish /app .
</span></span><span style="display:flex;"><span> ---&gt; 33509849efe0
</span></span><span style="display:flex;"><span>Step 13/13 : ENTRYPOINT <span style="color:#f92672">[</span><span style="color:#e6db74">&#34;dotnet&#34;</span>, <span style="color:#e6db74">&#34;MyApp.dll&#34;</span><span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span> ---&gt; Running in 25b373135eb6
</span></span><span style="display:flex;"><span>Removing intermediate container 25b373135eb6
</span></span><span style="display:flex;"><span> ---&gt; 511aa92712d1
</span></span><span style="display:flex;"><span>Successfully built 511aa92712d1
</span></span><span style="display:flex;"><span>Successfully tagged myapptestcontainer:latest
</span></span></code></pre></div><p>Now that we have a successful image for our app, we can start and run instances of it on docker, as well. We do this using the <code>docker run</code> command.</p>
<p>As before, we can run this interactively using the -it command:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-powershell" data-lang="powershell"><span style="display:flex;"><span>docker run --rm -it myapptestcontainer<span style="color:#960050;background-color:#1e0010">:</span>latest
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>Starting up as a console service host
</span></span><span style="display:flex;"><span>Service MyApp.MyApp started
</span></span><span style="display:flex;"><span>The MyAppService service is now running, press Control+C to exit.
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">8</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">13</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">21</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">34</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">55</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">89</span>
</span></span><span style="display:flex;"><span>^CControl+C detected, attempting to stop service.
</span></span><span style="display:flex;"><span>Service MyApp.MyApp stopped
</span></span><span style="display:flex;"><span>The MyAppService service has stopped.
</span></span></code></pre></div><p>And Control+C still works as expected. The real proof is launching it and checking the processes. We will:</p>
<ul>
<li>Run an instance from our image, detached (<code>docker run -d myapptestcontainer:latest</code>)</li>
<li>See that it is running using list process (<code>docker ps</code>)</li>
<li>Stop the process (<code>docker stop &lt;pid&gt;</code>)</li>
<li>Print the logs (<code>docker logs &lt;pid&gt;</code>)</li>
<li>Clean up the process (<code>docker rm &lt;pid&gt;</code>)</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>&gt; docker run -d myapptestcontainer:latest
</span></span><span style="display:flex;"><span>5a11b3ee222d35196f7d7549d634cd8b8c9220bfb4f9dd9f7fd577b094b2bccb
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>&gt; docker ps
</span></span><span style="display:flex;"><span>CONTAINER ID        IMAGE                       COMMAND              CREATED             STATUS              PORTS               NAMES
</span></span><span style="display:flex;"><span>5a11b3ee222d        myapptestcontainer:latest   <span style="color:#e6db74">&#34;dotnet MyApp.dll&#34;</span>   <span style="color:#ae81ff">2</span> seconds ago       Up <span style="color:#ae81ff">1</span> second         80/tcp              musing_montalcini
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>&gt; docker stop 5a11b
</span></span><span style="display:flex;"><span>5a11b
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>&gt; docker logs 5a11b
</span></span><span style="display:flex;"><span>Starting up as a console service host
</span></span><span style="display:flex;"><span>Service MyApp.MyApp started
</span></span><span style="display:flex;"><span>The MyAppService service is now running, press Control+C to exit.
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>&gt; docker rm 5a11b
</span></span><span style="display:flex;"><span>5a11b
</span></span></code></pre></div><p>As we can see, the only difference is the termination. Linux is sending the termination message correctly, but the library we are using doesn&rsquo;t subscribe to the correct callback (<code>AppDomain.CurrentDomain.ProcessExit</code> perhaps) and so instead the process is just terminated.</p>
<p>Now I started raising this as a bug against the library, but had to stop myself and ask &ldquo;Do I really need this?&rdquo;  There are a bunch of reasons and ways your container could get terminated. You need to build in resilience for this termination.  For that reason, you need to allow for you process to die in the middle of any part of your code and figure out ways to gracefully recover as needed. (Think about how SQL Server recovers after a termination to avoid data loss.) For this reason, I don&rsquo;t see the fact that <code>OnShutdown</code> doesn&rsquo;t get called as a bug, but instead an opportunity to write a better process.</p>
<p>Of course, if you absolutely want this behaviour, you could do something like <a href="https://github.com/PeterKottas/DotNetCore.WindowsService/issues/52#issuecomment-344853011">this stack overflow comment suggests</a> and connect the handler yourself, calling into the appropriate function. Like replacing the Service factory with the following:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-cs" data-lang="cs"><span style="display:flex;"><span>serviceConfig.ServiceFactory((extraArguments, serviceController) =&gt;
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> myApp = <span style="color:#66d9ef">new</span> MyApp();
</span></span><span style="display:flex;"><span>    EventHandler handler = <span style="color:#66d9ef">null</span>;
</span></span><span style="display:flex;"><span>    handler = (sender, _) =&gt;
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        AppDomain.CurrentDomain.ProcessExit -= handler;
</span></span><span style="display:flex;"><span>        Console.WriteLine(<span style="color:#e6db74">&#34;Process Exit triggered&#34;</span>, name);
</span></span><span style="display:flex;"><span>        myApp.Stop();
</span></span><span style="display:flex;"><span>    };
</span></span><span style="display:flex;"><span>    AppDomain.CurrentDomain.ProcessExit += handler;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> myApp;
</span></span><span style="display:flex;"><span>});
</span></span></code></pre></div><p>Just make sure if you do decide to use this, that your stop function is <a href="https://en.wikipedia.org/wiki/Idempotence">idempotent</a> and only runs once.</p>
<h3 id="the-end">The End</h3>
<p>I hope this article helps others coming to find out how to create cross-platform services with .Net Core. Also hopefully it redeems me for confusing so many people who landed on my <a href="/building-a-windows-service-with-net-core/">Building a Windows Service with .Net Core</a> article as well.</p>
<p>Simple. Easy. Works<a href="https://blog.codinghorror.com/the-works-on-my-machine-certification-program/">.</a></p>
</section>
        
        <section class="share">
            Share: 
            <a class="icon-twitter" href="https://twitter.com/share?text=A%20Windows%20Service%20using%20netcoreapp%20on%20dotnet&url=https%3a%2f%2fblog.csmac.nz%2fpost%2fa-windows-service-on-dotnet%2f"
                onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
                <span>Twitter</span>
            </a>
            |
            <a class="icon-facebook" href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fblog.csmac.nz%2fpost%2fa-windows-service-on-dotnet%2f"
                onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
                <span>Facebook</span>
            </a>
        </section>
    </div>
    <div class="content-box">
        
        <div id="disqus_thread"></div>
        <script type="text/javascript">
            var disqus_shortname = d_id; 
            var disqus_title = 'A Windows Service using netcoreapp on dotnet';
            
             
            (function() {
                var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
        <a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    
    </div>
</article>

<!--Page Content Ends-->

            </div><aside class="sidebar-area">

<!--Sidebar Content Begins-->

                <div class="header-bar-parent sidebar-item">
                    <div class="header-bar header-bar-mastodon">Mastodon</div>
                    
                    <div id="mt-container" class="mt-container">
                        <div class="mt-body" role="feed">
                            <div class="mt-loading-spinner"></div>
                        </div>
                    </div>
                    
                </div>


                <div class="header-bar-parent sidebar-item">
                    <div class="header-bar header-bar-rss">Subscribe</div>
                    
                    <a href="/rssfeeds/" title="csMACnz's Blog">RSS Feeds</a>
                    <a href="https://feedly.com/i/subscription/feed%2Fhttps%3A%2F%2Ffeeds.feedburner.com%2FcsmacnzBlog" target="_blank" title="csMACnz&amp;#039;s Blog"><img src="https://s3.feedly.com/feedburner/feedly.png" alt="" style="border:0"/></a>
                    <br />
                    <a href="https://www.patreon.com/csMACnz" target="_blank"><img src="/images/patreon.png" /></a>
                    
                    
                </div>


                <div class="header-bar-parent sidebar-item">
                    <div class="header-bar header-bar-xbox">Gamercard</div>
                    

                    <div>
                        <a href="https://www.exophase.com/xbox/user/csMACnz/"><img width="288px" src="https://card.exophase.com/1/1476805.png"></a>
                        <a href="http://steamcommunity.com/id/csMACnz/" target="_blank"><img src="https://www.steamsignature.com/status/english/76561197994712512.png" alt="" title="csMACnz's Steam Profile" /></a>
                    </div>
                    
                </div>

<!--Sidebar Content Ends-->

            </aside>

            <footer class="footer-area">

            <p>
                Designed and Maintained by Mark Clearwater; Last updated February 2024.
                <!-- This used to be something useful, now it is just a hack I left it to make layout easier but also as a fun reminder for me of what it used to be -->
                <br /><a class="footer-link" >¯\_(ツ)_/¯</a>
            </p>

            </footer>
        </div>

<!--body scripts Begins-->

        
        <script src="/js/highlight.pack.js"></script>
        <script>hljs.initHighlightingOnLoad();</script>

        <script src="/js/codetoggle.js"></script> 

        
        <script src="/js/htmx.min.js"></script>

        
        <script async src="https://www.googletagmanager.com/gtag/js?id=G-08VK9VD3ET"></script>
        <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-08VK9VD3ET');
        </script>

        <script src="/js/mastodon-timeline.min.js"></script>
        <script>
            const myTimeline = new MastodonTimeline({
                instanceUrl: "https://mastodon.nz",
                timelineType: "profile",
                userId: "109867048963758953",
                profileName: "@csMACnz",
                maxNbPostShow: 10,
                hideReblog: true,
            });

        </script>

        <script type="text/javascript" src="https://code.jquery.com/jquery-1.11.3.min.js"></script>

<!--body scripts Ends-->


<!-------------------------------->
<!--                            -->
<!--  _(\    |@@|               -->
<!-- (__/\__ \--/ __            -->
<!--    \___|----|  |   __      -->
<!--        \ }{ /\ )_ / _\     -->
<!--        /\__/\ \__O (__     -->
<!--       (--/\--)    \__/     -->
<!--       _)(  )(_             -->
<!--      `---''---`            -->
<!--                            -->
<!-- https://github.com/csMACnz -->
<!-------------------------------->

    </body>
</html>
